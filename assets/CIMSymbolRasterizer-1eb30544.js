import{kI as J,f_ as G,dz as j,kJ as B,g1 as V,aB as K,kK as Q,kL as M,fV as D,kM as Z,ax as $,bI as ee,kN as te,kO as Y}from"./index-70a1e848.js";import{d as ae,n as F,a as W,t as q,b as re,r as ie,l as se,e as ne,j as oe,V as ce,Q as le}from"./cimAnalyzer-eedeb732.js";import{r as he,e as me}from"./rasterizingUtils-92b6527e.js";import"./labelPoint-454a2ef5.js";import"./TileClipper-ae6eca9e.js";import"./definitions-24b8f578.js";import"./number-e491b09e.js";import"./BidiEngine-9a40f2f4.js";class ge{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(e,a){const n=this._resourceMap.get(e);if(n)return{width:n.width,height:n.height};let t=this._inFlightResourceMap.get(e);return t?t.then(r=>({width:r.width,height:r.height})):(t=J(e,a),this._inFlightResourceMap.set(e,t),t.then(r=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,r),{width:r.width,height:r.height}),()=>({width:0,height:0})))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return G(e)}}const ue=512;class fe{constructor(e){this._resourceManager=e,this._lazyRasterizationCanvas=null}dispose(){this._lazyRasterizationCanvas=null}get _rasterizationCanvas(){return this._lazyRasterizationCanvas==null&&(this._lazyRasterizationCanvas=document.createElement("canvas"),this._lazyRasterizationCanvas.getContext("2d",{willReadFrequently:!0})),this._lazyRasterizationCanvas}rasterizeJSONResource(e,a,n){if(e.type==="simple-fill"||e.type==="esriSFS"){const[i,h,p]=he(this._rasterizationCanvas,e.style,a);return{size:[h,p],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:j(Math.ceil(a))}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let i,h;if(e.type==="simple-line"||e.type==="esriSLS")switch(i=ae(e.style,e.cap),e.cap){case"butt":h="Butt";break;case"square":h="Square";break;default:h="Round"}else i=e.dashTemplate,h=e.cim.capStyle;const[p,f,d]=me(i,h);return{size:[f,d],image:new Uint32Array(p.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let t,r=null,o=null,s=1;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(t=F.fromSimpleMarker(e),o=W(t)):e.cim&&e.cim.type==="CIMHatchFill"?(t=F.fromCIMHatchFill(e.cim,a),r=new q(t.frame.xmin,-t.frame.ymax,t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin),s=a):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(t=F.fromCIMInsidePolygon(e.cim),r=new q(t.frame.xmin,-t.frame.ymax,t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin)):(t=e.cim,e.avoidSDFRasterization||(o=W(t))),o&&!n){const[i,h,p]=re(o);return i?{size:[h,p],image:new Uint32Array(i.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:s}:null}const[c,y,m,g,u]=F.rasterize(this._rasterizationCanvas,t,r,this._resourceManager,!n);return c?{size:[y,m],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:g,anchorY:u}:null}rasterizeImageResource(e,a,n,t){this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=a;const r=this._rasterizationCanvas.getContext("2d");n instanceof ImageData?r.putImageData(n,0,0):(n.setAttribute("width",`${e}px`),n.setAttribute("height",`${a}px`),r.drawImage(n,0,0,e,a));const o=r.getImageData(0,0,e,a),s=new Uint8Array(o.data);if(t){for(const i of t)if(i&&i.oldColor&&i.oldColor.length===4&&i.newColor&&i.newColor.length===4){const[h,p,f,d]=i.oldColor,[z,l,b,w]=i.newColor;if(h===z&&p===l&&f===b&&d===w)continue;for(let C=0;C<s.length;C+=4)h===s[C]&&p===s[C+1]&&f===s[C+2]&&d===s[C+3]&&(s[C]=z,s[C+1]=l,s[C+2]=b,s[C+3]=w)}}let c;for(let i=0;i<s.length;i+=4)c=s[i+3]/255,s[i]=s[i]*c,s[i+1]=s[i+1]*c,s[i+2]=s[i+2]*c;let y=s,m=e,g=a;const u=ue;if(m>=u||g>=u){const i=m/g;i>1?(m=u,g=Math.round(u/i)):(g=u,m=Math.round(u*i)),y=new Uint8Array(4*m*g);const h=new Uint8ClampedArray(y.buffer);B(s,e,a,h,m,g,!1)}return{size:[m,g],image:new Uint32Array(y.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}const T=x=>x?.scaleFactor?x.scaleFactor:1,de=96/72;class Ie{constructor(e,a){this._spatialReference=e,this._avoidSDF=a,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new ie,this._cimResourceManager=new ge,this._rasterizer=new fe(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??(this._lazyImageDataCanvas=document.createElement("canvas")),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,a,n,t,r,o,s,c,y){if(!e)return null;const{data:m}=e;if(!m||m.type!=="CIMSymbolReference"||!m.symbol)return null;const{symbol:g}=m;o||(o=V(g));const u=await se.resolveSymbolOverrides(m,a,this._spatialReference,r,o,s,c),i=this._imageDataCanvas,h=this._cimResourceManager,p=[];F.fetchResources(u,h,p),F.fetchFonts(u,h,p),p.length>0&&await Promise.all(p);const{width:f,height:d}=n,z=ye(o,f,d,t),l=F.getEnvelope(u,z,h);if(!l)return null;const b=(window.devicePixelRatio||1)*de;let w=1,C=0,I=0;switch(g.type){case"CIMPointSymbol":case"CIMTextSymbol":{let P=1;l.width>f&&(P=f/l.width);let _=1;l.height>d&&(_=d/l.height),t==="preview"&&(l.width<f&&(P=f/l.width),l.height<d&&(_=d/l.height)),w=Math.min(P,_),C=l.x+l.width/2,I=l.y+l.height/2}break;case"CIMLineSymbol":{(y||l.height>d)&&(w=d/l.height),I=l.y+l.height/2;const P=l.x*w+f/2,_=(l.x+l.width)*w+f/2,{paths:R}=z;R[0][0][0]-=P/w,R[0][2][0]-=(_-f)/w}break;case"CIMPolygonSymbol":{C=l.x+l.width/2,I=l.y+l.height/2;const P=l.x*w+f/2,_=(l.x+l.width)*w+f/2,R=l.y*w+d/2,X=(l.y+l.height)*w+d/2,{rings:v}=z;P<0&&(v[0][0][0]-=P,v[0][3][0]-=P,v[0][4][0]-=P),R<0&&(v[0][0][1]+=R,v[0][1][1]+=R,v[0][4][1]+=R),_>f&&(v[0][1][0]-=_-f,v[0][2][0]-=_-f),X>d&&(v[0][2][1]+=X-d,v[0][3][1]+=X-d)}}i.width=f*b,i.height=d*b;const k=1;i.width+=2*k,i.height+=2*k;const S=this._imageDataContext,A=le.createIdentity();return A.translate(-C,-I),A.scale(w*b,-w*b),A.translate(f*b/2+k,d*b/2+k),S.clearRect(0,0,i.width,i.height),new ne(S,h,A,!0).drawSymbol(u,z),S.getImageData(0,0,i.width,i.height)}async analyzeCIMSymbol3D(e,a,n,t,r){const o=[],s=a?{geometryType:t,spatialReference:this._spatialReference,fields:a}:null,c=[];F.fetchFonts(e.data.symbol,this._cimResourceManager,c),await Promise.all(c);const y=new oe(this._cimResourceManager,s);let m;await y.analyzeSymbolReference(e.data,this._avoidSDF,o),K(r);for(const g of o)g.cim.type!=="CIMPictureMarker"&&g.cim.type!=="CIMPictureFill"&&g.cim.type!=="CIMPictureStroke"||(m||(m=[]),m.push(this._fetchPictureMarkerResource(g,r))),n&&g.type==="text"&&typeof g.text=="string"&&g.text.includes("[")&&(g.text=Q(n,g.text,g.cim.textCase));return m&&await Promise.all(m),o}rasterizeCIMSymbol3D(e,a,n,t,r,o){const s=[];for(const c of e){t&&typeof t.scaleFactor=="function"&&(t.scaleFactor=t.scaleFactor(a,r,o));const y=this._getRasterizedResource(c,a,n,t,r,o);if(!y)continue;let m=0,g=y.anchorX||0,u=y.anchorY||0,i=!1,h=0,p=0;if(n==="esriGeometryPoint"){const f=T(t);if(h=M(c.offsetX,a,r,o)*f||0,p=M(c.offsetY,a,r,o)*f||0,c.type==="marker")m=M(c.rotation,a,r,o)||0,i=c.rotateClockwise??!1;else if(c.type==="text"){if(m=M(c.angle,a,r,o)||0,c.horizontalAlignment!==void 0)switch(c.horizontalAlignment){case"left":g=-.5;break;case"right":g=.5;break;default:g=0}if(c.verticalAlignment!==void 0)switch(c.verticalAlignment){case"top":u=.5;break;case"bottom":u=-.5;break;case"baseline":u=-.25;break;default:u=0}}}y!=null&&s.push({angle:m,rotateClockWise:i,anchorX:g,anchorY:u,offsetX:h,offsetY:p,rasterizedResource:y})}return this.getSymbolImage(s)}getSymbolImage(e){const a=document.createElement("canvas"),n=a.getContext("2d");let t=0,r=0,o=0,s=0;const c=[];for(let u=0;u<e.length;u++){const i=e[u],h=i.rasterizedResource;if(!h)continue;const p=h.size,f=i.offsetX,d=i.offsetY,z=i.anchorX,l=i.anchorY,b=i.rotateClockWise||!1;let w=i.angle,C=D(f)-p[0]*(.5+z),I=D(d)-p[1]*(.5+l),k=C+p[0],S=I+p[1];if(w){b&&(w=-w);const _=Math.sin(w*Math.PI/180),R=Math.cos(w*Math.PI/180),X=C*R-I*_,v=C*_+I*R,O=C*R-S*_,U=C*_+S*R,H=k*R-S*_,L=k*_+S*R,E=k*R-I*_,N=k*_+I*R;C=Math.min(X,O,H,E),I=Math.min(v,U,L,N),k=Math.max(X,O,H,E),S=Math.max(v,U,L,N)}t=C<t?C:t,r=I<r?I:r,o=k>o?k:o,s=S>s?S:s;const A=n.createImageData(h.size[0],h.size[1]);A.data.set(new Uint8ClampedArray(h.image.buffer));const P={offsetX:f,offsetY:d,rotateClockwise:b,angle:w,rasterizedImage:A,anchorX:z,anchorY:l};c.push(P)}a.width=o-t,a.height=s-r;const y=-t,m=s;for(let u=0;u<c.length;u++){const i=c[u],h=this._imageDataToCanvas(i.rasterizedImage),p=i.rasterizedImage.width,f=i.rasterizedImage.height,d=y-p*(.5+i.anchorX),z=m-f*(.5-i.anchorY);if(i.angle){const l=(360-i.angle)*Math.PI/180;n.save(),n.translate(D(i.offsetX),-D(i.offsetY)),n.translate(y,m),n.rotate(l),n.translate(-y,-m),n.drawImage(h,d,z),n.restore()}else n.drawImage(h,d+D(i.offsetX),z-D(i.offsetY))}const g=new Z({x:y/a.width-.5,y:m/a.height-.5});return{imageData:a.width!==0&&a.height!==0?n.getImageData(0,0,a.width,a.height):n.createImageData(1,1),anchorPosition:g}}async _fetchPictureMarkerResource(e,a){const n=e.materialHash;if(!this._pictureMarkerCache.get(n)){const t=(await $(e.cim.url,{responseType:"image",signal:a?.signal})).data;this._pictureMarkerCache.set(n,t)}}_imageDataToCanvas(e){const a=this._imageDataCanvas,n=this._imageDataContext;return a.width=e.width,a.height=e.height,n.putImageData(e,0,0),a}_imageTo32Array(e,a,n,t){const r=this._imageDataCanvas,o=this._imageDataContext;if(r.width=a,r.height=n,o.drawImage(e,0,0,a,n),t){o.save();const s=new ee(t);o.fillStyle=s.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,a,n),o.globalCompositeOperation="destination-atop",o.drawImage(e,0,0,a,n),o.restore()}return new Uint32Array(o.getImageData(0,0,a,n).data.buffer)}_getRasterizedResource(e,a,n,t,r,o){let s,c,y;if(e.type==="text")return this._rasterizeTextResource(e,a,t,r,o);({analyzedCIM:s,hash:c}=pe(e,a,r,o));const u=T(t);if(e.cim.type==="CIMPictureMarker"){const p=M(e.size,a,r,o)*u,{image:f,width:d,height:z}=this._getPictureResource(e,p,M(e.color,a,r,o));return y={image:f,size:[d,z],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},y}te(s,u,{preserveOutlineWidth:!1});const i=s;c+=n,t&&(c+=JSON.stringify(t));const h=this._resourceCache;return h.has(c)?h.get(c):(y=this._rasterizer.rasterizeJSONResource({cim:i,type:e.type,url:e.url,mosaicHash:c,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),h.set(c,y),y)}_rasterizeTextResource(e,a,n,t,r){const o=T(n),s=M(e.text,a,t,r);if(!s||s.length===0)return null;const c=e.cim,y=M(c?.fontFamilyName||e.fontName,a,t,r),m=M(c?.font?.style||e.style,a,t,r),g=M(c?.font?.weight||e.weight,a,t,r),u=M(c?.font?.decoration||e.decoration,a,t,r),i=M(e.size,a,t,r)*o,h=M(e.horizontalAlignment,a,t,r),p=M(e.verticalAlignment,a,t,r),f=Y(M(e.color,a,t,r)),d=Y(M(e.outlineColor,a,t,r)),z=M(e.outlineSize,a,t,r),l=e.backgroundColor!=null?Y(e.backgroundColor):null,b=e.borderLineColor!=null?Y(e.borderLineColor):null,w=e.borderLineWidth!=null?e.borderLineWidth:null,C={color:f,size:i,horizontalAlignment:h,verticalAlignment:p,font:{family:y,style:m,weight:g,decoration:u},halo:{size:z||0,color:d,style:m},backgroundColor:l,borderLine:b!=null&&w!=null?{color:b,size:w}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(s,C)}_getPictureResource(e,a,n){const t=this._pictureMarkerCache.get(e.materialHash);if(!t)return null;const r=t.height/t.width,o=a?r>1?D(a):D(a)/r:t.width,s=a?r>1?D(a)*r:D(a):t.height;return{image:this._imageTo32Array(t,o,s,n),width:o,height:s}}}function ye(x,e,a,n){const r=-e/2+1,o=e/2-1,s=a/2-1,c=-a/2+1;switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[r,0],[0,0],[o,0]]]};default:return n==="legend"?{rings:[[[r,s],[o,0],[o,c],[r,c],[r,s]]]}:{rings:[[[r,s],[o,s],[o,c],[r,c],[r,s]]]}}}function pe(x,e,a,n){let t,r;return typeof x.materialHash=="function"?(t=(0,x.materialHash)(e,a,n),r=ce(x.cim,x.materialOverrides)):(t=x.materialHash,r=x.cim),{analyzedCIM:r,hash:t}}export{Ie as CIMSymbolRasterizer};
