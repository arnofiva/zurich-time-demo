import{un as Ki,um as Mt,uH as Q,uI as ee,uJ as me,uK as Xe,bV as v,hZ as et,uL as gt,uM as Xt,uN as pe,nS as Ir,as as St,g$ as Pr,uO as K,bi as wt,bY as Gi,uP as $r,uQ as Bt,eJ as Cr,iD as He,ki as Ft,uR as L,gb as Er,ax as ke,bl as Ae,aQ as Ye,bO as Wr,dO as Vr,uu as kr,uS as Ar,ah as Rr,ak as Br,ay as Lt,bd as Fr,ia as Or}from"./index-8b5e7d9b.js";import{c as Dr,i as Zi,g as Kr,f as Gr,s as Zr,h as Ni,k as Ui,m as ye,o as Nr,p as Ur,q as Xr,V as Hr,j as Yr}from"./cimAnalyzer-96adb123.js";import{a as qr,s as qe}from"./diffUtils-3ed1f592.js";import{f as jr,R as xe,k as Qr,G as Jr,p as Xi}from"./Pipeline-71977f9f.js";import{E as S,S as A,L as G,A as Ot}from"./enums-9d4f5c11.js";import{d as ge,f as ts,c as ut,w as es,b as Hi,m as E,q as is,g as k,h as rs,n as Yi,l as qi,p as it,i as ss,x as ji,j as Qi,$ as ns,k as as,o as Ji,s as ie,u as tr,v as er,y as tt,z as W,A as Ht,B as Yt}from"./definitions-5359da6f.js";import{o as os,p as hs}from"./tileUtils-7ee960ba.js";import{r as ls,c as cs,i as je}from"./TurboLine-f24b8fe3.js";import{x as P,w as M}from"./number-e491b09e.js";import{a as re}from"./labelPoint-fc5dd920.js";import{t as us}from"./Rect-98da58d6.js";import{r as Qe,s as Je,y as ti}from"./defaultsJSON-59981e75.js";import{c as ve}from"./GeometryUtils-0258f920.js";import{e as ir,t as rr}from"./TileClipper-ae6eca9e.js";function $(s){if(!s)return 0;const{r:t,g:e,b:i,a:r}=s;return P(t*r,e*r,i*r,255*r)}function O(s){if(!s)return 0;const[t,e,i,r]=s;return P(t*(r/255),e*(r/255),i*(r/255),r)}let zt=class Me{constructor(t,e,i,r){this.center=Ki(t,e),this.centerT=Mt(),this.halfWidth=i/2,this.halfHeight=r/2,this.width=i,this.height=r}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new Me(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,e=4){const i=Math.abs(t.centerT[0]-this.centerT[0]),r=Math.abs(t.centerT[1]-this.centerT[1]),n=(t.halfWidth+this.halfWidth+e)/i,a=(t.halfHeight+this.halfHeight+e)/r,o=Math.min(n,a);return Math.log2(o)}extend(t){const e=Math.min(this.xmin,t.xmin),i=Math.min(this.ymin,t.ymin),r=Math.max(this.xmax,t.xmax)-e,n=Math.max(this.ymax,t.ymax)-i,a=e+r/2,o=i+n/2;this.width=r,this.height=n,this.halfWidth=r/2,this.halfHeight=n/2,this.x=a,this.y=o}static deserialize(t){const e=t.readF32(),i=t.readF32(),r=t.readInt32(),n=t.readInt32();return new Me(e,i,r,n)}};const Re=26,sr=4,ds=Re+sr,fs=Re-6,ei=3,V=8,_s=Math.PI/180,ms=8,ii=1.5;let nr=class{constructor(t,e,i,r){this._rotationT=Q(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const n=i.rect,a=new Float32Array(8);t*=r,e*=r;const o=i.code?n.width*r:i.metrics.width,h=i.code?n.height*r:i.metrics.height;this.width=o,this.height=h,a[0]=t,a[1]=e,a[2]=t+o,a[3]=e,a[4]=t,a[5]=e+h,a[6]=t+o,a[7]=e+h,this._data=a,this._setTextureCoords(n),this._scale=r,this._mosaic=i,this.x=t,this.y=e,this.maxOffset=Math.max(t+o,e+h)}get mosaic(){return this._mosaic}set angle(t){this._angle=t,ee(this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,i=e*this._scale,r=Math.abs(t)*this._scale,n=new Float32Array(8);n[0]=this.x,n[1]=this.y,n[2]=this.x+i,n[3]=this.y,n[4]=this.x,n[5]=this.y+r,n[6]=this.x+i,n[7]=this.y+r;const a=me(Q(),this._rotationT,this._transform);Xe(n,n,a);let o=1/0,h=1/0,l=0,c=0;for(let _=0;_<4;_++){const p=n[2*_],y=n[2*_+1];o=Math.min(o,p),h=Math.min(h,y),l=Math.max(l,p),c=Math.max(c,y)}const u=l-o,f=c-h,d=o+u/2,m=h+f/2;this._bounds=new zt(d,m,u,f)}return this._bounds}setTransform(t){this._transform=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,i=new Float32Array(8),r=me(Q(),this._rotationT,this._transform);Xe(i,t,r),e.upperLeft=M(i[0]*V,i[1]*V),e.upperRight=M(i[2]*V,i[3]*V),e.lowerLeft=M(i[4]*V,i[5]*V),e.lowerRight=M(i[6]*V,i[7]*V)}_setTextureCoords({x:t,y:e,width:i,height:r}){this._texcoords={upperLeft:M(t,e),upperRight:M(t+i,e),lowerLeft:M(t,e+r),lowerRight:M(t+i,e+r)}}};const ps=(s,t)=>({code:0,page:0,sdf:!0,rect:new us(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:s,left:0,top:0}});function Tt(s,t){return s.forEach(e=>gt(e,e,t)),{upperLeft:M(V*s[0][0],V*s[0][1]),upperRight:M(V*s[1][0],V*s[1][1]),lowerLeft:M(V*s[2][0],V*s[2][1]),lowerRight:M(V*s[3][0],V*s[3][1])}}let ys=class{constructor(t,e,i){this._rotation=0,this._decorate(t,e,i),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=i.angle!==0,this._transform=this._createGlyphTransform(this.bounds,i),this._borderLineSize=i.borderLineSize,(i.borderLineSize||i.hasBackground)&&([this.bounds,this.background]=this.shapeBackground(this._transform));for(const r of t)r.setTransform(this._transform)}setRotation(t){if(t===0&&this._rotation===0)return;this._rotation=t;const e=this._transform,i=ee(Q(),t);me(e,i,e);for(const r of this.glyphs)r.setTransform(this._transform)}_decorate(t,e,i){if(!i.decoration||i.decoration==="none"||!t.length)return;const r=i.scale,n=i.decoration==="underline"?ds:fs,a=t[0].textureBinding;for(const o of e){const h=o.startX*r,l=o.startY*r,c=(o.width+o.glyphWidthEnd)*r;t.push(new nr(h,l+n*r,ps(c,a),1))}}shapeBackground(t){const e=ms,{xmin:i,ymin:r,xmax:n,ymax:a,x:o,y:h,width:l,height:c}=this.bounds,u=Math.min(l,c)+2*e-ii,f=Math.min(v(this._borderLineSize||0),u),d=(ii+f)/2,m=this._borderLineSize?d:0,_=[i-e,r-e],p=[n+e,r-e],y=[i-e,a+e],x=[n+e,a+e],g=Tt([[_[0]-d,_[1]-d],[p[0]+d,p[1]-d],[_[0]+m,_[1]+m],[p[0]-m,p[1]+m]],t),b=Tt([[y[0]+m,y[1]-m],[x[0]-m,x[1]-m],[y[0]-d,y[1]+d],[x[0]+d,x[1]+d]],t),w=Tt([[_[0]-d,_[1]-d],[_[0]+m,_[1]+m],[y[0]-d,y[1]+d],[y[0]+m,y[1]-m]],t),T=Tt([[p[0]-m,p[1]+m],[p[0]+d,p[1]-d],[x[0]-m,x[1]-m],[x[0]+d,x[1]+d]],t),z={main:Tt([_,p,y,x],t),top:g,bot:b,left:w,right:T};return[new zt(o,h,l+2*d,c+2*d),z]}get boundsT(){const t=this.bounds,e=et(Mt(),t.x,t.y);if(gt(e,e,this._transform),this._hasRotation){const i=Math.max(t.width,t.height);return new zt(e[0],e[1],i,i)}return new zt(e[0],e[1],t.width,t.height)}_createBounds(t){let e=1/0,i=1/0,r=0,n=0;for(const h of t)e=Math.min(e,h.xTopLeft),i=Math.min(i,h.yTopLeft),r=Math.max(r,h.xBottomRight),n=Math.max(n,h.yBottomRight);const a=r-e,o=n-i;return new zt(e+a/2,i+o/2,a,o)}_createGlyphTransform(t,e){const i=_s*e.angle,r=Q(),n=Mt();return Xt(r,r,et(n,e.xOffset,-e.yOffset)),e.isCIM?pe(r,r,i):(Xt(r,r,et(n,t.x,t.y)),pe(r,r,i),Xt(r,r,et(n,-t.x,-t.y))),r}},Dt=class{constructor(t,e,i,r,n,a){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,i)),this.end=Math.max(0,Math.max(e,i)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=r,this.yMin=n,this.yMax=a}};const be=s=>s===10,ri=s=>s===32;function xs(s,t,e){const i=new Array,r=1/e.scale,n=e.maxLineWidth*r,a=t?s.length-1:0,o=t?-1:s.length,h=t?-1:1;let l=a,c=0,u=0,f=l,d=f,m=0,_=1/0,p=0;for(;l!==o;){const{code:x,metrics:g}=s[l],b=Math.abs(g.top);if(be(x)||ri(x)||(_=Math.min(_,b),p=Math.max(p,b+g.height)),be(x))l!==a&&(i.push(new Dt(s,f,l-h,c,_,p)),_=1/0,p=0),c=0,f=l+h,d=l+h,u=0;else if(ri(x))d=l+h,u=0,m=g.advance,c+=g.advance;else if(c>n){if(d!==f){const w=d-2*h;c-=m,i.push(new Dt(s,f,w,c-u,_,p)),_=1/0,p=0,f=d,c=u}else i.push(new Dt(s,f,l-h,c,_,p)),_=1/0,p=0,f=l,d=l,c=0;c+=g.advance,u+=g.advance}else c+=g.advance,u+=g.advance;l+=h}const y=new Dt(s,f,l-h,c,_,p);return y.start>=0&&y.end<s.length&&i.push(y),i}function gs(s,t){let e=0;for(let n=0;n<s.length;n++){const{width:a}=s[n];e=Math.max(a,e)}const i=t.decoration==="underline"?sr:0,r=s[0].yMin;return{x:0,y:r,height:s[s.length-1].yMax+t.lineHeight*(s.length-1)+i-r,width:e}}function vs(s,t,e){const i=e.scale,r=new Array,n=xs(s,t,e),a=gs(n,e),{vAlign:o,hAlign:h}=e,l=o===Dr.Baseline?1:0,c=l?0:o-1,u=(1-l)*-a.y+c*(a.height/2)+(l?1:0)*-Re;for(let f=0;f<n.length;f++){const{start:d,end:m,width:_}=n[f];let p=-1*(h+1)*(_/2)-ei;const y=f*e.lineHeight+u-ei;n[f].startX=p,n[f].startY=y;for(let x=d;x<=m;x++){const g=s[x];if(be(g.code))continue;const b=new nr(p+g.metrics.left,y-g.metrics.top,g,i);p+=g.metrics.advance,r.push(b)}}return new ys(r,n,e)}const yt=new Map;function Ms(s,t,e){const{indicesPerRecord:i,multiplier:r,verticesPerRecord:n}=yt.get(s);return{recordBytes:e*ge*Uint32Array.BYTES_PER_ELEMENT,indexBytes:r*i*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:r*n*e*t}}yt.set(S.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),yt.set(S.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),yt.set(S.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),yt.set(S.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),yt.set(S.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});const bs=1.25;let Kt=class{get length(){return this._pos}constructor(t,e){this._pos=0;const i=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}_roundToNearest(t,e){const i=Math.round(t);return e===1?i:i+(e-i%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*bs,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(e),r=new this._ctor(i);r.set(this._buffer,0),this._array=i,this._buffer=r,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,i){this._i16View[2*t]+=e,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,i){this._ensureSize(i-e);for(let r=e;r!==i;r++)this.writeFixed(t._buffer[r])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){return[...this._buffer]}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}},si=class{constructor(t,e,i){this._start={index:0,vertex:0};const r=Ms(t,e,i),n=e/4;this.geometryType=t,this._records=new Kt(Int32Array,r.recordBytes),this._indices=new Kt(Uint32Array,r.indexBytes),this._vertices=new Kt(Uint32Array,r.vertexBytes),this._metrics=new Kt(Float32Array,0),this._strideInt=n}serialize(t){const e=this._records.buffer(),i=this._indices.buffer(),r=this._vertices.buffer(),n=this._metrics.length?this._metrics.buffer():null,a=4*this._strideInt;return t.push(e,i,r),{stride:a,records:e,indices:i,vertices:r,metrics:n}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/ge}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,i,r,n,a,o,h){this._records.push(t),this._records.push(e??0),this._records.push(i),this._records.push(r),this._records.push(n),this._records.push(a),this._records.push(o),this._records.writeF32(h)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,i){const r=t._records.length-ge,n=t._records.getValue(r),a=t._records.getValue(r+1),o=t._records.getValue(r+2),h=t._records.getValue(r+4),l=t._records.getValue(r+6),c=t._records.getValue(r+7),u=this._vertices.length,f=(t._start.vertex-this._vertices.length)/this._strideInt,d=this._indices.length,m=this.vertexCount;for(let _=t._start.index;_!==t._indices.length;_++){const p=t._indices.getValue(_);this._indices.push(p-f)}for(let _=t._start.vertex;_!==t._vertices.length;_++){const p=t._vertices.getValue(_);this._vertices.push(p)}for(let _=u;_<=this._vertices.length;_+=this._strideInt)this._vertices.i1616Add(_,e,i);this._records.push(n),this._records.push(a),this._records.push(o),this._records.push(d),this._records.push(h),this._records.push(m),this._records.push(l),this._records.push(c)}};const se=1,Be=2,ne=4,Fe=8,Oe=16,ae=32,De=64,oe=128;function ni(s){switch(s){case se:case Fe:case ae:return-1;case Be:case De:return 0;case ne:case Oe:case oe:return 1}}function ai(s){switch(s){case se:case Be:case ne:return-1;case Fe:case Oe:return 0;case ae:case De:case oe:return 1}}const oi=se|Fe|ae,hi=ne|Oe|oe,li=se|Be|ne,ci=ae|De|oe;let Ss=class{constructor(t,e,i,r,n,a=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=r,this._pixelBufferEnabled=n,this._version=a,this._symbologyType=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((i,r)=>{const n=1<<r,a=ni(n),o=ai(n),h=os(new Ir(this.tileKey),a,o,t),l=this._serializeTileVertexData(this.tileKey,h.id,i.vertexData);l.message.bufferIds=i.displayIds,e.push(l)}),e}_serializeTileVertexData(t,e,i){const r=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[S.MARKER]:i.get(S.MARKER)?.serialize(r),[S.FILL]:i.get(S.FILL)?.serialize(r),[S.LINE]:i.get(S.LINE)?.serialize(r),[S.TEXT]:i.get(S.TEXT)?.serialize(r),[S.LABEL]:i.get(S.LABEL)?.serialize(r)},version:this._version},transferList:r}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,i,r){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=r,this._current.id=t,this._current.materialKey=e,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,i,r){this._current.bufferingEnabled&&this._addOverlap(t,e,i,r)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,i,r,n,a,o,h){this._current.writer=this._getVertexWriter(S.LABEL);const l=this._current.writer.metricWriter;l.push(jr(t)),l.push(e),l.push(i),l.push(r),l.push(n),l.push(a),l.push(o),l.push(h),l.push(255),this._current.metricBoxLenPointer=l.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,i,r){const n=this._current.writer.metricWriter;n.incr(this._current.metricBoxLenPointer),n.push(0),n.push(0),n.push(t),n.push(e),n.push(i),n.push(r)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const i=this._current.indexStart,r=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,r,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===S.LABEL)return!0;const n=this._current.writer;for(let a=0;a<8;a++){const o=1<<a;if(this._current.overlaps&o){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const h=this._data.neighbors[a],l=this._current.geometryType;if(!h.vertexData.has(l)){const m=xe(l,this._symbologyType).geometry,_=new si(l,m,ts);h.vertexData.set(l,_)}const c=h.vertexData.get(this._current.geometryType),u=8,f=512*-ni(o)*u,d=512*-ai(o)*u;c?.copyLastFrom(n,f,d),h.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,i,r){const n=255^((t<0+i?hi:t>=ut-i?oi:hi|oi)|(e<0+r?ci:e>=ut-r?li:ci|li));this._current.overlaps|=n}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,i=xe(t,this._symbologyType).geometry;e.set(t,new si(t,i,this.hint.records))}return this._data.self.get(t)}};function ws(s,t,e){const i=G.SIZE_FIELD_STOPS|G.SIZE_MINMAX_VALUE|G.SIZE_SCALE_STOPS|G.SIZE_UNIT_VALUE,r=(t&(Ot.FIELD_TARGETS_OUTLINE|Ot.MINMAX_TARGETS_OUTLINE|Ot.SCALE_TARGETS_OUTLINE|Ot.UNIT_TARGETS_OUTLINE))>>>4;return s===S.LINE&&e.isOutline||s===S.FILL&&ar(e.symbologyType)?i&r:i&~r}const ui=0,di=8,Ls=7,fi=8,_i=11,mi=11,pi=12,yi=13,xi=14,gi=15,vi=16,Mi=17,bi=18,Si=19,wi=20,Li=21,Ti=26,Ts=Object.keys(A).filter(s=>typeof A[s]=="number").reduce((s,t)=>({...s,[t]:A[t]}),{});function zs(s){return s===A.SIMPLE||s===A.OUTLINE_FILL_SIMPLE}function ar(s){return s===A.OUTLINE_FILL||s===A.OUTLINE_FILL_SIMPLE}function or(s){return zs(s.symbologyType)}function qt(s){return ar(s.symbologyType)}function he(s,t){switch(s){case S.FILL:return H.from(t);case S.LINE:return rt.from(t);case S.MARKER:return dt.from(t);case S.TEXT:return Ct.from(t);case S.LABEL:return ct.from(t);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${s}`)}}function ca(s){switch(Z.load(s).geometryType){case S.MARKER:return new dt(s);case S.FILL:return new H(s);case S.LINE:return new rt(s);case S.TEXT:return new Ct(s);case S.LABEL:return new ct(s)}}class Z{static load(t){const e=this.shared;return e.data=t,e}constructor(t){this._data=0,this._data=t}set data(t){this._data=t??0}get data(){return this._data}get geometryType(){return this.bits(fi,_i)}set geometryType(t){this.setBits(t,fi,_i)}get mapAligned(){return!!this.bit(wi)}set mapAligned(t){this.setBit(wi,t)}get sdf(){return!!this.bit(mi)}set sdf(t){this.setBit(mi,t??!1)}get pattern(){return!!this.bit(pi)}set pattern(t){this.setBit(pi,t)}get textureBinding(){return this.bits(ui,di)}set textureBinding(t){this.setBits(t,ui,di)}get symbologyType(){return this.bits(Li,Ti)}set symbologyType(t){this.setBits(t,Li,Ti)}get geometryTypeString(){switch(this.geometryType){case S.FILL:return"fill";case S.MARKER:return"marker";case S.LINE:return"line";case S.TEXT:return"text";case S.LABEL:return"label";default:throw new St(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(t,e){const i=1<<t;e?this._data|=i:this._data&=~i}bit(t){return(this._data&1<<t)>>t}setBits(t,e,i){for(let r=e,n=0;r<i;r++,n++)this.setBit(r,(t&1<<n)!=0)}bits(t,e){let i=0;for(let r=t,n=0;r<e;r++,n++)i|=this.bit(r)<<n;return i}hasVV(){return!1}setVV(t,e){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf,symbologyType:{value:A[this.symbologyType],options:Ts,namespace:"SYMBOLOGY_TYPE"}}}getVariationHash(){return this._data&~(Ls&this.textureBinding)}}Z.shared=new Z(0);const At=s=>class extends s{get vvSizeMinMaxValue(){return this.bit(vi)!==0}set vvSizeMinMaxValue(t){this.setBit(vi,t)}get vvSizeScaleStops(){return this.bit(Mi)!==0}set vvSizeScaleStops(t){this.setBit(Mi,t)}get vvSizeFieldStops(){return this.bit(bi)!==0}set vvSizeFieldStops(t){this.setBit(bi,t)}get vvSizeUnitValue(){return this.bit(Si)!==0}set vvSizeUnitValue(t){this.setBit(Si,t)}hasSizeVV(){return this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}hasVV(){return super.hasVV()||this.hasSizeVV()}setVV(t,e){super.setVV(t,e);const i=ws(this.geometryType,t,e)&t;this.vvSizeMinMaxValue=!!(i&G.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(i&G.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(i&G.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(i&G.SIZE_SCALE_STOPS)}},hr=s=>class extends s{get vvRotation(){return this.bit(gi)!==0}set vvRotation(t){this.setBit(gi,t)}hasVV(){return super.hasVV()||this.vvRotation}setVV(t,e){super.setVV(t,e),this.vvRotation=!e.isOutline&&!!(t&G.ROTATION)}},le=s=>class extends s{get vvColor(){return this.bit(yi)!==0}set vvColor(t){this.setBit(yi,t)}hasVV(){return super.hasVV()||this.vvColor}setVV(t,e){super.setVV(t,e),this.vvColor=!e.isOutline&&!!(t&G.COLOR)}},ce=s=>class extends s{get vvOpacity(){return this.bit(xi)!==0}set vvOpacity(t){this.setBit(xi,t)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(t,e){super.setVV(t,e),this.vvOpacity=!e.isOutline&&!!(t&G.OPACITY)}};let H=class extends le(ce(At(Z))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:i}=t,r=this.load(0);return r.geometryType=S.FILL,r.symbologyType=e,e!==A.DOT_DENSITY&&r.setVV(i,t),r.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};H.shared=new H(0);class dt extends le(ce(hr(At(Z)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:i}=t,r=this.load(0);return r.geometryType=S.MARKER,r.symbologyType=e,e!==A.HEATMAP&&r.setVV(i,t),r.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}dt.shared=new dt(0);let rt=class extends le(ce(At(Z))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=S.LINE,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};rt.shared=new rt(0);let Ct=class extends le(ce(hr(At(Z)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=S.TEXT,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};Ct.shared=new Ct(0);let ct=class extends At(Z){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=S.LABEL,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.mapAligned=Zi(t.placement),e.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}};ct.shared=new ct(0);const N=0,U=100;function zi(s,t,e){return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s}function lr(s,t){return Math.sqrt(s*s+t*t)}function Ii(s){const t=lr(s[0],s[1]);s[0]/=t,s[1]/=t}function Is(s,t){return lr(s[0]-t[0],s[1]-t[1])}function Se(s=2){return 1/Math.max(s,1)}function at(s,t){return[!!s?.minScale&&t.scaleToZoom(s.minScale)||N,!!s?.maxScale&&t.scaleToZoom(s.maxScale)||U]}function Ps(s,t){return s[t+1]}function cr(s){return s.length-1}function $s(s){let t=0;for(let e=0;e<cr(s);e++)t+=Cs(s,e);return t}function Cs(s,t,e=1){const[i,r]=Ps(s,t);return Math.sqrt(i*i+r*r)*e}let Es=class we{constructor(t,e,i,r,n){this._segments=t,this._index=e,this._distance=i,this._xStart=r,this._yStart=n,this._done=!1}static create(t){return new we(t,0,0,t[0][0],t[0][1])}clone(){return new we(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<cr(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let r=this.backwardLength;for(;this.prev();){if(r+this.length>t)return this._seekBackwards(t-r);r+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}};function Ws(s,t,e,i=!0){const r=$s(s),n=Es.create(s),a=r/2;if(!i)return n.seek(a),void e(n.clone(),0,a+0*t,r);const o=Math.max((r-t)/2,0),h=Math.floor(o/t),l=a-h*t;n.seek(l);for(let c=-h;c<=h;c++)n.x<512&&n.x>=0&&n.y<512&&n.y>=0&&e(n.clone(),c,a+c*t,r),n.seek(t)}function Vs(s,t){const e=t;for(let i=0;i<s.length;i++){let r=s[i];ks(r,e);const n=[];n.push(r[0]);for(let a=1;a<r.length;a++){const[o,h]=r[a-1],[l,c]=r[a],u=Math.round(l-o),f=Math.round(c-h);n.push([u,f])}s[i]=n,r=n}return s}function ks(s,t){if(t<=0)return;const i=s.length;if(i<3)return;const r=[];let n=0;r.push(0);for(let u=1;u<i;u++)n+=Is(s[u],s[u-1]),r.push(n);t=Math.min(t,.2*n);const a=[];a.push(s[0][0]),a.push(s[0][1]);const o=s[i-1][0],h=s[i-1][1],l=zi([0,0],s[0],s[1]);Ii(l),s[0][0]+=t*l[0],s[0][1]+=t*l[1],zi(l,s[i-1],s[i-2]),Ii(l),s[i-1][0]+=t*l[0],s[i-1][1]+=t*l[1];for(let u=1;u<i;u++)r[u]+=t;r[i-1]+=t;const c=.5*t;for(let u=1;u<i-1;u++){let f=0,d=0,m=0;for(let _=u-1;_>=0&&!(r[_+1]<r[u]-c);_--){const p=c+r[_+1]-r[u],y=r[_+1]-r[_],x=r[u]-r[_]<c?1:p/y;if(Math.abs(x)<1e-6)break;const g=x*x,b=x*p-.5*g*y,w=x*y/t,T=s[_+1],z=s[_][0]-T[0],I=s[_][1]-T[1];f+=w/b*(T[0]*x*p+.5*g*(p*z-y*T[0])-g*x*y*z/3),d+=w/b*(T[1]*x*p+.5*g*(p*I-y*T[1])-g*x*y*I/3),m+=w}for(let _=u+1;_<i&&!(r[_-1]>r[u]+c);_++){const p=c-r[_-1]+r[u],y=r[_]-r[_-1],x=r[_]-r[u]<c?1:p/y;if(Math.abs(x)<1e-6)break;const g=x*x,b=x*p-.5*g*y,w=x*y/t,T=s[_-1],z=s[_][0]-T[0],I=s[_][1]-T[1];f+=w/b*(T[0]*x*p+.5*g*(p*z-y*T[0])-g*x*y*z/3),d+=w/b*(T[1]*x*p+.5*g*(p*I-y*T[1])-g*x*y*I/3),m+=w}a.push(f/m),a.push(d/m)}a.push(o),a.push(h);for(let u=0,f=0;u<i;u++)s[u][0]=a[f++],s[u][1]=a[f++]}let ur=class{static getPlacement(t,e,i,r,n,a){const o=Kr(i);return o?(e===-1&&t.invertY(),o.execute(t,i,r,n,a)):null}};const mt=8,st=M(4,4),Gt=M(16,4),jt=M(4,2),D=M(4,6),Pi=[jt,jt,D,D],$i=[jt,D,jt,D],As=[D,D,st,st],Rs=[st,st,D,D],Bs=[D,st,D,st],Fs=[st,D,st,D],dr=s=>class extends s{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=S.TEXT,this._aux=P(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){this._shapingInfo=t?.length?vs(t,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:es*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize}):null}_write(t,e,i,r){const n=e.getDisplayId();this._writeGeometry(t,e,n,i,r)}_writeGeometry(t,e,i,r,n){const a=this._shapingInfo;if(a==null)return;if(this._textPlacement)return this._writePlacedText(t,i,a,r,e,n);const o=n?n.asOptimized():e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(o!=null){if(o.isPoint){const[h,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(h<0||h>=512||l<0||l>=512)?void 0:this._writeGlyphs(t,i,{x:h,y:l},a)}o.forEachVertex((h,l)=>this._writeGlyphs(t,i,{x:h,y:l},a))}}_writePlacedText(t,e,i,r,n,a){const o=this._textPlacement,h=a||re.fromFeatureSetReaderCIM(n);if(!h)return;const l=-1,c=ur.getPlacement(h,l,o,v(1),t.tileKey,r.geometryEngine);if(!c)return;const u=i.bounds,f=Math.sqrt(u.height*u.height+u.width*u.width);let d,m,_;for(;d=c.next();)if(m=d.tx,_=-d.ty,m+f>=0&&m-f<512&&_+f>=0&&_-f<512){const p=-d.getAngle();i.setRotation(p),this._writeGlyphs(t,e,{x:m,y:_},i),i.setRotation(-p)}}_writeGlyphs(t,e,i,r){const n=Z.load(this._materialKey),a=M(Math.round(mt*i.x),Math.round(mt*i.y)),o=this._vertexBoundsScale,{bounds:h,background:l,glyphs:c}=r;c.length>0&&(this._borderLineColor||this._backgroundColor)&&(n.textureBinding=c[0].textureBinding,t.recordStart(e,n.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,i,h,l),t.recordEnd());const u=2*Math.max(h.width,h.height);for(const f of r.glyphs)n.textureBinding=f.textureBinding,t.recordStart(e,n.data,this.geometryType,!0),t.vertexBounds(i.x+h.x+this._xOffset,i.y+h.y-this._yOffset,u*o,u*o),this._writeVertices(t,e,a,f),t.recordEnd()}_writeGlyph(t,e,i,r,n){const a=Z.load(this._materialKey),o=M(Math.round(mt*i),Math.round(mt*r));a.textureBinding=n.textureBinding,t.recordStart(e,a.data,this.geometryType,!0);const h=n.bounds,l=this._vertexBoundsScale;t.vertexBounds(i+h.x*l,r+h.y*l,h.width*l,h.height*l),this._writeVertices(t,e,o,n),t.recordEnd()}_writeVertices(t,e,i,r){const n=t.vertexCount();this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.upperLeft),t.vertexWrite(r.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.upperRight),t.vertexWrite(r.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.lowerLeft),t.vertexWrite(r.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.lowerRight),t.vertexWrite(r.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_writeVertexCommon(t,e,i,r){const n=this._color,a=this._haloColor,o=P(0,0,this._referenceSize,this._bitset),h=P(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(t,e,i,r,n,a){const o=P(0,1,this._referenceSize,this._bitset),h=P(0,0,this._size,this._haloSize),l=P(0,0,0,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(l),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom),t.vertexWrite(n),t.vertexWrite(a),t.vertexEnd()}_writeBackgroundQuad(t,e,i,r,n,a){const o=t.vertexCount();this._writeBackgroundVertex(t,e,i,r,n.upperLeft,a[0]),this._writeBackgroundVertex(t,e,i,r,n.upperRight,a[1]),this._writeBackgroundVertex(t,e,i,r,n.lowerLeft,a[2]),this._writeBackgroundVertex(t,e,i,r,n.lowerRight,a[3]),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}_writeBackgroundGeometry(t,e,i,r,n){const a=M(Math.round(mt*i.x),Math.round(mt*i.y)),{x:o,y:h,width:l,height:c}=r,u=2*Math.max(l,c);if(t.vertexBounds(i.x+o+this._xOffset,i.y+h-this._yOffset,u*this._vertexBoundsScale,u*this._vertexBoundsScale),this._backgroundColor){const f=[Gt,Gt,Gt,Gt];this._writeBackgroundQuad(t,e,a,this._backgroundColor,n.main,f)}if(this._borderLineColor||this._backgroundColor){const f=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[d,m,_,p,y]=f?[Pi,Pi,$i,$i,this._borderLineColor]:[As,Rs,Bs,Fs,this._backgroundColor];this._writeBackgroundQuad(t,e,a,y,n.top,d),this._writeBackgroundQuad(t,e,a,y,n.bot,m),this._writeBackgroundQuad(t,e,a,y,n.left,_),this._writeBackgroundQuad(t,e,a,y,n.right,p)}}};let Rt=class{constructor(){this._materialKey=null}bindFeature(t,e,i){}write(t,e,i,r){if(this._effects&&this._effects.length>0){let n=re.fromFeatureSetReaderCIM(e);if(n){n.invertY();const a=Gr.executeEffects(this._effects,n,t.tileKey,r.geometryEngine);for(;n=a.next();)n.invertY(),this._write(t,e,r,n)}}else this._write(t,e,r)}_write(t,e,i,r){}};const Os=5;let Le=class Te extends dr(Rt){constructor(t,e,i,r,n,a,o,h,l,c,u,f,d,m,_,p,y,x,g,b,w,T,z,I){super(),this._xOffset=v(d),this._yOffset=v(m),this._decoration=c||"none",this._backgroundColor=T,this._borderLineColor=z,this._borderLineSize=I,this._color=n,this._haloColor=a,this._haloSize=Math.min(Math.floor(Os*v(Pr(i))),127),this._size=Math.min(Math.round(v(e)),127);const Y=Math.min(Math.round(v(r||e)),127);this._referenceSize=Math.round(Math.sqrt(256*Y)),this._scale=this._size/Hi,this._angle=f,this._justify=Zr(o||"center"),this._xAlignD=Ni(o||"center"),this._yAlignD=Ui(h||"baseline"),this._baseline=(h||"baseline")==="baseline",this._bitset=(l===K.MAP?1:0)|(u?1:0)<<1;const ft=Z.load(t);ft.sdf=!0,this._materialKey=ft.data,this._lineWidth=v(_)||512,this._lineHeight=p||1,this._textPlacement=y,this._effects=x,this._isCIM=g??!1,this._minMaxZoom=M(Math.round(b*E),Math.round(w*E))}static fromText(t,e){const i=t.font?.size,r=new Te(t.materialKey,i,t.haloSize||0,i,t.color&&O(t.color)||0,t.haloColor&&O(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,K.SCREEN,t.font?.decoration,!1,t.angle||0,t.xoffset||0,t.yoffset||0,t.lineWidth||0,t.lineHeight||0,null,null,!1,N,U,t.backgroundColor&&O(t.backgroundColor),t.borderLineColor&&O(t.borderLineColor),t.borderLineSize),[,n]=ye(t.text);return r.bindTextInfo(e??[],n),r._vertexBoundsScale=t.maxVVSize&&i?t.maxVVSize/i:1,r}static fromCIMText(t,e,i){const r=t.scaleFactor||1,n=t.size*t.sizeRatio*r,[a,o]=at(t.scaleInfo,i),h=new Te(t.materialKey,n,t.outlineSize*t.sizeRatio,t.referenceSize,$(t.color),$(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked??!1,t.angle,t.offsetX*t.sizeRatio*r,t.offsetY*t.sizeRatio*r,t.lineWidth||512,1,t.markerPlacement,t.effects,!0,a,o,t.backgroundColor?$(t.backgroundColor):void 0,t.borderLineColor?$(t.borderLineColor):void 0,t.borderLineWidth),[,l]=ye(t.text);return h.bindTextInfo(e,l),h._vertexBoundsScale=t.maxVVSize?t.maxVVSize/n:1,h}};const fr=wt.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Ds=(s,t="mapview-labeling")=>fr.error(new St(t,s)),Zt=1,pt=0,Ks=4,de=25;function Gs(s,t){const e=!!s.minScale&&t.scaleToZoom(s.minScale)||0;return Gi(e,0,25.5)}function Zs(s,t){const e=!!s.maxScale&&t.scaleToZoom(s.maxScale)||255;return Gi(e,0,25.5)}function Ns(s){const t=new Map;return e=>(t.has(e)||t.set(e,s(e)),t.get(e))}const Us=Ns(s=>{let t=0;if(s===0)return 1/0;for(;!(s%2);)t++,s/=2;return t}),Nt=s=>Math.floor(127*s+127),ot=s=>Math.floor(s*E),J=s=>Math.round(s*(254/360));class Qt extends Le{constructor(t,e,i,r){super(t,i.font?.size,i.haloSize||0,i.font?.size,i.color&&O(i.color)||0,i.haloColor&&O(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Zi(e.labelPlacement)?K.MAP:K.SCREEN,i.font?.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,!1,null,null,i.backgroundColor&&O(i.backgroundColor),i.borderLineColor&&O(i.borderLineColor),i.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=S.LABEL,this._allowOverrun=e.allowOverrun??!1,this._repeatLabel=e.repeatLabel??!0,this._labelPosition=e.labelPosition??"curved";const n=Gs(e,r),a=Zs(e,r),o=e.labelPlacement,[h,l]=Nr(o);this._xAlignD=h,this._yAlignD=l,this._minZoom=n,this._maxZoom=a,this._minBackgroundZoom=n,this._maxBackgroundZoom=a,this._refPlacementPadding=v(i.haloSize)+is,this._repeatLabelDistance=e.repeatLabelDistance?v(e.repeatLabelDistance):128;const c=ct.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const i=t.symbol;i.xoffset=0,i.yoffset=0,i.angle=0,i.font.decoration="none"}return new Qt(t.materialKey,t,t.symbol,e)}get _shapedBox(){return this._shapingInfo.bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=Ur(this._xAlignD),i=Xr(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,t==null)return void(this._refSymbolAndPlacementOffset=P(0,0,Nt(e),Nt(i)));if(t.boundsType==="circle"&&(e||i)){const a=Math.sqrt(e*e+i*i);e/=a,i/=a}const r=Math.max(t.height,t.width),n=this._refPlacementPadding*Ks;this._refSymbolAndPlacementOffset=P(n,r,Nt(e),Nt(i)),this._referenceSize=r,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(this._shapingInfo==null)return;const i=this._shapingInfo,r=e.getDisplayId(),n=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(n)switch(this._current={out:t,inId:r,inShaping:i,zoomLevel:this._zoomLevel},e.geometryType==="esriGeometryPolyline"&&this._labelPosition==="curved"&&(this._borderLineColor||this._backgroundColor)&&fr.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:Ds(`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const i=ot(this._current.zoomLevel);return ot(t)<=i&&i<=ot(e)}_placePointLabels(t){const{out:e,inId:i,inShaping:r}=this._current;this._writeGlyphs(e,i,t,r)}_placeLineLabels(t){const e=Vs(t.paths,this._current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),r=(this._shapedBox.width+this._repeatLabelDistance)/(1<<Zt);for(const n of e)Ws(n,r,i,this._repeatLabel)}_placeSubdivGlyphs(t,e,i,r){const n=Us(e),a=this._shapedBox.width/(1<<Zt),o=Math.sqrt(this._repeatLabelDistance)/(1<<Zt),h=Math.min(i,r-i),l=this._current.inShaping.isMultiline?de:Math.log2(h/(o+a/2)),c=e===0?l:Math.min(n,l),u=Math.max(this._minZoom,this._current.zoomLevel+Zt-c),f=this._current.zoomLevel-u,d=this._shapedBox.width/2*2**f;this._current.inShaping.isMultiline?e===0&&this._placeStraight(t,u):this._allowOverrun&&f<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,u):this._labelPosition==="curved"&&this._placeCurved(t,u,d)}_placeStraight(t,e){const{out:i,inId:r,inShaping:n}=this._current,a=Math.ceil(t.angle*(180/Math.PI)%360),o=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=J(a),this._writeGlyphs(i,r,t,n,e),this._outLineLabelAngle=J(o),this._writeGlyphs(i,r,t,n,e)}_placeCurved(t,e,i){const{out:r,inId:n}=this._current;r.metricStart(n,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=J(o),this._placeFirst(a,e,1),this._placeBack(t,a,e,i,1),this._placeForward(t,a,e,i,1),this._outLineLabelAngle=J(h),this._placeFirst(a,e,0),this._placeBack(t,a,e,i,0),this._placeForward(t,a,e,i,0),r.metricEnd()}_placeStraightAlong(t,e){const{out:i,inId:r,inShaping:n}=this._current;i.metricStart(r,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360,l=n.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=de,this._minBackgroundZoom=Math.max(e,0),l){const c=ct.load(this._materialKey);c.textureBinding=n.glyphs[0].textureBinding;const u=ee(Q(),-t.angle),[f,d]=n.shapeBackground(u);this._outLineLabelAngle=J(o),i.recordStart(r,c.data,this.geometryType,!0),this._writeBackgroundGeometry(i,r,t,f,d),i.recordEnd(),this._outLineLabelAngle=J(h),i.recordStart(r,c.data,this.geometryType,!0),this._writeBackgroundGeometry(i,r,t,f,d),i.recordEnd()}this._outLineLabelAngle=J(o),this._placeFirst(a,e,1,!0),this._outLineLabelAngle=J(h),this._placeFirst(a,e,0,!0),i.metricEnd()}_placeBack(t,e,i,r,n){const a=t.clone();let o=t.backwardLength+pt;for(;a.prev()&&!(o>=r);)this._placeOnSegment(a,e,o,i,-1,n),o+=a.length+pt}_placeForward(t,e,i,r,n){const a=t.clone();let o=t.remainingLength+pt;for(;a.next()&&!(o>=r);)this._placeOnSegment(a,e,o,i,1,n),o+=a.length+pt}_placeFirst(t,e,i,r=!1){const n=t,a=this._current.inShaping,o=a.glyphs,h=this._current.zoomLevel,{out:l,inId:c}=this._current;for(const u of o){const f=u.x>a.bounds.x?i:1-i,d=f*t.remainingLength+(1-f)*t.backwardLength,m=Math.abs(u.x+u.width/2-a.bounds.x),_=Math.max(0,h+Math.log2(m/(d+pt))),p=Math.max(e,r?0:_);if(u.maxZoom=de,u.angle=t.angle+(1-i)*Math.PI,u.minZoom=p,this._writeGlyph(l,c,n.x,n.y,u),i&&this._isVisible(u.minZoom,u.maxZoom)){const y=u.bounds;l.metricBoxWrite(y.center[0],y.center[1],y.width,y.height)}}}_placeOnSegment(t,e,i,r,n,a){const o=this._current.inShaping.glyphs,{out:h,inId:l}=this._current,c=this._current.inShaping,u=this._current.zoomLevel,f=t.dx/t.length,d=t.dy/t.length,m={x:t.x+i*-n*f,y:t.y+i*-n*d};for(const _ of o){const p=_.x>c.bounds.x?a:1-a;if(!(p&&n===1||!p&&n===-1))continue;const y=Math.abs(_.x+_.width/2-c.bounds.x),x=Math.max(0,u+Math.log2(y/i)-.1),g=Math.max(r,u+Math.log2(y/(i+t.length+pt)));if(x!==0&&(_.angle=t.angle+(1-a)*Math.PI,_.minZoom=g,_.maxZoom=x,this._writeGlyph(h,l,m.x,m.y,_),a&&this._isVisible(_.minZoom,_.maxZoom))){const b=_.bounds,w=t.x-e.x,T=t.y-e.y;h.metricBoxWrite(b.center[0]+w,b.center[1]+T,b.width,b.height)}}}_writeGlyphs(t,e,i,r,n=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;if(r.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const u=ct.load(this._materialKey);u.textureBinding=r.glyphs[0].textureBinding,t.recordStart(e,u.data,this.geometryType,!0),this._writeBackgroundGeometry(t,e,i,r.bounds,r.background),t.recordEnd()}const a=i.x+this._refOffsetX,o=i.y-this._refOffsetY;for(const u of r.glyphs)u.minZoom=n,u.maxZoom=this._maxZoom,this._writeGlyph(t,e,a,o,u);const h=this._refPlacementDirX,l=this._refPlacementDirY,c=r.boundsT;t.metricStart(e,n,a,o,h,l,this._referenceSize,this._materialKey),t.metricBoxWrite(c.center[0],c.center[1],c.width,c.height),t.metricEnd()}_writeVertexCommon(t,e,i,r){const n=this._color,a=this._haloColor,o=P(0,0,this._size,this._haloSize),h=Math.max(r.minZoom,this._minZoom),l=Math.min(r.maxZoom,this._maxZoom),c=P(ot(h),ot(l),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}_writeBackgroundVertex(t,e,i,r,n,a){const o=P(0,0,this._size,this._haloSize),h=P(0,0,0,0),l=P(ot(this._minBackgroundZoom),ot(this._maxBackgroundZoom),this._outLineLabelAngle,1);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(l),t.vertexWrite(n),t.vertexWrite(a),t.vertexEnd()}}const fe=3.14159265359/180,Ci=8,_r=s=>class extends s{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this.geometryType=S.MARKER}_write(t,e,i,r){const n=e.getDisplayId();t.recordStart(n,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,n,i,r),t.recordEnd()}_writeGeometry(t,e,i,r,n){if(this._markerPlacement!=null)return this._writePlacedMarkers(t,e,r,n);if(this._allowBorrowing=!0,!n&&e.geometryType==="esriGeometryPoint"){const o=e.getX(),h=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=513||h<0||h>=513)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}const a=n?n.asOptimized():e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(a!=null){if(a.isPoint){const[o,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=512||h<0||h>=512)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}a.forEachVertex((o,h)=>{const l=2*ut;o<-l||o>=l||h<-l||h>=l||this._writeVertices(t,i,this._getPos(o,h),o,h)})}}_writePlacedMarkers(t,e,i,r){const n=r||re.fromFeatureSetReaderCIM(e);if(!n)return;const a=-1,o=ur.getPlacement(n,a,this._markerPlacement,v(1),t.tileKey,i.geometryEngine);if(!o)return;this._allowBorrowing=e.geometryType!=="esriGeometryPolygon";const h=e.getDisplayId(),l=Mt(),c=Q(),u=-128,f=640;let d=o.next();for(;d!=null;){const m=d.tx,_=-d.ty;m>=u&&m<=f&&_>=u&&_<=f&&(this._applyTransformation(c,l,-d.getAngle()/fe),this._writeVertices(t,h,this._getPos(m,_),m,_)),d=o.next()}}_writeVertices(t,e,i,r,n){const a=dt.load(this._materialKey);return a.symbologyType===A.HEATMAP?this._writeHeatmapVertices(t,e,i):this._writeMarkerVertices(t,e,a,i,r,n)}_writeMarkerVertices(t,e,i,r,n,a){const o=i.vvRotation,h=t.vertexCount();let l=this._computedWidth*this._vertexBoundsScaleX,c=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const u=Math.max(l,c);l=u,c=u}if(o){const u=Math.max(this.xOffset,this.yOffset);l+=u,c+=u}this._allowBorrowing&&t.vertexBounds(n+this.xOffset,a-this.yOffset,l,c),t.vertexWrite(r),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,h)}_writeHeatmapVertices(t,e,i){const r=t.vertexCount();t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,r)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,i=0){i?ee(t,fe*i):$r(t),Xt(t,t,Ki(this.xOffset,-this.yOffset)),this.angle&&pe(t,t,fe*this.angle);const r=this._computedWidth,n=this._computedHeight,a=-(.5+this._anchorX)*r,o=-(.5-this._anchorY)*n;et(e,a,o),gt(e,e,t),this._offsetUpperLeft=M(16*e[0],16*e[1]),et(e,a+r,o),gt(e,e,t),this._offsetUpperRight=M(16*e[0],16*e[1]),et(e,a,o+n),gt(e,e,t),this._offsetBottomLeft=M(16*e[0],16*e[1]),et(e,a+r,o+n),gt(e,e,t),this._offsetBottomRight=M(16*e[0],16*e[1])}_computeSize(t,e,i,r,n,a,o,h){const l=t*i,c=e*i;if(a.sdf&&!o){const T=h&&t>e?l:t,z=e,I=r+2*1;t=Math.min(T+I,l),e=Math.min(z+I,c)}else t=l,e=c;const u=rs/Math.max(l,c),f=.5*(l-t)*u,d=.5*(c-e)*u,m=a.rect.x+k+f,_=a.rect.y+k+d,p=m+a.width-2*f,y=_+a.height-2*d,x=Math.floor(m),g=Math.floor(_),b=Math.ceil(p),w=Math.ceil(y);t*=(b-x)/(p-m),e*=(w-g)/(y-_),this._texUpperLeft=M(x,g),this._texUpperRight=M(b,g),this._texBottomLeft=M(x,w),this._texBottomRight=M(b,w),this._anchorX*=l/t,this._anchorY*=c/e,t*=n,e*=n,this._computedWidth=t,this._computedHeight=e}_getPos(t,e){return M(Math.round(Ci*t),Math.round(Ci*e))}};let It=class Pt extends _r(Rt){constructor(t,e,i,r,n,a,o,h,l,c,u,f,d,m,_,p,y,x,g,b,w,T,z,I){super(),this.angle=r,this.height=o,this.width=a,this.xOffset=e*g,this.yOffset=i*g,this._markerPlacement=b||void 0,this._effects=w||void 0,this._anchorX=p,this._anchorY=y,this._minMaxZoom=M(Math.round(T*E),Math.round(z*E));const Y=(m===K.MAP?Yi:qi)|(u?it:0)|(d?ss:0)|(f?ji:0),ft=_&&_.sdf,_t=dt.load(t);_t.sdf=ft,_t.pattern=!0,_t.textureBinding=_.textureBinding,this._materialKey=_t.data,this._fillColor=n,this._outlineColor=l,this._sizeOutlineWidth=P(Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*h),255))),_t.symbologyType===A.PIE_CHART?(a*=x*g,o*=x*g,this._computedWidth=a,this._computedHeight=o,this._texUpperLeft=M(0,1),this._texUpperRight=M(1,1),this._texBottomLeft=M(0,0),this._texBottomRight=M(1,0)):this._computeSize(a,o,x,c,g,_,_t.hasSizeVV(),I);const Lr=Math.round(64*x);this._bitestAndDistRatio=M(Y,Lr);const Tr=Mt(),zr=Q();this._applyTransformation(zr,Tr)}static fromCIMMarker(t,e,i){const r=e&&e.width||1,n=e&&e.height||1,a=t.size,o=r/n*t.scaleX,h=t.scaleSymbolsProportionally&&t.frameHeight?a/t.frameHeight:1,l=$(t.color),c=$(t.outlineColor),u=v(a),f=u*o,d=v(t.offsetX||0),m=v(t.offsetY||0),_=v(t.outlineWidth||0)*h,p=t.alignment||K.SCREEN,y=v(t.referenceSize),[x,g]=at(t.scaleInfo,i);let b=t.rotation||0;t.rotateClockwise||(b=-b);let w=0,T=0;const z=t.anchorPoint;z&&(t.isAbsoluteAnchorPoint?a&&(w=z.x/(a*o),T=z.y/a):(w=z.x,T=z.y));const I=new Pt(t.materialKey,d,m,b,l,f,u,y,c,_,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,w,T,t.sizeRatio,t.scaleFactor??1,t.markerPlacement,t.effects,x,g,!0);return I._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/f:1,I._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/u:1,I}static fromPictureMarker(t,e){const i=Math.round(v(t.width)),r=Math.round(v(t.height)),n=Qi,a=Math.round(v(t.xoffset||0)),o=Math.round(v(t.yoffset||0)),h=new Pt(t.materialKey,a,o,t.angle,n,i,r,r,0,0,!1,!1,!1,K.SCREEN,e,0,0,1,1,null,null,N,U,!1);return h._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,h._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,h}static fromSimpleMarker(t,e){const i=t.style,r=O(t.color),n=Math.round(v(t.size));let a=n;i==="esriSMSTriangle"&&(a*=e.height/e.width);const o=Math.round(v(t.xoffset||0)),h=Math.round(v(t.yoffset||0)),l=t.outline,c=0|(l?.color&&O(l.color)),u=0|(l?.width&&Math.round(v(l.width))),f=new Pt(t.materialKey,o,h,t.angle??0,r,n,a,a,c,u,!1,!1,i==="esriSMSCross"||i==="esriSMSX",K.SCREEN,e,0,0,2,1,null,null,N,U,!1);return f.boundsType=i==="esriSMSCircle"?"circle":"square",f._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,f._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,f}static fromLineSymbolMarker(t,e){const i=O(t.color),r=6,n=Math.round(v(r*t.lineWidth)),a=n,o=t.style==="cross"||t.style==="x";let h;switch(t.placement){case"begin-end":h=Bt.Both;break;case"begin":h=Bt.JustBegin;break;case"end":h=Bt.JustEnd;break;default:h=Bt.None}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},c=new Pt(t.materialKey,0,0,0,i,n,a,a/r,i,o?Math.round(v(t.lineWidth)):0,!1,!1,o,K.MAP,e,0,0,2,1,l,null,N,U,!1);return c.boundsType=t.style==="circle"?"circle":"square",c}};function Xs(s,t,e,i,r,n,a){Pe=0;const o=(i-e)*n,h=r&&r.length,l=h?(r[0]-e)*n:o;let c,u,f,d,m,_=mr(t,e,i,0,l,n,!0);if(_&&_.next!==_.prev){if(h&&(_=js(t,e,i,r,_,n)),o>80*n){c=f=t[0+e*n],u=d=t[1+e*n];for(let p=n;p<l;p+=n){const y=t[p+e*n],x=t[p+1+e*n];c=Math.min(c,y),u=Math.min(u,x),f=Math.max(f,y),d=Math.max(d,x)}m=Math.max(f-c,d-u),m=m!==0?1/m:0}Wt(_,s,n,c,u,m,a,0)}}function mr(s,t,e,i,r,n,a){let o;if(a===rn(s,t,e,i,r,n)>0)for(let h=i;h<r;h+=n)o=Ei(h+t*n,s[h+t*n],s[h+1+t*n],o);else for(let h=r-n;h>=i;h-=n)o=Ei(h+t*n,s[h+t*n],s[h+1+t*n],o);return o&&lt(o,o.next)&&(Vt(o),o=o.next),o}function Et(s,t=s){if(!s)return s;let e,i=s;do if(e=!1,i.steiner||!lt(i,i.next)&&C(i.prev,i,i.next)!==0)i=i.next;else{if(Vt(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function Wt(s,t,e,i,r,n,a,o){if(!s)return;!o&&n&&(s=pr(s,i,r,n));let h=s;for(;s.prev!==s.next;){const l=s.prev,c=s.next;if(n?Ys(s,i,r,n):Hs(s))t.push(l.index/e+a),t.push(s.index/e+a),t.push(c.index/e+a),Vt(s),s=c.next,h=c.next;else if((s=c)===h){o?o===1?Wt(s=nn(s,t,e,a),t,e,i,r,n,a,2):o===2&&an(s,t,e,i,r,n,a):Wt(Et(s),t,e,i,r,n,a,1);break}}}function Hs(s){const t=s.prev,e=s,i=s.next;if(C(t,e,i)>=0)return!1;let r=s.next.next;const n=r;let a=0;for(;r!==s.prev&&(a===0||r!==n);){if(a++,vt(t.x,t.y,e.x,e.y,i.x,i.y,r.x,r.y)&&C(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Ys(s,t,e,i){const r=s.prev,n=s,a=s.next;if(C(r,n,a)>=0)return!1;const o=r.x<n.x?r.x<a.x?r.x:a.x:n.x<a.x?n.x:a.x,h=r.y<n.y?r.y<a.y?r.y:a.y:n.y<a.y?n.y:a.y,l=r.x>n.x?r.x>a.x?r.x:a.x:n.x>a.x?n.x:a.x,c=r.y>n.y?r.y>a.y?r.y:a.y:n.y>a.y?n.y:a.y,u=ze(o,h,t,e,i),f=ze(l,c,t,e,i);let d=s.prevZ,m=s.nextZ;for(;d&&d.z>=u&&m&&m.z<=f;){if(d!==s.prev&&d!==s.next&&vt(r.x,r.y,n.x,n.y,a.x,a.y,d.x,d.y)&&C(d.prev,d,d.next)>=0||(d=d.prevZ,m!==s.prev&&m!==s.next&&vt(r.x,r.y,n.x,n.y,a.x,a.y,m.x,m.y)&&C(m.prev,m,m.next)>=0))return!1;m=m.nextZ}for(;d&&d.z>=u;){if(d!==s.prev&&d!==s.next&&vt(r.x,r.y,n.x,n.y,a.x,a.y,d.x,d.y)&&C(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;m&&m.z<=f;){if(m!==s.prev&&m!==s.next&&vt(r.x,r.y,n.x,n.y,a.x,a.y,m.x,m.y)&&C(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function Ei(s,t,e,i){const r=bt.create(s,t,e);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Vt(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function qs(s){let t=s,e=s;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==s);return e}function js(s,t,e,i,r,n){const a=new Array;for(let o=0,h=i.length;o<h;o++){const l=mr(s,t,e,i[o]*n,o<h-1?i[o+1]*n:e*n,n,!1);l===l.next&&(l.steiner=!0),a.push(qs(l))}a.sort(sn);for(const o of a)r=Qs(o,r);return r}function Qs(s,t){const e=Js(s,t);if(!e)return t;const i=xr(e,s);return Et(i,i.next),Et(e,e.next)}function Js(s,t){let e=t;const i=s.x,r=s.y;let n,a=-1/0;do{if(r<=e.y&&r>=e.next.y&&e.next.y!==e.y){const f=e.x+(r-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(f<=i&&f>a){if(a=f,f===i){if(r===e.y)return e;if(r===e.next.y)return e.next}n=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!n)return null;if(i===a)return n.prev;const o=n,h=n.x,l=n.y;let c,u=1/0;for(e=n.next;e!==o;)i>=e.x&&e.x>=h&&i!==e.x&&vt(r<l?i:a,r,h,l,r<l?a:i,r,e.x,e.y)&&(c=Math.abs(r-e.y)/(i-e.x),(c<u||c===u&&e.x>n.x)&&kt(e,s)&&(n=e,u=c)),e=e.next;return n}function pr(s,t,e,i){let r;for(;r!==s;r=r.next){if(r=r||s,r.z===null&&(r.z=ze(r.x,r.y,t,e,i)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,pr(s,t,e,i);r.prevZ=r.prev,r.nextZ=r.next}return s.prevZ.nextZ=null,s.prevZ=null,tn(s)}function tn(s){let t,e=1;for(;;){let i,r=s;s=null,t=null;let n=0;for(;r;){n++,i=r;let a=0;for(;a<e&&i;a++)i=i.nextZ;let o=e;for(;a>0||o>0&&i;){let h;a===0?(h=i,i=i.nextZ,o--):o!==0&&i?r.z<=i.z?(h=r,r=r.nextZ,a--):(h=i,i=i.nextZ,o--):(h=r,r=r.nextZ,a--),t?t.nextZ=h:s=h,h.prevZ=t,t=h}r=i}if(t.nextZ=null,e*=2,n<2)return s}}function C(s,t,e){return(t.y-s.y)*(e.x-t.x)-(t.x-s.x)*(e.y-t.y)}function yr(s,t,e,i){return!!(lt(s,t)&&lt(e,i)||lt(s,i)&&lt(e,t))||C(s,t,e)>0!=C(s,t,i)>0&&C(e,i,s)>0!=C(e,i,t)>0}function en(s,t){let e=s;do{if(e.index!==s.index&&e.next.index!==s.index&&e.index!==t.index&&e.next.index!==t.index&&yr(e,e.next,s,t))return!0;e=e.next}while(e!==s);return!1}function rn(s,t,e,i,r,n){let a=0;for(let o=i,h=r-n;o<r;o+=n)a+=(s[h+t*n]-s[o+t*n])*(s[o+1+t*n]+s[h+1+t*n]),h=o;return a}function vt(s,t,e,i,r,n,a,o){return(r-a)*(t-o)-(s-a)*(n-o)>=0&&(s-a)*(i-o)-(e-a)*(t-o)>=0&&(e-a)*(n-o)-(r-a)*(i-o)>=0}function kt(s,t){return C(s.prev,s,s.next)<0?C(s,t,s.next)>=0&&C(s,s.prev,t)>=0:C(s,t,s.prev)<0||C(s,s.next,t)<0}function ze(s,t,e,i,r){return(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=32767*(s-e)*r)|s<<8))|s<<4))|s<<2))|s<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function lt(s,t){return s.x===t.x&&s.y===t.y}function sn(s,t){return s.x-t.x}function nn(s,t,e,i){let r=s;do{const n=r.prev,a=r.next.next;!lt(n,a)&&yr(n,r,r.next,a)&&kt(n,a)&&kt(a,n)&&(t.push(n.index/e+i),t.push(r.index/e+i),t.push(a.index/e+i),Vt(r),Vt(r.next),r=s=a),r=r.next}while(r!==s);return r}function an(s,t,e,i,r,n,a){let o=s;do{let h=o.next.next;for(;h!==o.prev;){if(o.index!==h.index&&on(o,h)){let l=xr(o,h);return o=Et(o,o.next),l=Et(l,l.next),Wt(o,t,e,i,r,n,a,0),void Wt(l,t,e,i,r,n,a,0)}h=h.next}o=o.next}while(o!==s)}function on(s,t){return s.next.index!==t.index&&s.prev.index!==t.index&&!en(s,t)&&kt(s,t)&&kt(t,s)&&hn(s,t)}function hn(s,t){let e=s,i=!1;const r=(s.x+t.x)/2,n=(s.y+t.y)/2;do e.y>n!=e.next.y>n&&e.next.y!==e.y&&r<(e.next.x-e.x)*(n-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==s);return i}function xr(s,t){const e=bt.create(s.index,s.x,s.y),i=bt.create(t.index,t.x,t.y),r=s.next,n=t.prev;return s.next=t,t.prev=s,e.next=r,r.prev=e,i.next=e,e.prev=i,n.next=i,i.prev=n,i}class bt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const r=Pe<Ie.length?Ie[Pe++]:new bt;return r.index=t,r.x=e,r.y=i,r.prev=null,r.next=null,r.z=null,r.prevZ=null,r.nextZ=null,r.steiner=!1,r}}const Ie=new Array,ln=8096;let Pe=0;for(let s=0;s<ln;s++)Ie.push(new bt);const cn=1e-5,ht=new ir(0,0,0,1,0),$e=new ir(0,0,0,1,0);function Wi(s,t,e){let i=0;for(let r=1;r<e;r++){const n=s[2*(t+r-1)],a=s[2*(t+r-1)+1];i+=(s[2*(t+r)]-n)*(s[2*(t+r)+1]+a)}return i}function un(s,t,e,i,r){let n=0;const a=2;for(let o=e;o<i;o+=3){const h=(s[o]-r)*a,l=(s[o+1]-r)*a,c=(s[o+2]-r)*a;n+=Math.abs((t[h]-t[c])*(t[l+1]-t[h+1])-(t[h]-t[l])*(t[c+1]-t[h+1]))}return n}function dn(s,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:r}=t,n=0,a=s;if(r)return!1;let o=0;for(let h=0;h<i.length;){let l=h,c=i[h],u=Wi(e,o,c);const f=[];for(;++l<i.length;){const p=i[l],y=Wi(e,o+c,p);if(!(y>0))break;u+=y,f.push(o+c),c+=p}const d=a.length;Xs(a,e,o,o+c,f,2,n);const m=un(a,e,d,a.length,n),_=Math.abs(u);if(Math.abs((m-_)/Math.max(1e-7,_))>cn)return a.length=0,!1;h=l,o+=c}return!0}function fn(s){const{coords:t,lengths:e}=s,{buffer:i}=ls(t,e);return i}function _n(s,t,e){let i=0;for(let r=0;r<s.lengths.length;r++){const n=s.lengths[r];for(let a=0;a<n;a++){const o=s.coords[2*(a+i)],h=s.coords[2*(a+i)+1];if(o<t||o>e||h<t||h>e)return!0}i+=n}return!1}function mn(s,t){if(s==null)return null;if(!_n(s,-128,ut+128))return s;ht.setPixelMargin(t),ht.reset(rr.Polygon);let e=0;for(let a=0;a<s.lengths.length;a++){const o=s.lengths[a];let h=s.coords[2*(0+e)],l=s.coords[2*(0+e)+1];ht.moveTo(h,l);for(let c=1;c<o;c++)h=s.coords[2*(c+e)],l=s.coords[2*(c+e)+1],ht.lineTo(h,l);ht.close(),e+=o}const i=ht.result(!1);if(!i)return null;const r=[],n=[];for(const a of i){let o=0;for(const h of a)n.push(h.x),n.push(h.y),o++;r.push(o)}return new Cr(r,n)}function pn(s,t){$e.setPixelMargin(t);const e=$e,i=-t,r=ut+t;let n=[],a=!1;if(!s.nextPath())return null;let o=!0;for(;o;){s.seekPathStart();const h=[];if(!s.pathSize)return null;e.reset(rr.LineString),s.nextPoint();let l=s.x,c=s.y;if(a)e.moveTo(l,c);else{if(l<i||l>r||c<i||c>r){a=!0;continue}h.push({x:l,y:c})}let u=!1;for(;s.nextPoint();)if(l=s.x,c=s.y,a)e.lineTo(l,c);else{if(l<i||l>r||c<i||c>r){u=!0;break}h.push({x:l,y:c})}if(u)a=!0;else{if(a){const f=e.resultWithStarts();if(f)for(const d of f)n.push(d)}else n.push({line:h,start:0});o=s.nextPath(),a=!1}}return n=n.filter(h=>h.line.length>1),n.length===0?null:n}ht.setExtent(ut),$e.setExtent(ut);const Jt=8,B=16,Vi=65535,gr=s=>class extends s{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=S.LINE}writeGeometry(t,e,i,r){this._writeGeometry(t,e,i,r)}_initializeTessellator(t){const e=rt.load(this._materialKey),i=H.load(this._materialKey),r=this._tessellationOptions,n=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<ns&&!t&&!n;this.tessellationProperties.minMaxZoom=this._minMaxZoom,r.wrapDistance=Vi,r.textured=this._isDashed||this._hasPattern,r.offset=this.tessellationProperties.offset,r.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1,h=qt(i)?xn:yn;this._lineTessellator=new cs(h(this.tessellationProperties,o,o),gn(this.tessellationProperties),a)}_write(t,e,i,r){const n=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,r,n),t.recordEnd()}_writeGeometry(t,e,i,r){const n=i||re.fromFeatureSetReaderCIM(e);if(!n)return;const a=this._getLines(n,r);a!=null&&this._writeVertices(t,e,a)}_getLines(t,e){return pn(t,e?256:16)}_writeVertices(t,e,i){const r=e.getDisplayId(),n=t.vertexCount(),a=this.tessellationProperties,o=this._tessellationOptions;a.out=t,a.id=r,a.indexCount=0,a.vertexCount=0,a.offset=n,o.capType=this._capType,o.joinType=this._joinType;const h=H.load(this._materialKey);this.tessellationProperties.key=qt(h)?h:rt.load(this._materialKey);for(const{line:l,start:c}of i)o.initialDistance=c%Vi,this._lineTessellator.tessellate(l,o)}},yn=(s,t,e)=>(i,r,n,a,o,h,l,c,u,f,d)=>{const m=M(d,Math.ceil(B*s._halfWidth)),_=P(Math.round(B*l),Math.round(B*c),Math.round(B*u),Math.round(B*f)),p=P(B*o,B*h,0,s._bitset),y=s.out;return y.vertexBounds(i,r,t,e),y.vertexWrite(M(Jt*i,Jt*r)),y.vertexWrite(s.id),y.vertexWrite(s._fillColor),y.vertexWrite(_),y.vertexWrite(m),y.vertexWrite(s._tl),y.vertexWrite(s._br),y.vertexWrite(p),y.vertexWrite(M(Math.ceil(B*s._halfReferenceWidth),0)),y.vertexWrite(s.minMaxZoom),y.vertexEnd(),s.offset+s.vertexCount++},xn=(s,t,e)=>(i,r,n,a,o,h,l,c,u,f,d)=>{const m=M(B*s._halfWidth,B*s._halfReferenceWidth),_=P(B*l+128,B*c+128,B*u+128,B*f+128),p=s.out,y=s._bitset<<24|s.id;p.vertexBounds(i,r,t,e),p.vertexWrite(M(Jt*i,Jt*r)),p.vertexWrite(y),p.vertexWrite(s._fillColor);const x=or(s.key);return x||(p.vertexWrite(0),p.vertexWrite(0)),p.vertexWrite(0),p.vertexWrite(m),p.vertexWrite(_),x||p.vertexWrite(s.minMaxZoom),p.vertexEnd(),s.offset+s.vertexCount++},gn=s=>(t,e,i)=>{const r=s.out;r.indexWrite(t),r.indexWrite(e),r.indexWrite(i),s.indexCount+=3};let Ce=class xt extends gr(Rt){constructor(t,e,i,r,n,a,o,h,l,c,u,f,d,m,_,p,y,x,g,b){super();const w=rt.load(t);e&&(w.sdf=e.sdf,w.pattern=!0,w.textureBinding=e.textureBinding),this._capType=r,this._joinType=n,this._miterLimitCosine=Se(a),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=h,this.tessellationProperties._br=l,this._hasPattern=c,this._isDashed=u,this._zOrder=y,this._effects=x||null,this._minMaxZoom=M(Math.round(g*E),Math.round(b*E)),this._materialKey=w.data;const T=(d?it:0)|(m?as:0)|(f?Ji:0)|(_?ie:0);this.tessellationProperties._bitset=T,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*p,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const r=t.color,n=t.scaleFactor||1,a=!!t.dashTemplate;let o=t.cap;a&&o===He.ROUND&&(o=He.SQUARE);const h=t.join,l=v(t.width)*n,c=v(t.referenceWidth),u=v(t.miterLimit),f=r&&$(r)||0,[d,m]=at(t.scaleInfo,i),_=!1;if(!e)return new xt(t.materialKey,e,l,o,h,u,f,0,0,!1,a,t.scaleDash??!1,t.colorLocked??!1,_,t.sampleAlphaOnly,c,t.zOrder,t.effects,d,m);const{rect:p,width:y,height:x}=e,g=p.x+k,b=p.y+k,w=g+y,T=b+x,z=M(g,b),I=M(w,T),Y=!1;return new xt(t.materialKey,e,l,o,h,u,f,z,I,!0,a,t.scaleDash??!1,t.colorLocked??!1,Y,t.sampleAlphaOnly,c,t.zOrder,t.effects,d,m)}static fromFillOutline(t){const e=H.load(t.materialKey);return qt(e)&&t.outline&&t.outline?.style==="esriSLSSolid"?xt.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,e,i=!1){const{color:r}=t,n=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",a=Qr(t.cap||"round"),o=Jr(t.join||"round");let h=r&&t.style!=="esriSLSNull"&&O(r)||0;t.style==="esriSLSNull"&&(h=0);const l=v(t.width),c=t.miterLimit;if(!e)return new xt(t.materialKey,e,l,a,o,c,h,0,0,!1,n,!0,!1,i,!1,l,0,null,N,U);const{rect:u,width:f,height:d}=e,m=u.x+k,_=u.y+k,p=m+f,y=_+d,x=M(m,_),g=M(p,y);return new xt(t.materialKey,e,l,a,o,c,h,x,g,!0,n,!0,!1,i,!1,l,0,null,N,U)}static fromPictureLineSymbol(t,e,i,r){return wt.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}};const vn=100,ki=1,vr=s=>class extends s{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=S.FILL}_maybeAddLineTemplate(t){this._lineTemplate=Ce.fromFillOutline(t)}_write(t,e,i,r){const n=e.geometryType==="esriGeometryPoint",a=H.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,a,r,n),qt(a)&&this._lineTemplate!=null&&this._lineTemplate.writeGeometry(t,e,r,n),t.recordEnd()}_writeGeometry(t,e,i,r,n){const a=this._getGeometry(e,r,n);if(a==null)return;const o=[];if(!(a.maxLength>vn)&&!this.forceLibtess&&dn(o,a))return void(o.length&&this._writeVertices(t,e,a.coords,a.lengths,i,o));const h=fn(a);this._writeVertices(t,e,h,[h.length/2],i)}_writeVertex(t,e,i,r,n,a){const o=M(ki*r,ki*n);if(t.vertexBounds(r,n,0,0),t.vertexWrite(o),t.vertexWrite(e),i.symbologyType===A.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(a.readGeometryArea()));else{t.vertexWrite(this.fillColor);const h=or(i);h||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),h||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,i,r,n,a){const o=e.getDisplayId(),h=this._bitset<<24|o,l=r.reduce((d,m)=>d+m),c=xe(n.geometryType,n.symbologyType).geometry/4,u=t.vertexCount();t.vertexEnsureSize(c*l);let f=0;if(a)for(const d of a){const m=i[2*d],_=i[2*d+1];this._writeVertex(t,h,n,m,_,e),f++}else for(let d=0;d<i.length;d+=2){const m=Math.round(i[d]),_=Math.round(i[d+1]);this._writeVertex(t,h,n,m,_,e),f++}t.indexEnsureSize(f);for(let d=0;d<f;d++)t.indexWrite(d+u)}_getGeometry(t,e,i){const r=e?.asOptimized()||t.readGeometryForDisplay();return r?mn(r,i?256:8):null}},Ai=wt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");let ue=class extends Rt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}async analyze(t,e,i,r,n){if(n&&n.length===0)return null;const a=n&&n.length>0,o=e.readLegacyFeature(),h=e.getObjectId(),l=this._materialCache,c=this._cimLayer.materialHash;if(!c)return Ai.error("A Dynamic mesh template must have a material hash value or function!"),null;const u=typeof c=="function"?c(o,i,r,h):c,f=l.get(u);if(f!=null)return f;const d=this._ongoingMaterialRequestMap.get(u);if(d)return d;const m=this._cimLayer,_=Hr(m.cim,this._cimLayer.materialOverrides);_.mosaicHash=u;const{type:p,url:y}=m,x={cim:_,type:p,mosaicHash:u,url:y,size:null,dashTemplate:null,text:null,fontName:null,objectId:h,animatedSymbolProperties:null};switch(p){case"marker":x.size=Ft(m.size,o,i,r),x.animatedSymbolProperties=Ft(m.animatedSymbolProperties,o,i,r);break;case"line":x.dashTemplate=m.dashTemplate;break;case"text":x.text=Ft(m.text,o,i,r),x.fontName=Ft(m.fontName,o,i,r)}const g=t.getMosaicItem(x,n).then(b=>(a||(this._ongoingMaterialRequestMap.delete(u),l.set(u,b)),b)).catch(b=>(this._ongoingMaterialRequestMap.delete(u),Ai.error(".analyze()",b.message),null));return a||this._ongoingMaterialRequestMap.set(u,g),g}};function F(s,t){if(s&&"name"in s){const e=s;return t&&t.error(new St(e.name,e.message,e.details)),!1}return!0}let Mn=class Mr extends vr(ue){constructor(t,e,i){if(super(t),this._minMaxZoom=M(Math.round(e*E),Math.round(i*E)),L(t.color)){const c=(u,f,d)=>{const m=t.color(u,f,d);return m&&$(m)||0};this._dynamicPropertyMap.set("fillColor",c)}else{const c=t.color;this.fillColor=c&&$(c)||0}const r=t.cim.placement?.type==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,n=t.height;if(L(n)){const c=(u,f,d)=>n(u,f,d)*r;this._dynamicPropertyMap.set("_height",c)}else this._height=(n||0)*r;const a=t.offsetX;if(L(a)){const c=(u,f,d)=>v(a(u,f,d));this._dynamicPropertyMap.set("_offsetX",c)}else this._offsetX=v(a||0);const o=t.offsetY;if(L(o)){const c=(u,f,d)=>v(-o(u,f,d));this._dynamicPropertyMap.set("_offsetY",c)}else this._offsetY=v(-o||0);const h=t.scaleX;L(h)?this._dynamicPropertyMap.set("_scaleX",h):this._scaleX=h||1;const l=t.angle;if(L(l)){const c=(u,f,d)=>ve(l(u,f,d));this._dynamicPropertyMap.set("_angle",c)}else this._angle=ve(l)||0;if(t.effects!=null){const c=t.effects;L(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._cimFillLayer=t,this._bitset=(t.colorLocked?it:0)|(t.applyRandomOffset?tr:0)|(t.sampleAlphaOnly?ie:0)|(t.hasUnresolvedReplacementColor?er:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,e){const[i,r]=at(t.scaleInfo,e);return new Mr(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(r,e,i)});const n=H.load(this._fillMaterialKey),a=this._materialCache,o=(0,this._cimFillLayer.materialHash)(r,e,i),h=a.get(o);let l=null;if(h&&F(h.spriteMosaicItem)&&(l=h.spriteMosaicItem),l){const{rect:c,width:u,height:f}=l,d=c.x+k,m=c.y+k,_=d+u,p=m+f;let y=v(this._height);y<=0&&(y=p-m),y<tt&&(y*=W,this._bitset|=Ht),y=Math.round(y);let x=v(this._height/f*u);x<=0&&(x=_-d),x<tt&&(x*=W,this._bitset|=Yt),x=Math.round(x);const g=this._scaleX,b=1;this.tl=M(d,m),this.br=M(_,p),this.aux21=M(x,y),this.aux22=M(this._offsetX,this._offsetY),this.aux3=P(g*W,b*W,this._angle,0),n.sdf=l.sdf,n.pattern=!0,n.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}},bn=class br extends gr(ue){constructor(t,e,i){super(t),this._minMaxZoom=M(Math.round(e*E),Math.round(i*E)),this._cimLineLayer=t;let r=0;L(t.width)||(r=.5*v(t.width));const n=(u,f,d)=>L(t.width)?.5*v(t.width(u,f,d)):r;this._dynamicPropertyMap.set("_halfWidth",n),L(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,L(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const a=t.color;if(L(a)){const u=(f,d,m)=>$(a(f,d,m));this._dynamicPropertyMap.set("_fillColor",u)}else this._fillColor=a&&$(a)||0;const o=t.miterLimit;if(L(o)){const u=(f,d,m)=>Se(o(f,d,m));this._dynamicPropertyMap.set("_miterLimitCosine",u)}else this._miterLimitCosine=Se(o);if(t.effects!=null){const u=t.effects;L(u)?this._dynamicPropertyMap.set("_effects",u):this._effects=u}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const h=t.colorLocked?it:0,l=t.scaleDash?Ji:0,c=t.sampleAlphaOnly?ie:0;this.tessellationProperties._bitset=h|l|c,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[i,r]=at(t.scaleInfo,e);return new br(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(r,e,i)}),this._halfWidth*=this._scaleFactor;const n=this._materialCache,a=(0,this._cimLineLayer.materialHash)(r,e,i),o=n.get(a);let h=null;if(o&&F(o.spriteMosaicItem)&&(h=o.spriteMosaicItem),h){this._hasPattern=!0;const{rect:c,width:u,height:f}=h,d=c.x+k,m=c.y+k,_=d+u,p=m+f;this.tessellationProperties._tl=M(d,m),this.tessellationProperties._br=M(_,p)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=rt.load(this._materialKey);h&&(l.sdf=h.sdf,l.pattern=!0,l.textureBinding=h.textureBinding),this._materialKey=l.data}};const Sn=Mt(),wn=Q();let Ln=class Sr extends _r(ue){constructor(t,e,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=M(Math.round(e*E),Math.round(i*E));const r=t.color;if(L(r)){const f=(d,m,_)=>$(r(d,m,_));this._dynamicPropertyMap.set("_fillColor",f)}else this._fillColor=$(r);const n=t.outlineColor;if(L(n)){const f=(d,m,_)=>$(n(d,m,_));this._dynamicPropertyMap.set("_outlineColor",f)}else this._outlineColor=$(n);const a=t.size;if(L(a)){const f=(d,m,_)=>v(a(d,m,_));this._dynamicPropertyMap.set("_size",f)}else this._size=v(a)||0;const o=t.scaleX;L(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o;const h=t.offsetX;if(L(h)){const f=(d,m,_)=>v(h(d,m,_));this._dynamicPropertyMap.set("xOffset",f)}else this.xOffset=v(h)||0;const l=t.offsetY;if(L(l)){const f=(d,m,_)=>v(l(d,m,_));this._dynamicPropertyMap.set("yOffset",f)}else this.yOffset=v(l)||0;const c=t.outlineWidth;if(L(c)){const f=(d,m,_)=>v(c(d,m,_));this._dynamicPropertyMap.set("_outlineWidth",f)}else this._outlineWidth=v(c)||0;const u=t.rotation;if(L(u)?this._dynamicPropertyMap.set("_angle",u):this._angle=u||0,t.effects!=null){const f=t.effects;L(f)?this._dynamicPropertyMap.set("_effects",f):this._effects=f}if(t.markerPlacement!=null){const f=t.markerPlacement;L(f)?this._dynamicPropertyMap.set("_markerPlacement",f):this._markerPlacement=f}this._scaleFactor=t.scaleFactor??1,this._bitSet=(t.alignment===K.MAP?Yi:qi)|(t.colorLocked?it:0)|(t.scaleSymbolsProportionally?ji:0),this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,r]=at(t.scaleInfo,e);return new Sr(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature(),n=t.getObjectId();this._dynamicPropertyMap.forEach((Y,ft)=>{this[ft]=Y(r,e,i)});const a=this._cimMarkerLayer.materialHash,o=typeof a=="function"?a(r,e,i,n):a,h=this._materialCache.get(o);if(!h||!F(h.spriteMosaicItem)||!h.spriteMosaicItem)return void wt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new St("mapview-cim","Encountered an error when binding feature"));const l=h.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,u=l.width/l.height*this._scaleX,f=dt.load(this._materialKey);f.sdf=l.sdf,f.pattern=!0,f.textureBinding=l.textureBinding,this._materialKey=f.data;const d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,m=this._size,_=m*u,p=this.xOffset,y=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const x=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/v(this._cimMarkerLayer.frameHeight):1,g=this._outlineWidth*x,b=v(this._cimMarkerLayer.referenceSize);let w=0,T=0;const z=this._cimMarkerLayer.anchorPoint;z&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(w=v(z.x)/(this._size*u),T=v(z.y)/this._size):(w=z.x,T=z.y)),this._anchorX=w,this._anchorY=T,this._sizeOutlineWidth=P(Math.round(Math.min(Math.sqrt(128*_),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*b),255))),this.angle=d;const I=Math.round(64*c);this._bitestAndDistRatio=M(this._bitSet,I),this._computeSize(_,m,c,g,this._scaleFactor,l,f.hasSizeVV(),!0),this._applyTransformation(wn,Sn),this.xOffset=p,this.yOffset=y}};function Ke(s){if(s==null)return[];const t=new Array(s.length);for(let e=0;e<s.length;e++)t[e]=s.charCodeAt(e);return t}const Ri=5;function Tn(s,t,e,i){return typeof s.text=="string"?s.text:typeof s.text=="function"?s.text(t,e,i)??"":""}let zn=class wr extends dr(ue){constructor(t,e,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=M(Math.round(e*E),Math.round(i*E));const r=t.scaleFactor||1;this._cimTextLayer=t;const n=t.color;if(L(n)){const _=(p,y,x)=>$(n(p,y,x));this._dynamicPropertyMap.set("_color",_)}else this._color=$(n);const a=t.outlineColor;if(L(a)){const _=(p,y,x)=>$(a(p,y,x));this._dynamicPropertyMap.set("_haloColor",_)}else this._haloColor=$(a);let o;L(t.size)||(o=Math.min(Math.round(v(t.size*t.sizeRatio)),127));const h=(_,p,y)=>L(t.size)?Math.min(Math.round(v(t.size(_,p,y)*t.sizeRatio)),127):o;if(this._dynamicPropertyMap.set("_size",h),L(t.outlineSize)){const _=(p,y,x)=>Math.min(Math.floor(Ri*v(t.outlineSize(p,y,x)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",_)}else this._haloSize=Math.min(Math.floor(Ri*v(t.outlineSize*t.sizeRatio)),127);let l;L(t.offsetX)||(l=Math.round(v(t.offsetX*t.sizeRatio)));const c=(_,p,y)=>L(t.offsetX)?Math.round(v(t.offsetX(_,p,y)*t.sizeRatio)):l;let u;this._dynamicPropertyMap.set("_xOffset",c),L(t.offsetY)||(u=Math.round(v(t.offsetY*t.sizeRatio)));const f=(_,p,y)=>L(t.offsetY)?Math.round(v(t.offsetY(_,p,y)*t.sizeRatio)):u;if(this._dynamicPropertyMap.set("_yOffset",f),L(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,L(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,L(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,t.effects!=null){const _=t.effects;L(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}if(t.markerPlacement!=null){const _=t.markerPlacement;L(_)?this._dynamicPropertyMap.set("_markerPlacement",_):this._textPlacement=_}L(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._backgroundColor=t.backgroundColor&&$(t.backgroundColor),this._borderLineColor=t.borderLineColor&&$(t.borderLineColor),this._borderLineSize=t.borderLineWidth,this._scaleFactor=r;const d=Math.min(Math.round(v(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*d)),this._materialKey=t.materialKey;const m=Ct.load(this._materialKey);m.sdf=!0,this._bitset=(t.alignment===K.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=m.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[i,r]=at(t.scaleInfo,e);return new wr(t,i,r)}async analyze(t,e,i,r){const n=e.readLegacyFeature(),a=Tn(this._cimTextLayer,n,i,r),o=await super.analyze(t,e,i,r,Ke(a));return o?.glyphMosaicItems&&this._textToGlyphs.set(a,o.glyphMosaicItems),o}bindFeature(t,e,i){const r=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((a,o)=>{this[o]=a(r,e,i)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/Hi,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=Ni(this._horizontalAlignment??"center"),this._yAlignD=Ui(this._verticalAlignment??"baseline");const n=this._textToGlyphs.get(this._text)??[];this.bindTextInfo(n,!1)}};class j extends vr(Rt){constructor(t,e,i,r,n,a,o,h,l,c,u,f,d,m,_,p){super(),this._effects=m||void 0;const y=H.load(t);e&&(y.sdf=e.sdf,y.pattern=!0,y.textureBinding=e.textureBinding),this.fillColor=i,this.tl=r,this.br=n,this.aux21=M(a,o),this.aux22=M(h,l),this.aux3=P(c,u,f,0),this._bitset=d,this._minMaxZoom=M(Math.round(_*E),Math.round(p*E)),this._materialKey=y.data}static fromCIMFill(t,e,i){const r=t.color,n=r&&$(r)||0,a=t.materialKey,[o,h]=at(t.scaleInfo,i);let l=(t.colorLocked?it:0)|(t.applyRandomOffset?tr:0)|(t.sampleAlphaOnly?ie:0)|(t.hasUnresolvedReplacementColor?er:0);if(!e)return new j(a,null,n,0,0,0,0,0,0,0,0,0,l,t.effects,o,h);const{rect:c,width:u,height:f}=e,d=t.scaleX||1,m=c.x+k,_=c.y+k,p=m+u,y=_+f,x=v(t.height);let g=d*x;t.cim.type==="CIMHatchFill"&&(g*=u/f);let b=x;b<=0&&(b=y-_),b<tt&&(b*=W,l|=Ht),b=Math.round(b);let w=g;w<=0&&(w=p-m),w<tt&&(w*=W,l|=Yt),w=Math.round(w);const T=v(t.offsetX||0),z=v(-t.offsetY||0),I=M(m,_),Y=M(p,y);return new j(a,e,n,I,Y,w,b,T,z,W,W,ve(t.angle),l,t.effects,o,h)}static fromSimpleFill(t,e,i=!1){const{color:r}=t,n=r&&t.style!=="esriSFSNull"&&O(r)||0;let a=i?it:0;const o=t.materialKey;let h;if(e){const{rect:l,width:c,height:u,pixelRatio:f}=e,d=l.x+k,m=l.y+k,_=d+c,p=m+u,y=M(d,m),x=M(_,p);let g=c/f;g<tt&&(g*=W,a|=Yt),g=Math.round(g);let b=u/f;b<tt&&(b*=W,a|=Ht),b=Math.round(b),h=new j(o,e,n,y,x,g,b,0,0,W,W,0,a,null,N,U)}else h=new j(o,null,n,0,0,0,0,0,0,0,0,0,a,null,N,U);return h._maybeAddLineTemplate(t),h}static fromPictureFill(t,e,i=!1){const r=Qi,{rect:n,width:a,height:o}=e,h=n.x+k,l=n.y+k,c=h+a,u=l+o,f=M(h,l),d=M(c,u);let m=i?it:0,_=v(t.width);_<tt&&(_*=W,m|=Yt),_=Math.round(_);let p=v(t.height);p<tt&&(p*=W,m|=Ht),p=Math.round(p);const y=v(t.xoffset),x=v(-t.yoffset),g=t.materialKey,b=new j(g,e,r,f,d,_,p,y,x,W*t.xscale,W*t.yscale,0,m,null,N,U);return b._maybeAddLineTemplate(t),b}}let In=class{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=Er()}release(){const t=this._resolver;this._resolver=null,t?.resolve()}};async function Pn(s,t,e){try{await s.acquire(),await t(e),s.release()}catch(i){throw s.release(),i}}const $n={marker:S.MARKER,fill:S.FILL,line:S.LINE,text:S.TEXT};let Cn=class{constructor(t,e,i,r){const n={minScale:e?.minScale,maxScale:e?.maxScale},a=En(n);this.layers=t,this.data=e,this.hash=this._createHash()+a,this.rendererKey=i;const o={isOutline:!1,placement:null,symbologyType:A.DEFAULT,vvFlags:i};for(const h of t){const l=$n[h.type];o.isOutline=h.type==="line"&&h.isOutline,h.materialKey=he(l,o),h.maxVVSize=r,h.scaleInfo=n,h.templateHash+=a}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}};function En(s){return s.minScale||s.maxScale?s.minScale+"-"+s.maxScale:""}const Bi=async(s,t,e)=>{const i=new Yr(e,t);return new Cn(await i.analyzeSymbolReference(s.data,!1),s.data,s.rendererKey,s.maxVVSize)};async function X(s,t,e,i){if(!s)return null;if(s.type==="cim")return Bi(s,t,e);if(s.type==="web-style"){const{fetchCIMSymbolReference:r}=await ke(()=>import("./webStyleUtils-f1e3550f.js"),["./webStyleUtils-f1e3550f.js","./index-8b5e7d9b.js","./index-5447a158.css"],import.meta.url),n={type:"cim",data:await r(s,null,i)??void 0,rendererKey:s.rendererKey,maxVVSize:s.maxVVSize};return Bi(n,t,e)}return s}function Ut(s){if(!s)return null;const{avoidSDFRasterization:t,type:e,cim:i,url:r,materialHash:n,maxVVSize:a}=s,o={cim:i,type:e,mosaicHash:n,url:r,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:t};switch(e){case"marker":a&&"size"in i&&(i.size=Math.max(a,i.size)),o.size=s.size,o.path=s.path,o.animatedSymbolProperties=s.animatedSymbolProperties;break;case"line":o.dashTemplate=s.dashTemplate;break;case"text":o.text=s.text,o.fontName=s.fontName}return o}const R=wt.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Fi={sortKey:null,templates:new Array},Ge={isOutline:!1,placement:null,symbologyType:A.DEFAULT,vvFlags:0},Wn={...Qe,hash:JSON.stringify(Qe),materialKey:he(S.MARKER,Ge)},Vn={...Je,hash:JSON.stringify(Je),materialKey:he(S.LINE,Ge)},kn={...ti,hash:JSON.stringify(ti),materialKey:he(S.FILL,Ge)};function q(s,t){const e=s.length;return s.push(null),t.then(i=>s[e]=i),s}function $t(s){return s!=null&&!!(1&s)}function An(s){return s.name==="worker:port-closed"}class Rn{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new In,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e,i=null){this._initErrorTemplates();const r=t.hash,n=this._symbolToTemplate.get(r);if(n!=null)return n;const a=new Array,o={sortKey:i,templates:a};e&&this._createMeshTemplates(a,e,!0),this._createMeshTemplates(a,t,!1);const h=this._createGroupId(t.type==="expanded-cim"&&Bn(t));return this._idToTemplateGroup.set(h,o),this._symbolToTemplate.set(r,h),h}getTemplateGroup(t){return this._idToTemplateGroup.get(t)??Fi}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?($t(t)||R.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):Fi}getMosaicItem(t,e){const i=this._createTemplateId(),r=new Promise(n=>this._idToResolver.set(i,n));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),r}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?Pn(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],kn,!1),marker:this._createMeshTemplates([],Wn,!1),line:this._createMeshTemplates([],Vn,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then(()=>this._fetchResource(e,t).then(r=>{for(const{id:n,mosaicItem:a}of r)this._idToResolver.get(n)(a),this._idToResolver.delete(n)})).catch(r=>{Ae(r)?this._fetchQueue=this._fetchQueue.concat(e):An(r)||R.error(new St("mapview-template-store","Unable to fetch requested texture resources",r))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,R)?It.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,R)?It.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return F(i,R)?j.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return F(i,R)?j.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return F(i,R)?Ce.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return F(e,R)?It.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return Le.fromText(t,e??[])}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(Ut(t),Ke(t.text));return F(e,R)?Le.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ut(t));return F(e,R)?j.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ut(t));return F(e,R)?Ce.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ut(t));return F(e,R)?It.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;let i=this._cimTemplateCache.get(e);if(i!=null)return i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(e,i),i}async _createDynamicCIM(t){const e=t.templateHash;let i=this._cimTemplateCache.get(e);if(i!=null)return i;switch(t.type){case"marker":i=Ln.fromCIMMarker(t,this._tileInfo);break;case"line":i=bn.fromCIMLine(t,this._tileInfo);break;case"fill":i=Mn.fromCIMFill(t,this._tileInfo);break;case"text":i=zn.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return q(t,this._createSMS(e));case"esriPMS":return q(t,this._createPMS(e));case"esriSFS":return q(t,this._createSFS(e,i));case"line-marker":return q(t,this._createLMS(e));case"esriPFS":return q(t,this._createPFS(e,i));case"esriSLS":return q(t,this._createSLS(e,!1));case"esriTS":return q(t,this._createTS(e));default:return R.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(e.type.includes("3d"))return R.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const r of e.layers)typeof r.materialHash=="function"?q(t,this._createDynamicCIM(r)):q(t,this._createCIM(r));return t}if(e.type==="composite-symbol"){for(const r of e.layers)this._createPrimitiveMeshTemplates(t,r,i);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,i)}}const Bn=s=>{if(!s.layers)return!1;for(const t of s.layers)if(typeof t.materialHash=="function")return!0;return!1};class Fn{constructor(t,e,i){this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){t.mesh.labels!=null&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const i=new Map;if(t.type==="simple"){for(const r of t.classes){const n=Qt.fromLabelClass(r,e);i.set(r.index,n)}return i}for(const r in t.classes){const n=t.classes[r];for(const a of n){const o=Qt.fromLabelClass(a,e);i.set(a.index,o)}}return i}get templates(){return this._templateStore}async analyze(t,e,i,r,n,a,o){if(Ye(o))return;let h;i?.type==="dictionary"&&(h=await i.analyze(this._idField,t.copy(),e,n,a,o));let l=0;for(;t.next();){let c=null;if(c=h?h[l++]:r!=null&&Xi(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?r.match(this._idField,t,this._geometryType,n,a):i.match(this._idField,t,this._geometryType,n,a),t.setGroupId(c),$t(c)){const u=this._templateStore.getDynamicTemplateGroup(c).templates;for(const f of u)f&&f.analyze&&f.analyze(this._templateStore,t,n,a)}}return await je(),this._templateStore.finalize(o)}async analyzeGraphics(t,e,i,r,n,a){if(Ye(a))return;const o=t.getCursor();for(i&&await i.analyze(this._idField,o.copy(),e,r,n,a);o.next();){let h=o.getGroupId();if(h!=null&&h!==-1||(h=i?.match(this._idField,o,o.geometryType,r,n),o.setGroupId(h)),$t(h)){const l=this._templateStore.getDynamicTemplateGroup(h).templates;for(const c of l)c&&c.analyze&&c.analyze(this._templateStore,o,r,n)}o.setGroupId(h)}return await je(),this._templateStore.finalize(a)}writeGraphic(t,e,i,r){const n=e.getGroupId(),a=e.getDisplayId(),o=this._templateStore.getTemplateGroup(n);if(t.featureStart(e.insertAfter,0),a!=null){if($t(n))for(const h of o.templates)h&&h.bindFeature(e,null,null);if(o){for(const h of o.templates)h&&h.write(t,e,i,r);t.featureEnd()}}}writeCursor(t,e,i,r,n,a,o){const h=e.getGroupId(),l=e.getDisplayId(),c=this._templateStore.getTemplateGroup(h),u=c.templates,f=this._getSortKeyValue(e,c);if(t.featureStart(0,f),l!=null&&u){if($t(h))for(const d of u)d.bindFeature(e,i,r);for(const d of u)d.write(t,e,n,o);if(u.length&&a!=null){const d=a&&this._findLabelRef(u);this._writeLabels(t,e,a,d,n,o)}t.featureEnd()}}_getSortKeyValue(t,e){const i=this._schema.mesh.sortKey;if(i==null)return 0;let r=0;return r=i.byRenderer===!0&&e.sortKey!=null?e.sortKey:i.fieldIndex!=null?t.getComputedNumericAtIndex(i.fieldIndex):i.field!=null?t.readAttribute(i.field):t.readAttribute(this._idField),r*=i.order==="asc"?1:-1,r==null||isNaN(r)?0:r}_findLabelRef(t){for(const e of t)if(e instanceof It)return e;return null}_writeLabels(t,e,i,r,n,a){for(const o of i)if(o!=null&&o){const{glyphs:h,rtl:l,index:c}=o,u=this._labelTemplates.get(c);if(!u)continue;u.setZoomLevel(n),u.bindReferenceTemplate(r),u.bindTextInfo(h,l),u.write(t,e,null,a)}}}const Ee=wt.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function We(s,t,e,i){switch(s.type){case"simple":case"heatmap":return nt.fromBasicRenderer(s,t,e,i);case"map":return Ne.fromUVRenderer(s,t,e,i);case"interval":return Ze.fromCBRenderer(s,t,e,i);case"dictionary":return Ue.fromDictionaryRenderer(s,t,e,i);case"pie-chart":return te.fromPieChartRenderer(s,t,e,i);case"subtype":return te.fromSubtypes(s,t,e,i)}}class nt{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i,r){const n=new nt;if(t.symbol){const a=await X(t.symbol,i,r),o=e.createTemplateGroup(a,null);n.setDefault(o)}return n}static async fromPieChartRenderer(t,e,i,r){const n=new nt;if(t.markerSymbol){const a=await X(t.markerSymbol,i,r);let o;t.fillSymbol&&(o=await X(t.fillSymbol,i,r));const h=e.createTemplateGroup(a,o);n.setDefault(h)}return n}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,r,n){return this.getDefault()}async analyze(t,e,i,r,n,a){return null}}class te extends nt{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,i,r){const n=new Map,a=[];for(const o in t.renderers){const h=parseInt(o,10),l=We(t.renderers[o],e,i,r).then(c=>n.set(h,c));a.push(l)}return await Promise.all(a),new te(n,t.subtypeField)}match(t,e,i,r,n){const a=e.readAttribute(this._subtypeField),o=this._subMatchers.get(a);return o?o.match(t,e,i,r,n):null}}class Ze extends nt{constructor(t,e,i,r){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=r,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i,r){const{isMaxInclusive:n,normalizationField:a,normalizationTotal:o,normalizationType:h}=t,l=t.field,c=new Ze(l,n,{normalizationField:a,normalizationTotal:o,normalizationType:h},t.fieldIndex),u=await X(t.backgroundFillSymbol,i,r);await Promise.all(t.intervals.map(async d=>{const m=await X(d.symbol,i,r),_=e.createTemplateGroup(m,u),p={min:d.min,max:d.max};c.add(p,_)}));const f=await X(t.defaultSymbol,i,r);if(f){const d=e.createTemplateGroup(f,u);c.setDefault(d)}return c}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((i,r)=>i.interval.min-r.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,i,r,n){if(this._fieldIndex==null&&!this._field)return this.getDefault();const a=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(a==null||isNaN(a)||a===1/0||a===-1/0)return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:h,result:l}=this._intervals[o],c=a>=h.min,u=this._isMaxInclusive?a<=h.max:a<h.max;if(c&&u)return l}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:i,normalizationTotal:r,normalizationType:n}=this._normalizationInfo,a=t.readAttribute(i)??1;if(n)switch(n){case"esriNormalizeByField":return a?e/a:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/r*100;default:return void Ee.error(`Found unknown normalization type: ${n}`)}else Ee.error("Normalization is required, but no type was set!")}}class Ne extends nt{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i,r){const n=t.fieldDelimiter,a=[t.field];t.field2&&a.push(t.field2),t.field3&&a.push(t.field3);const o=await X(t.backgroundFillSymbol,i,r),h=new Ne(a,n,t.fieldIndex);await Promise.all(t.map.map(async(c,u)=>{const f=await X(c.symbol,i,r),d=u+1,m=e.createTemplateGroup(f,o,d);c.value==="<Null>"?h.setNullResult(m):h.add(c.value,m)}));const l=await X(t.defaultSymbol,i,r);if(l){const c=Number.MAX_SAFE_INTEGER,u=e.createTemplateGroup(l,o,c);h.setDefault(u)}return h}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,r,n){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const a=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(a==null||a===""||a==="<Null>"))return this._nullResult;if(a==null)return this.getDefault();const o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const r=t.readAttribute(i);r==null||r===""?e.push("<Null>"):e.push(r)}return e.join(this._seperator)}}async function On(s,t){const e=s||1;if(typeof e=="number")return(r,n,a)=>e;const i=await kr(e,t.spatialReference,t.fields);return(r,n,a)=>Ar(i,r,{$view:a},t.geometryType,n)||1}let _e;async function Dn(){return _e||(_e=ke(()=>import("./createSymbolSchema-4eff3afc.js"),["./createSymbolSchema-4eff3afc.js","./cimAnalyzer-96adb123.js","./index-8b5e7d9b.js","./index-5447a158.css","./labelPoint-fc5dd920.js","./TileClipper-ae6eca9e.js","./definitions-5359da6f.js","./number-e491b09e.js","./BidiEngine-9a40f2f4.js","./enums-9d4f5c11.js","./diffUtils-3ed1f592.js","./Pipeline-71977f9f.js","./QueryEngine-03d16de6.js","./WhereClause-4988664d.js","./TimeOnly-a96593b0.js","./json-48e3ea08.js","./QueryEngineCapabilities-85c4f1d0.js","./utils-4576de5f.js","./heatmapUtils-3c0e0ece.js","./utils-e24aed40.js","./generateRendererUtils-1c8bce12.js","./FieldsIndex-85e142d0.js","./StreamFeatureManager-8348c744.js","./quickselect-fc5bb707.js","./ogcFeatureUtils-e3521781.js","./geojson-ede2d4c1.js","./date-430969b3.js","./clientSideDefaults-7259c628.js","./defaultsJSON-59981e75.js","./query-ae6e69b4.js","./pbfQueryUtils-0854066b.js","./pbf-97a34880.js","./queryZScale-9dee68ff.js","./Query-630c5d65.js","./createConnection-2daa0cd5.js","./geohashUtils-77d8429b.js","./tileUtils-7ee960ba.js","./TurboLine-f24b8fe3.js","./Rect-98da58d6.js","./GeometryUtils-0258f920.js"],import.meta.url)),_e}class Ue extends nt{constructor(t,e,i,r,n,a){super(),this.type="dictionary",this._groupIdCache=new Wr(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=r,this._schemaUtilsModule=n,this._symbolOptions=a}static async fromDictionaryRenderer(t,e,i,r){const[{DictionaryLoader:n},a]=await Promise.all([ke(()=>import("./DictionaryLoader-1a1ab2cc.js"),["./DictionaryLoader-1a1ab2cc.js","./index-8b5e7d9b.js","./index-5447a158.css","./FieldsIndex-85e142d0.js"],import.meta.url),Dn()]),o=new n(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const h=await On(t.scaleExpression,i);return new Ue(o,e,i,h,a,t.symbolOptions)}async _analyzeFeature(t,e,i,r,n){const a=t.readLegacyFeature(),o=this._scaleFn(a,i,r),h=this._attributeHash(a)+"-"+o,l=this._groupIdCache.get(h);if(l)return l;const c={...r,spatialReference:this._info.spatialReference,abortOptions:n,fields:this._info.fields},u=await this._loader.getSymbolAsync(a,c),f=this._schemaUtilsModule.createSymbolSchema(u,this._symbolOptions),d=X(f,this._info,e,n).then(m=>{if(m?.type!=="expanded-cim")return Ee.error(new St("mapview-bad-type",`Found unexpected type ${m?.type} in dictionary response`)),null;m.hash+="-"+o;for(const _ of m.layers)_.scaleFactor=o,_.templateHash+="-"+o;return this._templates.createTemplateGroup(m,null)});return this._groupIdCache.put(h,d,1),d}async analyze(t,e,i,r,n,a){const o=e.getCursor(),h=[];for(;o.next();)h.push(this._analyzeFeature(o,i,r,n,a));return Promise.all(h).then(l=>l.filter(Vr))}match(t,e,i,r,n){return null}_attributeHash(t){let e="";for(const i of this._symbolFields){const r=this._fieldMap?.[i];r&&(e+=t.attributes[r]+"-")}return e}}class Kn{constructor(t){this._remoteClient=t,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}async fetchResource(t,e){const i=this._resourceMap,r=i.get(t);if(r)return r;let n=this._inFlightResourceMap.get(t);if(n)return n;try{n=this._remoteClient.invoke("tileRenderer.fetchResource",{url:t},{...e}),this._inFlightResourceMap.set(t,n),n.then(a=>(this._inFlightResourceMap.delete(t),i.set(t,a),a))}catch(a){return Ae(a)?null:{width:0,height:0}}return n}getResource(t){return this._resourceMap.get(t)??null}loadFont(t){return Promise.resolve(null)}}function Oi(s,t){const e=t-t/2,i=t+t/4;return(!s.minScale||s.minScale>=e)&&(!s.maxScale||s.maxScale<=i)}function Di(s){const t=s.message,e={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(const i in t.data){const r=i,n=t.data[r];if(e.message.data[r]=null,n!=null){const a=n.stride,o=n.indices.slice(0),h=n.vertices.slice(0),l=n.records.slice(0),c=n.metrics?.slice(0),u={stride:a,indices:o,vertices:h,records:l,metrics:c};e.transferList.push(o,h,l),e.message.data[r]=u}}return e}let Ve=class extends hs{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new Kn(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(s){this._bufferIds.forEach(t=>{t.forEach(s)})}async update(s,t){const e=t.schema.processors[0];if(e.type!=="symbol")return;const i=qr(this._schema,e);(qe(i,"mesh")||qe(i,"target"))&&(s.mesh=!0,s.why?.mesh.push("Symbology changed"),this._schema=e,this._factory=this._createFactory(e),this._factory.update(e,this.tileStore.tileScheme.tileInfo))}onTileMessage(s,t,e,i){return Lt(i),this._onTileData(s,t,e,i)}onTileClear(s,t){const e={clear:!0,end:t};return this._bufferData.delete(s.key.id),this._bufferIds.delete(s.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:s.id,data:e})}onTileError(s,t,e){const i=e.signal,r={tileKey:s.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",r,{signal:i})}onTileUpdate(s){for(const t of s.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of s.added)this._bufferData.forEach(e=>{for(const i of e)i.message.tileKey===t.id&&this._updateTileMesh("append",t,Di(i),[],!1,!1,null)})}_addBufferData(s,t){this._bufferData.has(s)||this._bufferData.set(s,[]),this._bufferData.get(s)?.push(Di(t))}_createFactory(s){const{geometryType:t,objectIdField:e,fields:i}=this.service,r=(l,c)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",l,c),n={geometryType:t,fields:i,spatialReference:Fr.fromJSON(this.spatialReference)},a=new Rn(r,this.tileStore.tileScheme.tileInfo),{matcher:o,aggregateMatcher:h}=s.mesh;return this._store=a,this._matchers.feature=We(o,a,n,this._resourceManagerProxy),this._matchers.aggregate=h?We(h,a,n,this._resourceManagerProxy):null,new Fn(t,e,a)}async _onTileData(s,t,e,i){Lt(i);const{type:r,addOrUpdate:n,remove:a,clear:o,end:h}=t,l=!!this._schema.mesh.sortKey;if(!n){const u={type:r,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:s.id,data:u},i)}const c=this._processFeatures(s,n,e,i,t.status?.version);try{const u=await c;if(u==null){const d={type:r,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:s.id,data:d},i)}const f=[];for(const d of u){let m=!1;const _=d.message.bufferIds,p=s.key.id,y=d.message.tileKey;if(p!==y&&_!=null){if(!this.tileStore.get(y)){this._addBufferData(p,d),f.push(d);continue}let x=this._bufferIds.get(y);x||(x=new Set,this._bufferIds.set(y,x));const g=Array.from(_);for(const b of g){if(x.has(b)){m=!0;break}x.add(b)}}m||(this._addBufferData(p,d),f.push(d))}await Promise.all(f.map(d=>{const m=s.key.id===d.message.tileKey,_=m?t.remove:[],p=m&&t.end;return this._updateTileMesh(r,s,d,_,p,!!t.clear,i.signal)}))}catch(u){this._handleError(s,u,i)}}async _updateTileMesh(s,t,e,i,r,n,a){const o=s,h=e.message.tileKey,l=!!this._schema.mesh.sortKey;h!==t.key.id&&(r=!1);const c=e?.message,u={type:o,addOrUpdate:c,remove:i,clear:n,end:r,sort:l},f={transferList:e?.transferList??[],signal:a};return Lt(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:h,data:u},f)}async _processFeatures(s,t,e,i,r){if(t==null||!t.hasFeatures)return null;const n={transform:s.transform,hasZ:!1,hasM:!1},a=this._factory,o={viewingMode:"",scale:s.scale},h=await this._matchers.feature,l=await this._matchers.aggregate;Lt(i);const c=this._getLabelInfos(s,t);return await a.analyze(t.getCursor(),this._resourceManagerProxy,h,l,n,o),Lt(i),this._writeFeatureSet(s,t,n,c,a,e,r)}_writeFeatureSet(s,t,e,i,r,n,a){const o=t.getSize(),h=this._schema.mesh.matcher.symbologyType,l=new Ss(s.key.id,{features:o,records:o,metrics:0},h,n,h!==A.HEATMAP,a),c={viewingMode:"",scale:s.scale},u=t.getCursor();for(;u.next();)try{const d=u.getDisplayId(),m=i!=null?i.get(d):null;r.writeCursor(l,u,e,c,s.level,m,this._resourceManagerProxy)}catch{}const f=s.tileInfoView.tileInfo.isWrappable;return l.serialize(f)}_handleError(s,t,e){if(!Ae(t)){const i={tileKey:s.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:e.signal})}return Promise.resolve()}_getLabelingSchemaForScale(s){const t=this._schema.mesh.labels;if(t==null)return null;if(t.type==="subtype"){const i={type:"subtype",classes:{}};let r=!1;for(const n in t.classes){const a=t.classes[n].filter(o=>Oi(o,s.scale));r=r||!!a.length,i.classes[n]=a}return r?i:null}const e=t.classes.filter(i=>Oi(i,s.scale));return e.length?{type:"simple",classes:e}:null}_getLabels(s,t){if(t.type==="subtype"){const e=this.service.subtypeField;Or(e,"Expected to find subtype Field");const i=s.readAttribute(e);return i==null?[]:t.classes[i]??[]}return t.classes}_getLabelInfos(s,t){const e=this._getLabelingSchemaForScale(s);if(e==null)return null;const i=new Map,r=t.getCursor();for(;r.next();){const n=r.getDisplayId(),a=[],o=Xi(n),h=o&&r.readAttribute("cluster_count")!==1?"aggregate":"feature",l=this._getLabels(r,e);for(const c of l){if(c.target!==h)continue;const u=r.getStorage(),f=o&&h==="feature"?u.getComputedStringAtIndex(r.readAttribute("referenceId"),c.fieldIndex):u.getComputedStringAtIndex(n,c.fieldIndex);if(!f)continue;const d=ye(f.toString()),m=d[0],_=d[1];this._store.getMosaicItem(c.symbol,Ke(m)).then(p=>{a[c.index]={glyphs:p.glyphMosaicItems??[],rtl:_,index:c.index}})}i.set(n,a)}return i}};Ve=Rr([Br("esri.views.2d.layers.features.processors.SymbolProcessor")],Ve);const Gn=Ve,va=Object.freeze(Object.defineProperty({__proto__:null,default:Gn},Symbol.toStringTag,{value:"Module"}));export{ca as A,va as S,ar as _,he as f};
