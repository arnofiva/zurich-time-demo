import{bh as $,jt as G,ch as H,aP as U,jC as S,ah as a,ai as o,ak as g,ao as v,aB as k,gw as J,mw as L,am as M,bm as z,mx as Y,bA as K,da as W,aL as C,aR as P,aY as N,bU as D,bF as T,bv as Q,hy as X,mp as V,my as ee,mq as A,mz as te,mA as re,mB as q,mC as R,av as _,mD as se,aI as b,ag as j,aH as ie,mE as ae,aQ as oe}from"./index-70a1e848.js";import{I as ne,E as le,T as ue}from"./FeatureLikeLayerView3D-72eddda9.js";import{n as ce}from"./LayerView3D-a480bbae.js";import{E as de,c as pe}from"./query-329b2ac1.js";import{r as he}from"./EventedSet-cf12acd8.js";import{o as Z}from"./floorFilterUtils-73949d2d.js";import{p as E,n as ye}from"./popupUtils-85d853d6.js";import{u as me}from"./LayerView-fa72efbb.js";import{a as fe}from"./RefreshableLayerView-ea970069.js";class ge{constructor(r){this._controller=r,this._handle=new we(e=>r.schedule(e))}destroy(){this._handle.destroy()}invoke(r,e){return r.buffer&&r.buffer.byteLength!==0?(r.options.sourceSpatialReference&&r.options.sourceSpatialReference instanceof $&&(r.options={...r.options,sourceSpatialReference:r.options.sourceSpatialReference.toJSON()}),this._handle.invoke(r,e).then(s=>{let i=0,u=0;const d=$.fromJSON(s.spatialReference);s.spatialReference=d;const l=async c=>{if(s.fields){for(;i<s.fields.length;)if(s.fields[i]=H.fromJSON(s.fields[i]),i++,c.madeProgress())return this._controller.reschedule(n=>l(n))}for(;u<s.features.length;){const n=s.features[u];if(++u,n.uid=U.generateUID(),n.geometry!=null&&(n.geometry.spatialReference=d,Fe(n.geometry),c.madeProgress()))return this._controller.reschedule(h=>l(h))}return s};return this._controller.schedule(c=>l(c))})):Promise.resolve(null)}}function Fe(t){switch(t.type){case"polyline":t.paths.reduce((r,e)=>r+e.length,0)<S&&(t.paths=t.hasZ||t.hasM?t.paths.map(r=>r.map(e=>[e[0],e[1],e[2]])):t.paths.map(r=>r.map(e=>[e[0],e[1]])));break;case"polygon":t.rings.reduce((r,e)=>r+e.length,0)<S&&(t.rings=t.hasZ||t.hasM?t.rings.map(r=>r.map(e=>[e[0],e[1],e[2]])):t.rings.map(r=>r.map(e=>[e[0],e[1]])))}}let we=class extends G{constructor(r){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},r)}},f=class extends v{constructor(t){super(t)}get queryFeaturesDehydrated(){const t=this.layer.capabilities,r=t&&t.query,e=r&&r.supportsFormatPBF,s=this.layer.parsedUrl;if(e){this._decoder==null&&(this._decoder=new ge(this.controller));const i={sourceSpatialReference:this.layer.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeLength:1024};return(u,d)=>de(s,u,"pbf",this._createRequestOptions(d)).then(l=>(k(d),this._decoder!=null?this._decoder.invoke({buffer:l.data,options:i},d.signal):Promise.reject(J())))}return(i,u)=>pe(s,i,this.layer.spatialReference,this._createRequestOptions(u)).then(d=>L(d.data))}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}destroy(){this._decoder=M(this._decoder)}_createRequestOptions(t){return{...t,query:{...this.layer.customParameters,token:this.layer.apiKey,...t?.query}}}};a([o({constructOnly:!0})],f.prototype,"layer",void 0),a([o({constructOnly:!0})],f.prototype,"controller",void 0),a([o({readOnly:!0})],f.prototype,"queryFeaturesDehydrated",null),f=a([g("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],f);let F=class extends v{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.layer.queryFeatures(t,r)}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}};a([o({constructOnly:!0})],F.prototype,"layer",void 0),a([o({readOnly:!0})],F.prototype,"queryFeaturesDehydrated",null),F=a([g("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],F);let x=class extends v{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.layer.queryFeatures(t,r)}};a([o({constructOnly:!0})],x.prototype,"layer",void 0),x=a([g("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],x);let w=class extends v{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.source.queryFeaturesJSON(t,r).then(L,e=>{if(e&&e.name==="query-features-json:unsupported")return this.layer.queryFeatures(t,r);throw e})}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}};function be(t,r){return t.type==="feature"&&t.source.type==="feature-layer"?t.infoFor3D!=null?new F({layer:t}):new f({layer:t,controller:r}):t.type==="feature"&&t.source.type==="memory"||t.type==="csv"||t.type==="geojson"||t.type==="oriented-imagery"||t.type==="wfs"?new w({layer:t,source:t.source}):t.type==="ogc-feature"?new x({layer:t}):null}a([o({constructOnly:!0})],w.prototype,"layer",void 0),a([o({constructOnly:!0})],w.prototype,"source",void 0),w=a([g("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],w);class _e{constructor(r){this._memoryCache=null,this._capabilities=null;const e=r.layerView.layer;this._layerView=r.layerView,this.objectIdField=e.objectIdField,this.globalIdField="globalIdField"in e?e.globalIdField:null,this._returnZ=r.returnZ,this._returnM=r.returnM;const s=this._layerView.view.resourceController;this.query=be(e,s.normal),s&&this._memoryCacheEnabled&&(this._memoryCache=s.memoryController.newCache(`fl-${e.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=M(this._memoryCache),this.query.destroy()}createQuery(){const r=this._layerView.layer.createQuery();return r.outFields=this._layerView.availableFields,r.returnZ=this._returnZ,r.returnM=this._returnM,r.outSpatialReference=this.tilingScheme.spatialReference,r}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){const r=this._layerView.view.resourceController;return r?r.scheduler:null}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return this._capabilities!=null||(this._capabilities=ne(this._layerView.layer)),this._capabilities}logFetchError(r,e){r.error("#fetchTile()",this._layerView.layer,e?.message??e)}}const B="esri.views.layers.FeatureLayerView",O=z.getLogger(B),xe=t=>{let r=class extends t{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([C(()=>{const e=this.layer;return[e?.elevationInfo?.featureExpressionInfo,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),P),N(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),N(()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:e,layer:{fieldsIndex:s},requiredFields:i}=this;return"outFields"in e&&e.outFields?D(s,[...T(s,e.outFields),...i]):D(s,i)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){O.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=this.filter!=null?this.filter.createQuery(e):new Q(e);if(this.layer.type==="feature"){const i=Z(this);i!=null&&(s.where=s.where?`(${s.where}) AND (${i})`:i)}return this.timeExtent!=null&&(s.timeExtent=s.timeExtent!=null?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new Q(e)}queryFeatures(e,s){throw new Error("missing implementation")}queryObjectIds(e,s){throw new Error("missing implementation")}queryFeatureCount(e,s){throw new Error("missing implementation")}queryExtent(e,s){throw new Error("missing implementation")}async fetchPopupFeatures(e,s){const i=this.validateFetchPopupFeatures(s);if(i)throw i;return this.fetchClientPopupFeatures(s)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(s=>s.type==="expression")?X():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then(()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=this.view.type==="3d",{layer:s,layer:{fieldsIndex:i,objectIdField:u}}=this,d="renderer"in s&&s.renderer,l="orderBy"in s&&s.orderBy,c="featureReduction"in s?s.featureReduction:null,n=new Set,h=await Promise.allSettled([d?d.collectRequiredFields(n,i):null,V(n,s),e?ee(n,s):null,this.filter!=null?A(n,s,this.filter):null,this.featureEffect!=null?A(n,s,this.featureEffect.filter):null,c?te(n,s,c):null,l?re(n,s,l):null]);if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&q(n,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),s.type==="feature"&&(s.floorInfo&&q(n,s.fieldsIndex,[s.floorInfo.floorField]),e&&s.infoFor3D!=null&&(s.globalIdField==null&&O.error("globalIdField missing on 3DObjectFeatureLayer"),q(n,s.fieldsIndex,[s.globalIdField]))),s.type==="subtype-group"){R(n,i,s.subtypeField);const y=s.sublayers.map(I=>Promise.all([I.renderer?.collectRequiredFields(n,i),V(n,I)]));await Promise.allSettled(y)}for(const y of h)y.status==="rejected"&&O.error(y.reason);R(n,i,u),e&&"displayField"in s&&s.displayField&&R(n,i,s.displayField);const m=Array.from(n).sort();this._set("requiredFields",m)}validateFetchPopupFeatures(e){if(e==null)return null;for(const s of e.clientGraphics??[]){const i=s.layer;if("popupEnabled"in i&&!i.popupEnabled)return new _("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if(s.isAggregate){const u="featureReduction"in i?i.featureReduction:null;if(!(u&&"popupTemplate"in u&&u.popupEnabled&&u.popupTemplate))return new _("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i})}else if("popupTemplate"in i&&!E(i,e))return new _("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}async fetchClientPopupFeatures(e){const s=e!=null?e.clientGraphics:null;if(!s||s.length===0)return[];const i=new Array(s.length),u=new Map,d=await this.createPopupQuery(e);for(let l=0;l<s.length;l++){const c=s[l];if(c.isAggregate){i[l]=c;continue}const n=c.layer;if(!("popupEnabled"in n))continue;const h=T(this.layer.fieldsIndex,d.outFields),m=E(n,e);if(m==null)continue;const y=await this._loadArcadeModules(m);y&&y.arcadeUtils.hasGeometryOperations(m)||!se(h,c)?u.set(c.getObjectId(),{graphic:c,index:l}):i[l]=c}if(this.layer.type==="stream"||u.size===0)return i.filter(Boolean);d.objectIds=Array.from(u.keys());try{const l=await this.layer.queryFeatures(d);for(const c of l.features){const{graphic:{geometry:n},index:h}=u.get(c.getObjectId());c.geometry||(c.geometry=n),i[h]=c}}catch{}return i.filter(Boolean)}async createPopupQuery(e){const s=this.layer.createQuery(),i=new Set;let u=!1;const d=e?.clientGraphics?e.clientGraphics.map(l=>l.layer):[this.layer];for(const l of d){if(!("popupEnabled"in l))continue;const c=E(l,e);if(c==null)continue;const n=await this._loadArcadeModules(c),h=n&&n.arcadeUtils.hasGeometryOperations(c);u=!(this.layer.geometryType!=="point"&&!h);const m=await ye(this.layer,c);for(const y of m)i.add(y)}if(s.returnGeometry=u,s.returnZ=u,s.returnM=u,s.outFields=Array.from(i),s.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const l=Z(this);l!=null&&(s.where=s.where?`(${s.where}) AND (${l})`:l)}return s}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}};return a([o()],r.prototype,"_updatingRequiredFieldsPromise",void 0),a([o({readOnly:!0})],r.prototype,"availableFields",null),a([o({readOnly:!0})],r.prototype,"dataUpdating",void 0),a([o({type:Y})],r.prototype,"featureEffect",null),a([o({type:K})],r.prototype,"filter",void 0),a([o(W)],r.prototype,"timeExtent",void 0),a([o()],r.prototype,"layer",void 0),a([o({type:Number})],r.prototype,"maximumNumberOfFeatures",null),a([o({readOnly:!0,type:Boolean})],r.prototype,"maximumNumberOfFeaturesExceeded",null),a([o({readOnly:!0})],r.prototype,"requiredFields",void 0),a([o()],r.prototype,"suspended",void 0),a([o()],r.prototype,"view",void 0),r=a([g(B)],r),r};let p=class extends fe(le(xe(ce(me)))){constructor(t){super(t),this._controllerTotal=0,this._processorTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(C(()=>this._updatingRequiredFieldsPromise,t=>this._updatingHandles.addPromise(t),P))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=M(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(t){this._set("maximumNumberOfFeatures",t),this.controller&&(this.controller.maximumNumberOfFeatures=t)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let t=0;if(this.controller?.updating){const e=this.controller.updatingRemaining,s=Math.max(this.controller.updatingTotal,this._controllerTotal);s>0&&(t=(s-e)/s,this._controllerTotal=s)}let r=0;if(this.processor?.updating){const e=this.processor.updatingRemaining,s=Math.max(e,this._processorTotal);s>0&&(r=(s-e)/s,this._processorTotal=s)}return .5*(t+r)}get updatePolicy(){if(!this.controller)return b.ASYNC;switch(this.controller.mode){case"snapshot":{const t=ve.get(this.layer.geometryType);return t==null||this.controller.serviceDataCount>t?b.ASYNC:b.SYNC}case"tiles":return b.ASYNC}}get hasZ(){const t=this.layer,r=t.capabilities&&t.capabilities.data;return!(!r||!r.supportsZ)&&("returnZ"in t&&t.returnZ!=null?t.returnZ:r.supportsZ)}get hasM(){const t=this.layer,r=t.capabilities&&t.capabilities.data;return!(!r||!r.supportsM)&&"returnM"in t&&t.returnM!=null&&t.returnM}setVisibility(t,r){this.processor?.setObjectIdVisibility(t,r)}createQuery(){return super.createQuery()}queryFeatures(t,r){const e=()=>super.queryFeatures(t,r);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(t),e):e()}beforeSetController(t){t.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this._fetcherContext=new _e({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const t=new ue({layerView:this,context:this._fetcherContext,graphics:new he,extent:this.clippingExtent});return this._updatingHandles.add(()=>t.serviceDataExtent,r=>{this.processor&&(this.processor.dataExtent=r)},j),this.addHandles(C(()=>this.suspended,r=>{r?t.suspend():t.resume()},P)),this._updatingHandles.add(()=>this.processor?.displayFeatureLimit,r=>t.displayFeatureLimit=r,j),this.addHandles(ie(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),t}async doRefresh(t){t&&!this.suspended&&this.controller&&this.controller.refetch(),this.processor.refreshFilter()}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const t=this.processor?.unprocessedMemoryEstimate??0,r=this.controller?.expectedFeatureDiff??0,e=this.processor?.loadedFeatures??0,s=e+r>0?e/(e+r):1;return t+r*(this.processor?.usedMemoryPerFeature??0)*s}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(t,r){await this._validateQueryFeaturesMesh(t);const e=await r();if(t?.outStatistics||this.graphics3DProcessor==null)return e;const s=this.layer.objectIdField,i=this.graphics3DProcessor.graphics3DGraphicsByObjectID,u=[];for(const d of e.features)if(d.geometry){const l=i.get(d.attributes[s]);l&&(d.geometry=ae(l.graphic.geometry),u.push(d))}else u.push(d);return e.features=u,e}async _validateQueryFeaturesMesh(t){if(!t)return;const r=s=>{throw new _("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${s}'`)},e=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const s of e)t[s]!=null&&r(s);"returnM"in t&&t.returnM&&r("returnM"),"returnCentroid"in t&&t.returnCentroid&&r("returnCentroid"),t.outSpatialReference==null||t.outSpatialReference.equals(this.view.spatialReference)||r("outSpatialReference")}get performanceInfo(){const t=this.controller?.displayFeatureLimit,r=t?.averageSymbolComplexity,e=r!=null?`f:${r.verticesPerFeature},v:${r.verticesPerCoordinate}`:"n/a";return{...this._getResourceInfo(),partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?.mode??"n/a",symbolComplexity:e,nodes:this.controller?.tileDescriptors.length??0,...this.controller?.performanceInfo??{storedFeatures:0,totalVertices:0}}}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:this.controller?.graphics}}};a([o()],p.prototype,"layer",void 0),a([o()],p.prototype,"controller",void 0),a([o()],p.prototype,"_controllerTotal",void 0),a([o()],p.prototype,"_processorTotal",void 0),a([o()],p.prototype,"maximumNumberOfFeatures",null),a([o()],p.prototype,"maximumNumberOfFeaturesExceeded",null),a([o(oe)],p.prototype,"updatingProgress",void 0),a([o({readOnly:!0})],p.prototype,"updatingProgressValue",null),a([o({readOnly:!0})],p.prototype,"updatePolicy",null),a([o({readOnly:!0})],p.prototype,"hasZ",null),a([o({readOnly:!0})],p.prototype,"hasM",null),a([o()],p.prototype,"suspendResumeExtentMode",void 0),p=a([g("esri.views.3d.layers.FeatureLayerViewBase3D")],p);const ve=new Map([["point",5e3],["polygon",500],["polyline",1e3]]),Ne=p;export{Ne as _};
