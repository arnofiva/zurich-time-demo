import{hv as zr,aC as Hr,nh as Vr,ni as Ir,b7 as Gr,w9 as kr,bc as qt,it as gt,bh as te,bj as g,wa as Nr,wb as Fr,gl as A,l0 as b,qX as jr,pv as vi,nB as Si,gm as wi,hC as D,bf as he,n$ as R,q2 as Vn,k_ as st,bg as is,gn as In,is as k,pE as et,wc as Pi,hQ as Re,ow as Wt,ah as u,ai as f,ak as H,ao as J,wd as an,aY as se,aH as S,aN as N,gS as qr,bi as Gn,bD as X,nv as ss,nt as Ur,pD as rs,qe as as,k$ as ze,hD as $t,pN as Ee,bX as Zr,ag as rt,we as Wr,bV as pe,i5 as En,kZ as w,pR as Br,oo as os,l1 as ls,kT as P,kY as fe,lx as q,ce as tt,oX as Ze,on as I,kW as Ie,sx as On,a_ as Yr,a$ as Ae,b0 as bi,sy as kn,lB as Xr,oY as Qr,ix as Jr,m5 as cs,ox as fn,p6 as nt,kV as vt,b1 as ds,iy as xi,p0 as Kr,op as ea,p2 as ta,p3 as na,p4 as ia,b3 as Cn,oW as Xe,hE as Nn,lZ as sa,lY as _e,m7 as $i,n8 as mn,hZ as us,n7 as Tt,nI as B,md as ps,iB as ye,cG as hs,pI as Bt,dT as Fn,wf as ra,ms as aa,wg as oa,aX as la,nc as fs,kP as gn,hd as Mi,wh as ca,tg as Ei,hV as da,jt as Oi,aG as Mt,ti as St,nA as Et,tj as _t,wi as Tn,qZ as ua,tp as ms,to as pa,wj as ha,wk as fa,wl as ma,wm as Ci,wn as Dn,nH as gs,nJ as _n,na as ga,wo as Ti,wp as _a,wq as _s,dO as ya,dG as va,wr as Sa,pK as He,ws as wa,wt as Pa,rJ as ba,wu as xa,wv as $a,m$ as Ma,ww as yn,af as ys,wx as Ea,gp as Oa,ay as vn,dh as Ca,d4 as Ta,ax as Dt,wy as Da,q_ as vs,dg as Ra,aI as wt,e6 as Di,f3 as Aa,aQ as La,aT as jn,wz as za,bt as Ss,q9 as ws,aP as Pt,kE as qn,n0 as Rn,aS as Ps,n6 as bs,nw as Yt,am as Un,aD as Zn,wA as An,mb as Ha,ka as Va,wB as Ia,su as Ga,ky as ka,wC as xs,m3 as Na,m4 as Fa,wD as ja,sA as pt,nx as qa,nz as Ua}from"./index-8b5e7d9b.js";import{b as $s,u as Fe,s as Za,r as Wa,a as Ba}from"./LineVisualElement-fc7385d7.js";import{t as M,r as Ya,u as Xa}from"./LengthDimension-aec24abc.js";import{m as We,e as Qa,f as Ja,u as V,g as Ka,h as eo}from"./Segment-ec50fd17.js";import{i as to,f as Ms}from"./unitFormatUtils-4b3497b3.js";import{$ as on,w as no,e as me,D as Es,d as Ot,M as Wn,O as Rt,R as Bn,F as io,U as Os,j as Ri,a as so,b as ro,v as ao,l as oo}from"./analysisViewUtils-d9ecfeae.js";import{F as lo,H as Cs,A as Yn,l as co}from"./Factory-9cf1118b.js";import{g as Ts}from"./ImageMaterial-0b6c45d0.js";import{c as uo,y as O,Z as Ds,d as po}from"./elevationInfoUtils-25b84599.js";import{r as Xt,t as Rs}from"./vec4f32-0d1b2306.js";import{t as As,z as ho}from"./RightAngleQuadVisualElement-f61633a8.js";import{c as fo,x as Ai}from"./PointVisualElement-8a3927d0.js";import{b as mo}from"./Query-630c5d65.js";import{a as z,v as go,L as Sn,m as _o,V as yo,p as vo,w as So}from"./EditGeometryOperations-aafb8f81.js";import{d as Ut}from"./FeatureFilter-5ab88729.js";import{o as wo}from"./floorFilterUtils-73949d2d.js";import{r as Po}from"./dehydratedFeatureComparison-43e0df71.js";function bo(n){const e=zr(n),t=e===Vr?Ir:e;return Hr(n,t)?t:n}var it;function xo(n,e){const{spatialReference:t}=n;return Gr(t,e.spatialReference)?(At[0]=n.x,At[1]=n.y,At[2]=n.hasZ?n.z:0,Lt[0]=e.x,Lt[1]=e.y,Lt[2]=e.hasZ?e.z:0,Ls(At,Lt,t)):null}function Ls(n,e,t){const i=$o(n,e,t,it.Direct);return i!=null?to(i.direct,i.unit):null}function $o(n,e,t,i){const s=bo(t),r=kr(s);if(r==null)return null;const a=e[2]-n[2];if(i===it.Vertical)return{verticalSigned:a,unit:r};if(!qt(n,t,wn,s)||!qt(e,t,zt,s))return null;if(i===it.Direct)return{direct:gt(zt,wn),unit:r};if(te(Ht,n[0],n[1],e[2]),!qt(Ht,t,Ht,s))return null;const l=gt(Ht,zt);return i===it.Horizontal?{horizontal:l,unit:r}:{direct:gt(zt,wn),horizontal:l,vertical:Math.abs(a),unit:r}}(function(n){n[n.Direct=0]="Direct",n[n.Horizontal=1]="Horizontal",n[n.Vertical=2]="Vertical"})(it||(it={}));const At=g(),Lt=g(),wn=g(),zt=g(),Ht=g();function Mo(n,e,t){if(n==null)return null;const i=n.dimensionSegment.startRenderSpace,s=n.dimensionSegment.endRenderSpace,r=Ls(i,s,n.spatialReference);if(r==null)return null;const a=e===M.Vertical?Nr(r.value,r.unit,t):Fr(r.value,r.unit,t);return Ms(r,a)}function Qt(n){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,dimension:{offset:i,measureType:s,orientation:r}}=n;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:s,orientation:r}}function Jt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e,offset:t,measureType:i,orientation:s},r,a=null){if(n==null||e==null)return null;const l=Hs(a!=null?a.directSegment:new We,{elevationAlignedStartPoint:n,elevationAlignedEndPoint:e},r),o=a!=null?a.primaryOffsetAxis:g();ln(o,{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const c=a!=null?a.dimensionSegment:new We;return Xn({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e})&&i===M.Vertical?(A(c.startRenderSpace,l.startRenderSpace),A(c.endRenderSpace,l.endRenderSpace)):Vs(c,{offsetAxis:o,offset:t,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:c,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function Li(n,e,t,i){return e===bt.Start?(A(n.startRenderSpace,t.startRenderSpace),A(n.endRenderSpace,i.startRenderSpace)):(A(n.startRenderSpace,t.endRenderSpace),A(n.endRenderSpace,i.endRenderSpace)),n}var bt;function Eo(n,e,t,i){k(n.startRenderSpace,e.startRenderSpace,t,i),k(n.endRenderSpace,e.endRenderSpace,t,i)}function zs(n,e,t,i){switch(e){case M.Direct:return Hs(n,t,i);case M.Horizontal:case M.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=t;let o;a.measureType===M.Direct?(o=Oo(l,i)===s.z>r.z,e===M.Horizontal&&(o=!o)):o=!Co(l);const[c,d]=o?[s,r]:[r,s],p=et(d,To);return e===M.Horizontal?p.z=c.z:(p.x=c.x,p.y=c.y),i.toRenderCoords(c,n.startRenderSpace),i.toRenderCoords(p,n.endRenderSpace),n}}}function Hs(n,e,t){return t.toRenderCoords(e.elevationAlignedStartPoint,n.startRenderSpace),t.toRenderCoords(e.elevationAlignedEndPoint,n.endRenderSpace),n}function Oo(n,e){const t=n.directSegment.eval(.5,b.get()),i=e.worldUpAtPosition(t,b.get()),s=n.dimensionSegment.eval(.5,b.get()),r=D(b.get(),s,t);return!Vn(r,st)&&R(r,i)>0}function Co(n){const{startRenderSpace:e,endRenderSpace:t}=n.dimensionSegment,{startRenderSpace:i,endRenderSpace:s}=n.directSegment;return Pi(i,e)<Pi(s,t)}(function(n){n[n.Start=0]="Start",n[n.End=1]="End"})(bt||(bt={}));const To=Re(0,0,0,null);function Do(n,e,t,i){const{directSegment:s}=t,r=ln(b.get(),{measureType:e,directSegment:s,renderCoordsHelper:i}),a=Vs(Ro,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:i}).eval(.5,b.get()),l=D(b.get(),n,a);return R(l,r)*i.unitInMeters}const Ro=new We;function ln(n,e){const{measureType:t,elevationAlignedStartPoint:i,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,c=l.eval(.5,b.get()),d=o.worldUpAtPosition(c,b.get()),p=o.worldBasisAtPosition(c,jr.Y,b.get());switch(t){case M.Horizontal:A(n,d);break;case M.Vertical:R(r,d)<R(a,d)?D(n,a,r):D(n,r,a),he(n,n,d),he(n,n,d);break;case M.Direct:{const h=e.orientation??0;if(Xn({elevationAlignedStartPoint:i,elevationAlignedEndPoint:s}))vi(Vt,-Si(h),d),wi(n,p,Vt);else{const m=D(b.get(),a,r),_=he(b.get(),m,d);he(_,_,m),vi(Vt,Si(h),m),wi(n,_,Vt)}break}}return Vn(n,st)?A(n,p):is(n,n)}const Vt=In();function Xn({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e}){return n!=null&&e!=null&&n.x===e.x&&n.y===e.y}function Vs(n,e){const{offsetAxis:t,offset:i,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=i/l.unitInMeters,[c,d]=Ao(s,r,t,o);return k(n.startRenderSpace,a.startRenderSpace,t,c),k(n.endRenderSpace,a.endRenderSpace,t,d),n}function Ao(n,e,t,i=0){const s=R(e,t),r=R(n,t),a=Math.abs(s-r)+i;return s>r?[a,i]:[i,a]}function cn(n,e,t){const i=e.directSegment.eval(.5,b.get());return t.worldUpAtPosition(i,n)}function Qn(n,e){const{startRenderSpace:t,endRenderSpace:i}=e.directSegment;return D(n,i,t)}function Jn(n,e,t={invert:!1}){const{startRenderSpace:i,endRenderSpace:s}=e.dimensionSegment;return t.invert?D(n,i,s):D(n,s,i)}function Ln(n,e){const t=n.directSegment.eval(.5,b.get());return e.headingAtPosition(t,n.primaryOffsetAxis)}function Lo(n,e){return Wt(Jn(zo,n))/e**2}const zo=g();function Is(n){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=n;if(e==null||t==null)return!1;const i=xo(e,t);return i!=null&&Ms(i,"meters").value>Gs}const Gs=1e5;function xt(n){return n.geometry!=null}let je=class extends J{constructor(e){super(e)}initialize(){const e=an(()=>this.analysisViewData.computations,({computation:t})=>this._watchComputation(t));this.addHandles(se(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Qa(this.view)}_watchComputation(e){return S(()=>Qt(e),t=>{const{measureType:i}=t;if(Is(t)&&i!==M.Direct){const r=Math.round(qr(Gs,"meters","kilometers"));return Gn.getLogger(this).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${r} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=Jt(t,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Mo(s,i,this._defaultUnit)},N)}};u([f({constructOnly:!0})],je.prototype,"analysisViewData",void 0),u([f({constructOnly:!0})],je.prototype,"view",void 0),u([f()],je.prototype,"analysis",null),u([f()],je.prototype,"_defaultUnit",null),je=u([H("esri.views.3d.analysis.Dimension.support.DimensionController")],je);function Kt(n){return ss(n.accentColor,.5)}function Ho(n){return Ur(n.accentColor)}const ks=5,Vo=new X([127,127,127,.5]),Ns=.8,Io=4,Go=6,ko=.1,Fs=.5,No=18,Fo=2,jo=.3,qo=2,Uo=.25,Zo=20,Wo=5,zi=5,Hi=10,Bo=2500,Yo=50,Xo=2;class Qo{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of Ya)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case M.Direct:return this.direct;case M.Horizontal:return this.horizontal;case M.Vertical:return this.vertical}}}class Jo extends on{constructor(e,t){const i=no(X.toUnitRGBA(Kt(e.effectiveTheme))),s=[new me(as(i,1,32,32),Oe)];super({view:e,renderObjects:s,metadata:t.metadata,available:!1,grabCursor:"crosshair",radius:ks,collisionPriority:1}),this._themeHandle=S(()=>({color:X.toUnitRGBA(Kt(e.effectiveTheme))}),r=>i.setParameters(r))}destroy(){this._themeHandle.remove(),super.destroy()}}function Ko(n,e){const t=[q(-.5,0,0),q(.5,0,0)],i=ze(e.unfocusedMaterial,t.map(r=>$t(g(),r,Fs))),s=i.instantiate({material:e.focusedMaterial});return new on({view:n,renderObjects:[new me(i,Ee.Unfocused|Ee.Selected|Oe),new me(s,Ee.Focused|Oe)],collisionType:{type:"line",paths:[t]},radius:Kn(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Es})}class Vi extends on{constructor(e,{lineSizePt:t,material:i,metadata:s}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:s}),this._options={calloutColor:Zr(),lineSizePt:t,material:i},this._themeHandle=S(()=>X.toUnitRGBA(Kt(e.effectiveTheme)),r=>{this._options.calloutColor=r,Gi(this,Ii({...this._options,metadata:this.metadata}))},rt)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,Gi(this,Ii({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Ii({calloutColor:n,lineSizePt:e,material:t,metadata:i}){return{calloutLength:.25*Wr*Ns*pe(e)+No,calloutColor:n,calloutWidth:Fo,customStateMask:Oe,discScale:jo,focusMultiplier:qo,material:t,metadata:i}}function el(n,e){const t=[q(-.5,0,0),q(.5,0,0)],i=ze(e.thinOffsetManipulatorMaterial,t),s=ze(e.unfocusedMaterial,t.map(a=>$t(g(),a,Fs))),r=s.instantiate({material:e.focusedMaterial});return new on({view:n,renderObjects:[new me(s,Ee.Unfocused|Oe),new me(r,Ee.Focused|Oe),new me(i,Oe)],collisionType:{type:"line",paths:[t]},radius:Kn(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Es})}function tl(n,{isStart:e,createSnappingPipelineStep:t,dimension:i,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[Ot(n,(o,c,d,p)=>{const h=Yn(o),{snappingStep:m,cancelSnapping:_}=t(p);d=d.next(h).next(Bn(i,[a,"measureType","orientation"])).next(_),c.next(h).next(lo(r)).next(...m).next(y=>{const v=et(y.mapEnd,new tt);s(a==="startPoint"?{startPoint:v}:{endPoint:v})})})]}function nl(n,{computation:e,view:t}){return[Ot(n,(i,s,r)=>{if(!xt(e)||!i.selected)return;const{geometry:a,dimension:l}=e,o=Yn(i);s.next(o).next(qs(t,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(Bn(l,["offset"]))})]}function il(n,{computation:e,view:t}){return[Ot(n,(i,s,r)=>{js({cancel:r,computation:e,settingHeading:!0,steps:s,view:t})})]}function sl(n,{computation:e,view:t}){return[Ot(n,(i,s,r)=>{js({cancel:r,computation:e,settingHeading:!1,steps:s,view:t})}),n.events.on("immediate-click",i=>{rl(i,e,t)})]}function rl(n,e,t){const{dimension:i,geometry:s}=e;if(i.orientation===90||i.orientation===270)return i.orientation=0,void n.stopPropagation();if(s==null)return;const{renderCoordsHelper:r}=t,a=Jt({...Qt(e),orientation:90},r),l=Jt({...Qt(e),orientation:270},r);if(a==null||l==null)return;const o=Ln(a,r),c=Ln(l,r),d=Us(s,t),p=En.shortestSignedDiff(d,o),h=En.shortestSignedDiff(d,c);i.orientation=Math.abs(p)<Math.abs(h)?90:270,n.stopPropagation()}function js(n){const{cancel:e,computation:t,settingHeading:i,steps:s,view:r}=n;if(!xt(t))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=t,c=g(),d=Ws(g(),o,o.directSegment,a),p=Bs(b.get(),{forHeading:i,geometry:o,renderCoordsHelper:a}),h=Ze(d,p,I()),m=i?l.orientation??Ln(o,r.renderCoordsHelper):l.orientation??0;s.next(Cs(r,h)).next(_=>{_.action==="start"&&A(c,_.renderStart);const y=kn(h),v=io(c,_.renderEnd,d,y);let C=m-Xr(v);i||(C=al(C)),l.orientation=C}),e.next(Bn(l,["orientation"]))}function al(n){const e=En.normalize(n)%90;return e<zi?n-e:90-e<zi?n+(90-e):n}function ol(n,{computation:e,manipulatorMeasureType:t,view:i}){let s=M.Direct,r=0,a=0;return[n.events.on("grab-changed",l=>{if(l.action!=="start"||!xt(e))return;const{dimension:o,geometry:c}=e;s=o.measureType,r=o.offset,a=o.orientation;const d=A(b.get(),n.renderLocation);o.measureType=t,o.offset=Do(d,t,c,i.renderCoordsHelper),o.orientation=0}),Ot(n,(l,o,c)=>{if(!xt(e))return;const{geometry:d,dimension:p}=e,{renderCoordsHelper:h}=i,m=zs(Ys,t,e,h),_=ln(b.get(),{measureType:t,directSegment:d.directSegment,renderCoordsHelper:h}),y=Yn(l);o.next(y).next(qs(i,p,m,_)),c.next(y).next(v=>(p.measureType=s,p.offset=r,p.orientation=a,v))})]}function qs(n,e,t,i){const s=Ie(b.get(),t.endRenderSpace,t.startRenderSpace);he(s,s,i);const r=Ze(t.startRenderSpace,s,I()),a=Ze(t.startRenderSpace,i,I()),l=e.offset;let o,c=0;const d=new Os;return d.next(Cs(n,r)).next(p=>{p.action==="start"&&(c=On(a,p.renderStart));const h=(On(a,p.renderEnd)-c)*n.renderCoordsHelper.unitInMeters;e.offset=l+h,o=p}),p=>(d.execute(p),o)}function Us(n,e){const{directSegment:t}=n,{renderCoordsHelper:i}=e,s=cn(b.get(),n,i),r=Qn(b.get(),n),a=he(b.get(),r,s),{viewForward:l}=e.state.camera;R(a,l)>0&&$t(a,a,-1);const o=t.eval(.5,b.get());return i.headingAtPosition(o,a)}function ll(n,e,t){const{dimensionSegment:i,primaryOffsetAxis:s}=e,r=Jn(yt,e),a=w(r,st)?Br(en):Wn(r,s,st,en),l=Math.max(os(r),ko/t.unitInMeters);ls(a,a,te(yt,l,l,l)),n.modelTransform=a,n.renderLocation=i.eval(.5,yt)}function cl(n,e,t){Zs(n,e,t,{forHeading:!0})}function dl(n,e,t){Zs(n,e,t,{forHeading:!1})}function Zs(n,e,t,{forHeading:i}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=$t(ul,a,s.offset>=0?1:-1),o=Bs(pl,{forHeading:i,geometry:r,renderCoordsHelper:t});he(o,o,l);const c=Wn(l,o,st,en);n.modelTransform=c,n.renderLocation=Ws(yt,r,r.dimensionSegment,t)}const ul=g(),pl=g();function hl(n,e,t,i){const{geometry:s}=e,r=zs(Ys,t,e,i),a=ln(yt,{measureType:t,directSegment:s.directSegment,renderCoordsHelper:i}),l=D(Pn,r.endRenderSpace,r.startRenderSpace),o=Wn(l,a,st,en),c=os(l);ls(o,o,te(Pn,c,c,c)),n.modelTransform=o,n.renderLocation=r.eval(.5,Pn)}function Ws(n,e,t,i){const{startRenderSpace:s,endRenderSpace:r}=t,a=fl(e,i)?s:r;return A(n,a)}function Bs(n,{forHeading:e,geometry:t,renderCoordsHelper:i}){return e?cn(n,t,i):Jn(n,t,{invert:!0})}function fl(n,e){const t=Qn(ml,n),i=cn(gl,n,e);return R(t,i)>0}const ml=g(),gl=g();function _l(n){return pe(n)+Io}function Kn(n){return pe(n)+Go}function Gi(n,e){const t=e.material??new Ts({transparent:!0,writeDepth:!1,textureId:e.texture?.id,renderOccluded:P.Opaque,isDecoration:!0}),i=e.focusMultiplier??Rt.focusMultiplier,s=e.calloutLength??Rt.calloutLength,r=Rt.discRadius*(e.discScale??1),a=r*i,l=(m,_)=>{const y=[0,1,2,2,3,0];return new Yr(_,[[Ae.POSITION,new bi([s-m,-m,0,s+m,-m,0,s+m,m,0,s-m,m,0],y,3,!0)],[Ae.UV0,new bi([0,0,1,0,1,1,0,1],y,2,!0)]])},o=e.calloutWidth??Rt.calloutWidth,c=new fe({width:o,color:e.calloutColor,renderOccluded:P.OccludeAndTransparent,isDecoration:!0}),d=ze(c,[[0,0,0],[s-r,0,0]]),p=ze(c,[[0,0,0],[s-a,0,0]]),h=e.customStateMask??rs.None;n.collisionType={type:"disc",direction:[0,0,1],offset:[s,0,0]},n.focusMultiplier=i,n.metadata=e.metadata,n.radius=r,n.renderObjects=[new me(l(r,t),Ee.Unfocused|h),new me(d,Ee.Unfocused|h),new me(l(a,t),Ee.Focused|h),new me(p,Ee.Focused|h)]}const Oe=rs.Custom1,yt=g(),Pn=g(),en=In(),Ys=new We;function yl(n){let e,t,i=[],s=!1;function r(...a){return s&&e===this&&vl(a,i)||(t=n.apply(this,a),e=this,i=a,s=!0),t}return r}function vl(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;++t)if(n[t]!==e[t])return!1;return!0}var ee;function Sl(n,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:n.elevationAlignedStartPoint,elevationAlignedEndPoint:n.elevationAlignedEndPoint,geometry:n.geometry}}function wl(n,e){if(Is(n))return ee.Direct;if(!n.enabled)return null;const{geometry:t}=n;if(t==null||w(t.directSegment.startRenderSpace,t.directSegment.endRenderSpace))return null;const{camera:i}=e.state,s=cn(b.get(),t,e.renderCoordsHelper),r=Qn(b.get(),t),a=$t(b.get(),s,R(r,s)),l=Ie(b.get(),r,a),o=Wt(l),c=Wt(a),{startRenderSpace:d,endRenderSpace:p}=t.directSegment,h=Math.max(i.computeScreenPixelSizeAt(d)*Hi,i.computeScreenPixelSizeAt(p)*Hi)**2;return o<h?ee.Vertical:c<h?ee.Horizontal:null}function Pl(n,e,{constraint:t,view:i}){const{unconstrainedGeometry:s}=n;if(s==null)return;const{renderCoordsHelper:r,spatialReference:a}=i,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,c=r.fromRenderCoords(l,new tt,a),d=r.fromRenderCoords(o,new tt,a);let p;p=e==="start"?{startPoint:c}:{endPoint:d},Xs(n,p,{constraint:t,elevationAlignedStartPoint:n.elevationAlignedStartPoint,elevationAlignedEndPoint:n.elevationAlignedEndPoint,unconstrainedGeometry:s,view:i})}function Xs(n,e,t){const{constraint:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=t,{dimension:o,previousConstraint:c,preConstraintProperties:d}=n;if(s==null||r==null)return;const p=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(i==null)p(),c!=null&&d!=null&&(o.measureType=d.measureType,o.orientation=d.orientation);else switch(o.measureType=M.Direct,i){case ee.Horizontal:if(i!==c&&(o.orientation=0),"startPoint"in e){const h=e.startPoint;h!=null&&(h.z=r.z),o.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.z=s.z),o.endPoint=h}break;case ee.Vertical:if(i!==c&&(o.orientation=Us(a,l)),"startPoint"in e){const h=e.startPoint;h!=null&&(h.x=r.x,h.y=r.y),o.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.x=s.x,h.y=s.y),o.endPoint=h}break;case ee.Direct:i!==c&&d!=null&&(o.orientation=d.orientation),p()}n.previousConstraint=i,n.unconstrainedGeometry=a}(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.Direct=2]="Direct"})(ee||(ee={}));let bl=class extends As{constructor(e){super(e),this._ray=cs(),this._isWorldDown=!1,this._start=g(),this._end=q(1,0,0),this._width=1,this._color=Xt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Xt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=ie.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=P.OccludeAndTransparent,this._fadedExtensions=Fi,this._laserline=new fo({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,A(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Ie(this._end,e,this._end),fn(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,w(this._start,e)||(A(this._start,e),fn(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,w(this._end,e)||(A(this._end,e),fn(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){nt(e,this._color)||(vt(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){nt(e,this._innerColor)||(vt(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&nt(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Rs(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===P.OccludeAndTransparentStencil?P.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??Fi,this.recreateGeometry()}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new fe(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_destroyExternalResources(e){e.geometries=[]}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const s=this._createGeometry(e);i.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new fe(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new ds(t)}_createGeometry(e){const t=this.extensionType===ie.FADED,i=t?[g(),g(),g(),g()]:[g(),g()];return ze(e,i,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===ie.FADED?this._updateLineSegmentFinite(ki):this._updateLineSegmentInfinite(this._extensionType,ki)}_updateLineSegmentFinite(e){return xi(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(Kr(this._ray,Ce),e){case ie.LINE:Ce.c0=-Number.MAX_VALUE;break;case ie.RAY:case ie.GROUND_RAY:{const a=this._ray.origin,l=this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&ea(Ce.ray.direction,Ce.ray.direction),this._extensionType===ie.GROUND_RAY&&l!=null&&(Ce.c1=Math.abs(o-l));break}}if(!ta(i.frustum,Ce))return this._updateLineSegmentFinite(t);const s=na(Ce,Ge),r=ia(Ce,xl);return xi(s,r,t)}_updateVertexAttributesObject3D(e,t){const i=e.geometries[0].getMutableAttribute(Ae.POSITION)?.data;if(!i)return;let s=0;for(const r of this._lineVertices(t))i[s++]=r[0],i[s++]=r[1],i[s++]=r[2];e.geometryVertexAttributeUpdated(e.geometries[0],Ae.POSITION)}_updateVertexAttributesDraped(e,t){const i=e.getMutableAttribute(Ae.POSITION)?.data;if(!i)return;let s=0;for(const r of this._lineVertices(t))i[s++]=r[0],i[s++]=r[1],i[s++]=Cn;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===ie.FADED?(yield Xe(e,-this.fadedExtensions.start,Ge),yield Xe(e,0,Ge),yield Xe(e,1,Ge),yield Xe(e,1+this.fadedExtensions.end,Ge)):(yield Xe(e,0,Ge),yield Xe(e,1,Ge))}};const Ce=Qr(),Ge=g(),xl=g(),ki=Jr();var ie;(function(n){n[n.LINE=0]="LINE",n[n.RAY=1]="RAY",n[n.GROUND_RAY=2]="GROUND_RAY",n[n.FADED=3]="FADED"})(ie||(ie={}));const Ni=1/3,Fi={start:Ni,end:Ni};let $l=class extends As{constructor(e){super(e),this._location=g(),this._direction=q(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Xt(1,0,1,1),this._renderOccluded=P.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){w(this._location,e)||(A(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){w(this._direction,e)||(A(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){is(this._direction,Ie(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){nt(e,this._color)||(vt(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new fe(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const[s,r]=this._createGeometries(e);t.addGeometry(s),t.addGeometry(r),i.push(s),i.push(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new fe(this.materialParameters),t=S(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[]}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map(i=>new ds(i))}_createGeometries(e){return[ze(e,[g(),g()]),ze(e,[g(),g()])]}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Gt),Nn(oe,this.location,this.direction),t.projectToScreen(oe,Qe),sa(Qe,_e(Qe,Qe,Gt)),this._updateVertexAttributesObject3D(t,e,0,Gt,Qe,1),this._updateVertexAttributesObject3D(t,e,1,Gt,Qe,-1)}_updateVertexAttributesObject3D(e,t,i,s,r,a){const l=t.geometries[i],o=l.getMutableAttribute(Ae.POSITION)?.data;if(!o)return;const{start:c,end:d}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen($i(c),oe),o[0]=oe[0],o[1]=oe[1],o[2]=oe[2],e.unprojectFromScreen($i(d),oe),o[3]=oe[0],o[4]=oe[1],o[5]=oe[2],t.geometryVertexAttributeUpdated(l,Ae.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{location:s,width:r,length:a,offset:l}=this,o=Ml;o.spatialReference=t.renderer.spatialReference,o.x=s[0],o.y=s[1];const c=this.view.overlayPixelSizeInMapUnits(o)*i,d=r*c,p=a*c,h=l*c;this._updateVertexAttributesDraped(e[0],d,p,h,-1),this._updateVertexAttributesDraped(e[1],d,p,h,1)}_updateVertexAttributesDraped(e,t,i,s,r){const a=e.getMutableAttribute(Ae.POSITION)?.data;if(!a)return;const{location:l,direction:o}=this,{start:c,end:d}=this._computeStartEnd(o,l,r,s,t,i);a[0]=c[0],a[1]=c[1],a[2]=Cn,a[3]=d[0],a[4]=d[1],a[5]=Cn,e.invalidateBoundingInfo()}_computeStartEnd(e,t,i,s,r,a){const l=mn(ji,us(ji,e[1]*i,e[0]*-i),s+r/2),o=Tt(It,Tt(It,Tt(It,t,mn(It,e,a/2)),l),l);return{start:o,end:Tt(qi,o,mn(qi,e,-a))}}};const oe=g(),ji=B(),It=B(),qi=B(),Gt=ps(),Qe=ps(),Ml=Re(0,0,void 0,null);function El(n,e,t){return q(n,e,t)}function yd(n){return n}function Ve(n,e,t){return q(n,e,t)}function at(n){return ye(n)}function $(n,e,{coordinateHelper:t,elevationInfo:i}){return n?ft(t.vectorToDehydratedPoint(n,Ol),e,i):null}function ft(n,e,t){if(n==null)return null;if(e==null)return q(n.x,n.y,n.z??0);if(e.type==="2d")return q(n.x,n.y,0);const i=uo(e,n,t,O)??0;return q(n.x,n.y,i)}function Ui(n,e){return Re(n[0],n[1],n[2],e)}const Ol=Re(0,0,0,null);let re=class extends hs{constructor(){super(...arguments),this.enabled=!0}};u([f({type:Boolean})],re.prototype,"enabled",void 0),re=u([H("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],re);let x=class extends hs{constructor(e){super(e),this.lineSnapper=new re,this.parallelLineSnapper=new re,this.rightAngleSnapper=new re,this.rightAngleTriangleSnapper=new re,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new X([255,127,0]),this.orangeTransparent=new X([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};u([f({type:re,constructOnly:!0,nonNullable:!0,json:{write:!0}})],x.prototype,"lineSnapper",void 0),u([f({type:re,constructOnly:!0,nonNullable:!0,json:{write:!0}})],x.prototype,"parallelLineSnapper",void 0),u([f({type:re,constructOnly:!0,nonNullable:!0,json:{write:!0}})],x.prototype,"rightAngleSnapper",void 0),u([f({type:re,constructOnly:!0,nonNullable:!0,json:{write:!0}})],x.prototype,"rightAngleTriangleSnapper",void 0),u([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],x.prototype,"shortLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],x.prototype,"distance",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],x.prototype,"pointThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],x.prototype,"intersectionParallelLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],x.prototype,"parallelLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],x.prototype,"verticalLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],x.prototype,"touchSensitivityMultiplier",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],x.prototype,"pointOnLineThreshold",void 0),u([f({type:X,nonNullable:!0})],x.prototype,"orange",void 0),u([f({type:X,nonNullable:!0})],x.prototype,"orangeTransparent",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],x.prototype,"lineHintWidthReference",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],x.prototype,"lineHintWidthTarget",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],x.prototype,"lineHintFadedExtensions",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],x.prototype,"parallelLineHintWidth",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],x.prototype,"parallelLineHintLength",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],x.prototype,"parallelLineHintOffset",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],x.prototype,"rightAngleHintSize",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],x.prototype,"rightAngleHintOutlineSize",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],x.prototype,"satisfiesConstraintScreenThreshold",void 0),x=u([H("esri.views.interactive.snapping.Settings.Defaults")],x);const T=new x;var L;(function(n){n[n.FEATURE=1]="FEATURE",n[n.SELF=2]="SELF",n[n.ALL=3]="ALL"})(L||(L={}));const Zi={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Wi={toggle:"Control"};function Be(n,e){const t=n.x-e.x,i=n.y-e.y;return t*t+i*i}function Cl(n,e){return Math.sqrt(Be(n,e))}function ei(n,e){e.sort((t,i)=>Bt(t.targetPoint,n)-Bt(i.targetPoint,n))}var F;function wd({point:n,distance:e,returnEdge:t,vertexMode:i,coordinateHelper:{spatialReference:s},filter:r},a,l){return l=l!=null?l.clone():new mo({where:"1=1"}),r&&(l.geometry=r.geometry,l.distance=r.distance,l.spatialRelationship=r.spatialRelationship,l.where=Fn(l.where,r.where),l.timeExtent=ra(l.timeExtent,r.timeExtent),l.objectIds=Tl(l.objectIds,r.objectIds)),{point:Re(n[0],n[1],n[2],s.toJSON()),mode:a,distance:e,returnEdge:t,vertexMode:i,query:l.toJSON()}}function Tl(n,e){return n||e?e?n?Array.from(aa(new Set(n),new Set(e))):e:n:null}function tn(n,e,t){return{left:$(n.leftVertex.pos,e,t),right:$(n.rightVertex.pos,e,t)}}function Pd(n){return n.createQuery()}function Dl(n,e=()=>{}){const t=S(()=>({view:n.view,snappingOptions:n.snappingOptions}),({view:i,snappingOptions:s})=>{const r="snapping-toggle",a=oa.TOOL;if(n.removeHandles(r),i&&s!=null){const l=[i.on("key-down",o=>{o.key!==Wi.toggle||o.repeat||(s.enabledToggled=!0,e())},a),i.on("key-up",o=>{o.key===Wi.toggle&&(s.enabledToggled=!1,e())},a),i.on("pointer-move",o=>{const c=o.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},a)];n.addHandles(l,r)}},N);n.addHandles(t)}function Rl(n){return n!=null&&typeof n=="object"&&"declaredClass"in n&&n.declaredClass==="esri.WebMap"&&"utilityNetworks"in n&&!!n?.utilityNetworks?.length}(function(n){n[n.TARGET=0]="TARGET",n[n.REFERENCE=1]="REFERENCE",n[n.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(F||(F={}));let Ct=class{constructor(e,t){this.isDraped=e,this.domain=t}},Qs=class Js extends Ct{constructor(e,t,i=L.ALL){super(t,i),this.intersectionPoint=e}equals(e){return e instanceof Js&&w(this.intersectionPoint,e.intersectionPoint)}},Q=class Ks extends Ct{constructor(e,t,i,s,r=L.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=i,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof Ks&&this.type===e.type&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return gt(this.lineStart,this.lineEnd)}},er=class tr extends Ct{constructor(e,t,i,s=L.ALL){super(i,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof tr&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)}},Al=class nr extends Ct{constructor(e,t,i){super(t,i),this.point=e}equals(e){return e instanceof nr&&w(this.point,e.point)}},ti=class ir extends Ct{constructor(e,t,i,s,r=L.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=i}equals(e){return e instanceof ir&&w(this.previousVertex,e.previousVertex)&&w(this.centerVertex,e.centerVertex)&&w(this.nextVertex,e.nextVertex)}},Ll=class{draw(e,t){const i=this._getUniqueHints(e),s=this.sortUniqueHints(i),r=[];for(const a of s)a instanceof Qs&&r.push(this.visualizeIntersectionPoint(a,t)),a instanceof Q&&r.push(this.visualizeLine(a,t)),a instanceof er&&r.push(this.visualizeParallelSign(a,t)),a instanceof ti&&r.push(this.visualizeRightAngleQuad(a,t)),a instanceof Al&&r.push(this.visualizePoint(a,t));return la(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const t=[];for(const i of e){let s=!0;for(const r of t)if(i.equals(r)){s=!1;break}s&&t.push(i)}return t}},zl=class extends Ll{sortUniqueHints(e){return e.sort((t,i)=>(i instanceof Q?i.length:0)-(t instanceof Q?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:s}=t,r=ht(t);return se(new Ai({view:s,primitive:"circle",geometry:Ui(e.intersectionPoint,i),elevationInfo:e.isDraped?Ds:O,size:20,outlineSize:2,color:r.intersectionPointColor,outlineColor:r.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:s}=t,r=ht(t),a=Te(e.point,e.domain,t);return se(new Ai({view:i,primitive:"circle",geometry:Ui(a,s),elevationInfo:kt(e,t),size:20,outlineSize:2,color:r.pointColor,outlineColor:r.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:s}=t,r=ht(t),a=Te(e.lineStart,e.domain,t),l=Te(e.lineEnd,e.domain,t);return se(this._createLineSegmentHint(e.type,a,l,s,kt(e,t),i,r,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:s}=t,r=ht(t),{isDraped:a}=e,l=kt(e,t),o=Te(e.lineStart,e.domain,t),c=Te(e.lineEnd,e.domain,t),d=ke(o,s,l,i,a),p=ke(c,s,l,i,a),h=fs(p,d,p,.5),m=new $l({view:i,attached:!1,offset:T.parallelLineHintOffset,length:T.parallelLineHintLength,width:T.parallelLineHintWidth,color:r.parallelSignColor,location:h,renderOccluded:a?P.OccludeAndTransparent:P.Opaque,isDraped:a,renderGroup:gn.SnappingHint,isDecoration:!0});return m.setDirectionFromPoints(d,h),m.attached=!0,se(m)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:s}=t,r=ht(t),a=kt(e,t),{isDraped:l}=e,o=Te(e.previousVertex,e.domain,t),c=Te(e.centerVertex,e.domain,t),d=Te(e.nextVertex,e.domain,t),p=ke(o,s,a,i,l),h=ke(c,s,a,i,l),m=ke(d,s,a,i,l);return se(new ho({view:i,attached:!0,color:l?r.rightAngleColorDraped:r.rightAngleColor,renderOccluded:l?P.OccludeAndTransparent:P.Transparent,outlineRenderOccluded:l?P.OccludeAndTransparent:P.Opaque,outlineColor:r.rightAngleOutlineColor,outlineSize:T.rightAngleHintOutlineSize,size:T.rightAngleHintSize,isDraped:l,geometry:{previous:p,center:h,next:m},renderGroup:gn.SnappingHint,isDecoration:!0}))}_createLineSegmentHint(e,t,i,s,r,a,l,o=!1,c=!0,d=!0){const p=ke(t,s,r,a,o),h=ke(i,s,r,a,o),m=new bl({view:a,extensionType:ie.FADED,start:p,end:h,isDraped:o,color:l.lineColor,renderOccluded:o?P.OccludeAndTransparent:P.Opaque,renderGroup:gn.SnappingHint,isDecoration:!0});switch(e){case F.TARGET:m.width=T.lineHintWidthTarget,m.fadedExtensions={start:0,end:T.lineHintFadedExtensions};break;case F.REFERENCE_EXTENSION:m.width=T.lineHintWidthReference,m.fadedExtensions={start:0,end:0};break;case F.REFERENCE:m.width=T.lineHintWidthReference,m.fadedExtensions={start:c?T.lineHintFadedExtensions:0,end:d?T.lineHintFadedExtensions:0}}return m.attached=!0,m}};function ht(n){const{effectiveTheme:e}=n.view,t=X.toUnitRGBA(e.accentColor),i=[0,0,0,0];return{intersectionPointColor:i,intersectionPointOutlineColor:t,pointColor:i,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:X.toUnitRGBA(ss(e.accentColor,.5)),rightAngleOutlineColor:t}}function Te(n,e,t){const i=sr(e,t);return i==null?n:El(n[0],n[1],i)}function kt(n,e){return sr(n.domain,e)!=null?e.selfSnappingZ.elevationInfo:n.isDraped?Ds:O}function sr(n,{selfSnappingZ:e}){return n===L.SELF&&e!=null?e.value:null}function ke(n,e,t,i,s,r=g()){if(s){const a=i.basemapTerrain.overlayManager.renderer.spatialReference;qt(n,e,r,a)}else Ja(n,e,t,i,r);return r}function Hl(n,e,t,i,s){const r=Mi(3*n.length),a=Mi(r.length);n.forEach((c,d)=>{r[3*d]=c[0],r[3*d+1]=c[1],r[3*d+2]=c.length>2?c[2]:0});const l=ca(r,e,0,a,0,r,0,r.length/3,t,i,s),o=l!=null;return{numVertices:n.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}let Vl=class extends $s{constructor(e){super(e),this.view=null,this._renderOccluded=P.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Ei([1,127/255,0,1]),this._size=11,this._outlineColor=Ei([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){nt(e,this._color)||(vt(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){nt(e,this._outlineColor)||(vt(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,i=.5,s=Hl(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,da.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const c=te(Il,l[3*o],l[3*o+1],l[3*o+2]),d=Bi(this._vertexMaterial,t,c),p=Bi(this._vertexOutlineMaterial,i,c);r.push({vertexGeometry:d,vertexOutlineGeometry:p})}return r}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:s}of t)e.addGeometry(i),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new Ri({...this._vertexMaterialParameters,writeDepth:!0,cullFace:Oi.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new Ri({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:Oi.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Il=g();function Bi(n,e,t){return as(n,e,16,16,{offset:t})}let qe=class extends J{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};u([f({constructOnly:!0})],qe.prototype,"layer",void 0),u([f()],qe.prototype,"enabled",void 0),u([f()],qe.prototype,"updating",void 0),u([f()],qe.prototype,"availability",void 0),qe=u([H("esri.views.interactive.snapping.FeatureSnappingLayerSource")],qe);const rr=qe;let U=class extends J{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Mt,this.distance=T.distance,this.touchSensitivityMultiplier=T.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};u([f()],U.prototype,"enabled",void 0),u([f()],U.prototype,"enabledToggled",void 0),u([f()],U.prototype,"selfEnabled",void 0),u([f()],U.prototype,"featureEnabled",void 0),u([f({type:Mt.ofType(rr)})],U.prototype,"featureSources",void 0),u([f()],U.prototype,"distance",void 0),u([f()],U.prototype,"touchSensitivityMultiplier",void 0),u([f({readOnly:!0})],U.prototype,"effectiveEnabled",null),u([f({readOnly:!0})],U.prototype,"effectiveSelfEnabled",null),u([f({readOnly:!0})],U.prototype,"effectiveFeatureEnabled",null),U=u([H("esri.views.interactive.snapping.SnappingOptions")],U);const ar=U;function Gl(n,e){const t=new ar({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:e?.distance??T.distance,touchSensitivityMultiplier:e?.touchSensitivityMultiplier??T.touchSensitivityMultiplier});return{...S(()=>n.map?.allLayers?.toArray()??[],i=>{t.featureSources=new Mt(i.map(s=>new rr({layer:s,enabled:!0})))},rt),options:t}}function ni({start:n,end:e,type:t},i,s){const r=[],a=_e(Ye,e,n),l=_e(lt,n,i),o=St(a),c=2*Et(a,l),d=c*c-4*o*(St(l)-s*s);if(d===0){const p=-c/(2*o);(t===Y.PLANE||p>=0)&&r.push(_t(B(),n,a,p))}else if(d>0){const p=Math.sqrt(d),h=(-c+p)/(2*o);(t===Y.PLANE||h>=0)&&r.push(_t(B(),n,a,h));const m=(-c-p)/(2*o);(t===Y.PLANE||m>=0)&&r.push(_t(B(),n,a,m))}return r}function or(n,e){const t=n.start,i=n.end,s=_e(Ye,i,t),r=te(lt,-s[1],s[0],0),a=e.start,l=e.end,o=D(ri,l,a),c=R(o,r),d=te(gr,t[0],t[1],0),p=D(_r,d,a),h=R(p,r);if(Math.abs(c)<ge)return[];const m=k(yr,a,o,h/c);if(e.type===z.RAY){const _=D(sn,m,a);if(R(_,o)<-ge)return[]}if(n.type===Y.HALF_PLANE){const _=fa(sn,m,t);if(Et(_,s)<-ge)return[]}return[ye(m)]}function kl(n,e){return Nl(nn(ai,e[2],n),e)}function lr(n,e){const i=hr(nn(ai,0,n),nn(Zl,0,e)),s=[];for(const r of i)s.push(ma(r));return s}function cr(n,e){return ii(n,nn(ai,n[2],e))}function dr(n,e,t){const i=_e(Ye,n,e),s=t/ga(i),r=_t(g(),e,i,s);return r[2]=n[2],r}function ii(n,{start:e,end:t,type:i}){const s=D(Ye,n,e),r=D(lt,t,e),a=R(s,r)/R(r,r);return k(g(),e,r,i===z.RAY?Math.max(a,0):a)}const ur=(()=>{const n=g(),e=g(),t=g();return({start:i,end:s},{center:r,radius:a,normal:l,slicePlane:o})=>{const c=g(),d=Ze(r,l,Ul);if(E(Tn(d,i),0)&&E(Tn(d,s),0)){ua(l,n,e);const p=(_,y)=>(Ie(t,y,r),us(_,R(t,n),R(t,e)),_),h=go({start:p(mr,i),end:p(ql,s),type:z.LINE},ha,a),m=[];for(const[_,y]of h){const v=A(g(),r);k(v,v,n,_),k(v,v,e,y),o&&!Le(o,v)||m.push(v)}return m}return ms(d,i,s,c)?!E(gt(c,r),a)||o&&!Le(o,c)?[]:[c]:[]}})();function pr({start:n,end:e,type:t},i,s){const r=[],a=Ie(Ye,e,n),l=_e(lt,n,i),o=St(a),c=2*Et(a,l),d=c*c-4*o*(St(l)-s*s);if(d===0){const p=-c/(2*o);(t===z.LINE||p>=0)&&r.push(k(g(),n,a,p))}else if(d>0){const p=Math.sqrt(d),h=(-c+p)/(2*o);(t===z.LINE||h>=0)&&r.push(k(g(),n,a,h));const m=(-c-p)/(2*o);(t===z.LINE||m>=0)&&r.push(k(g(),n,a,m))}return r}function hr(n,e){const t=n.start,i=n.end,s=e.start,r=e.end,a=D(Ye,i,t),l=D(lt,r,s),o=D(ri,s,t),c=he(gr,a,l),d=R(o,c);if(!Ci(d,0,ge))return[];const p=Dn(c);if(Ci(p,0,ge))return[];const h=he(_r,o,l),m=R(h,c)/p,_=k(yr,t,a,m);if(n.type===z.RAY){const y=D(sn,_,t);if(R(a,y)<-ge)return[]}if(e.type===z.RAY){const y=D(sn,_,s);if(R(l,y)<-ge)return[]}return[ye(_)]}function Nl({start:n,end:e,type:t},i){const s=D(Ye,i,n),r=D(lt,e,n),a=he(ri,r,s);if(Dn(a)/Dn(r)<ge)switch(t){case z.LINE:return[ye(i)];case z.RAY:return R(r,s)<-ge?[]:[ye(i)]}return[]}function si(n,e,t,i){const[s,r]=n,[a,l]=t,o=a-s,c=l-r,d=o*o+c*c,p=Math.sqrt(d);if(p>e+i)return[];if(p<Math.abs(e-i))return[];if(E(p,0)&&E(e,i))return[];const h=(e*e-i*i+d)/(2*p),m=Math.sqrt(e*e-h*h),_=m*c/p,y=m*o/p,[v,C]=gs(mr,n,t,h/p);return E(_,y)?[_n(v,C)]:[_n(v+_,C-y),_n(v-_,C+y)]}function nn(n,e,{start:t,end:i,type:s}){return te(n.start,t[0],t[1],e),te(n.end,i[0],i[1],e),n.type=jl[s],n}function fr(n,e){return E(n[2],e[2])}function E(n,e){return Math.abs(n-e)<ge}function Fl(n,e){return e.filter(t=>Le(n,t))}function Le(n,e){return pa(n,e)}var Y;(function(n){n[n.PLANE=0]="PLANE",n[n.HALF_PLANE=1]="HALF_PLANE"})(Y||(Y={}));const jl={[Y.PLANE]:z.LINE,[Y.HALF_PLANE]:z.RAY},ge=1e-6,mr=B(),ql=B(),Ye=g(),lt=g(),ri=g(),gr=g(),_r=g(),yr=g(),sn=g(),Ul=I(),ai={start:g(),end:g(),type:z.LINE},Zl={start:g(),end:g(),type:z.LINE};class ve{intersect(e){return Se(this,e)}closestPoints(e){return[this.closestTo(e)]}}class ct extends ve{constructor(e){super(),this.point=e}equals(e){return this===e||le(e)&&w(this.point,e.point)}closestTo(){return at(this.point)}}class oi extends ve{constructor(e,t,i){super(),this.start=e,this.end=t,this.lineLike={start:e,end:t,type:i}}equals(e){return this===e||ce(e)&&this.lineLike.type===e.lineLike.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){const t=ii(e,this.lineLike);return t}}class li extends oi{constructor(e,t){super(e,t,z.LINE)}}class Wl extends oi{constructor(e,t){super(e,t,z.RAY)}}class vr extends ve{constructor(e){super(),this.constraints=e}equals(e){return this===e||zn(e)&&va(this.constraints,e.constraints,(t,i)=>t.equals(i))}closestTo(e){let t,i=1/0;for(const s of this.constraints){const r=s.closestTo(e),a=Bt(e,r);a<i&&(i=a,t=r)}return t?at(t):e}closestPoints(e){return this.constraints.flatMap(t=>t===this?[]:t.closestPoints(e))}}class Sr extends ve{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||ue(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=dr(e,this.center,this.radius);return t}}class ci extends ve{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||Pe(e)&&w(this.center,e.center)&&this.radius===e.radius}closestTo(e){const t=dr(e,this.center,this.radius);return t[2]=this.center[2],t}asCircle(){return new di(at(this.center),this.radius,Ve(0,0,1))}}let di=class extends ve{constructor(e,t,i,s=void 0){super(),this.center=e,this.radius=t,this.normal=i,this.slicePlane=s}equals(e){return this===e||De(e)&&w(this.center,e.center)&&w(this.normal,e.normal)&&this.radius===e.radius}closestTo(e){const{center:t,radius:i}=this;_s(this.getPlane(Bl),e,bn);const s=D(bn,bn,t),r=Wt(s);if(E(r,0))return at(e);const a=i/Math.sqrt(r),l=k(g(),t,s,a),{slicePlane:o}=this;return o&&!Le(o,l)?pi(o,this)?.closestTo(e)??at(e):l}getPlane(e=I()){return Ze(this.center,this.normal,e)}};const bn=g(),Bl=I();class Yl extends ve{constructor(e){super(),this.z=e}equals(e){return this===e||we(e)&&this.z===e.z}closestTo(e){return q(e[0],e[1],this.z)}getPlane(e=I()){return te(Yi,0,0,this.z),Ze(Yi,wa,e)}}const Yi=g();class ui extends ve{constructor(e,t,i){super(),this.start=e,this.end=t,this.planeLike={start:e,end:t,type:i}}equals(e){return this===e||de(e)&&this.planeLike.type===e.planeLike.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){return cr(e,this.planeLike)}closestEndTo(e){const{start:t,end:i}=this;return Math.sign(Et(_e(Xl,i,t),_e(Ql,e,t)))>0?i:t}getPlane(e=I()){const t=A(Xi,this.end);return t[2]+=1,Pa(this.start,this.end,t,e)}getSlicePlane(e=I()){const{start:t,end:i,type:s}=this.planeLike;if(s===Y.PLANE)return;const r=te(Xi,t[0],t[1],0),a=te(Qi,i[0],i[1],0),l=Ie(Qi,a,r);return Ze(r,l,e),e}}const Xl=B(),Ql=B(),Xi=g(),Qi=g();class wr extends ui{constructor(e,t){super(e,t,Y.HALF_PLANE)}}class Pr extends ui{constructor(e,t){super(e,t,Y.PLANE)}}class Jl extends ve{constructor(e,t){super(),this.sphere=ba(e,t)}equals(e){return this===e||be(e)&&xa(this.sphere,e.sphere)}closestTo(e){const t=$a(this.sphere,e,g());return t}get center(){return this.sphere}get radius(){return this.sphere[3]}}class br extends ve{constructor(e,t,i){super(),this.start=e,this.end=t,this.getZ=i,this.planeLike={start:e,end:t,type:Y.PLANE}}equals(e){return this===e||rn(e)&&w(this.start,e.start)&&w(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Kl(this,e)}addIfOnTheGround(e,t){for(const i of t){const s=this.getZ(i[0],i[1])??0;E(i[2],s)&&(i[2]=s,e.push(i))}}}function Kl(n,e){const t=cr(e,n.planeLike);return t[2]=n.getZ(t[0],t[1])??$r,t}function Se(n,e){if(zn(n)){const t=[];for(const i of n.constraints){const s=i.intersect(e);s&&t.push(s)}return hi(t)}if(zn(e))return Se(e,n);if(rn(n))return Ji(n,e);if(rn(e))return Ji(e,n);if(le(n)){const{point:t}=n,i=e.closestTo(t);return Vn(i,t)?n:void 0}if(ce(n)){if(le(e))return Se(e,n);if(ce(e))return ae(hr(n.lineLike,e.lineLike));if(we(e))return ec(n,e);if(de(e))return ae(or(e.planeLike,n.lineLike));if(ue(e))return ae(pr(n.lineLike,e.center,e.radius));if(De(e))return ae(ur(n.lineLike,e));if(Pe(e))return tc(n,e);if(be(e))return nc(n,e)}else if(we(n)){if(le(e)||ce(e))return Se(e,n);if(we(e))return ic(n,e);if(de(e))return sc(n,e);if(ue(e))return rc(n,e);if(De(e))return oc(n,e);if(Pe(e))return ac(n,e);if(be(e))return lc(n,e)}else if(de(n)){if(le(e)||ce(e)||we(e))return Se(e,n);if(de(e))return xn(lr(n.planeLike,e.planeLike));if(ue(e))return xn(ni(n.planeLike,e.center,e.radius));if(De(e))return dc(n,e);if(Pe(e))return cc(n,e);if(be(e))return uc(n,e)}else if(ue(n)){if(le(e)||ce(e)||we(e)||de(e))return Se(e,n);if(ue(e))return xn(si(n.center,n.radius,e.center,e.radius));if(De(e))return void 0;if(Pe(e))return pc(n,e);if(be(e))return void 0}else if(De(n)){if(le(e)||ce(e)||we(e)||de(e)||ue(e))return Se(e,n);if(De(e))return void 0;if(Pe(e))return e.asCircle(),void 0;if(be(e))return void 0}else if(Pe(n)){if(le(e)||ce(e)||we(e)||de(e)||ue(e)||De(e))return Se(e,n);if(Pe(e))return hc(e,n);if(be(e))return void 0}else if(be(n)){if(le(e)||ce(e)||we(e)||de(e)||ue(e)||Pe(e))return Se(e,n);if(be(e))return void 0}}const ec=(()=>{const n=I();return(e,t)=>{const{start:i,end:s}=e;if(fr(i,s)&&E(i[2],t.z))return e;const r=g();return ms(t.getPlane(n),i,s,r)?new ct(r):void 0}})();function tc({lineLike:n},{center:e,radius:t}){const i=e[2];return ae(pr(n,e,t).filter(s=>E(s[2],i)))}function nc({lineLike:n},{sphere:e}){return ae(Sa(e,n.start,n.end))}const pi=(()=>{const n=cs(),e=I(),t={start:g(),end:g(),type:z.LINE};return(i,s,r)=>{const{normal:a,center:l,radius:o}=s,c=R(a,kn(i)),d=E(Tn(i,l),0);if(E(c,1))return d?s:void 0;if(s.getPlane(e),d&&E(c,0)&&Ti(i)&&Ti(e)){if(E(o,0))return!r||Le(r,l)?new ct(at(l)):void 0;const h=ye(l);h[2]+=o;const m=ye(l);m[2]-=o;const _=[];return r&&!Le(r,h)||_.push(h),r&&!Le(r,m)||_.push(m),ae(_)}if(!_a(i,e,n))return;A(t.start,n.origin),Nn(t.end,n.origin,n.direction);const p=ur(t,s);return ae(r?Fl(r,p):p)}})();function ic(n,e){return E(n.z,e.z)?n:void 0}function sc({z:n},{planeLike:e}){const[t,i]=e.start,[s,r]=e.end,a=Ve(t,i,n),l=Ve(s,r,n);return e.type===Y.PLANE?new li(a,l):new Wl(a,l)}function rc(n,e){const[t,i]=e.center;return new ci(Ve(t,i,n.z),e.radius)}function ac(n,e){return E(e.center[2],n.z)?e:void 0}const oc=(()=>{const n=I();return(e,t)=>pi(e.getPlane(n),t)})();function lc(n,{center:e,radius:t}){const i=Math.abs(e[2]-n.z);if(i>t&&!E(i,t))return;const s=Ve(e[0],e[1],n.z),r=Math.sqrt(t**2-i**2);return E(r,0)?void 0:new ci(s,r)}const cc=(()=>{const n=I();return(e,{center:t,radius:i})=>{const s=ni(e.planeLike,t,i),r=t[2];e.getSlicePlane(n);const a=[];for(const[l,o]of s){const c=[l,o,r];Le(n,c)&&a.push(c)}return ae(a)}})(),dc=(()=>{const n=I(),e=I();return(t,i)=>pi(t.getPlane(n),i,t.getSlicePlane(e))})(),uc=(()=>{const n=I();return(e,{center:t,radius:i})=>{const s=e.getPlane(n),r=On(s,t),a=Math.abs(r);if(a>i&&!E(a,i))return;const l=ye(kn(s)),o=k(g(),t,l,r),c=Math.sqrt(i**2-r**2);return E(c,0)?new ct(_s(s,t,g())):new di(o,c,l,e.getSlicePlane())}})();function pc(n,e){const t=He(n.center,e.center);return E(t,0)&&E(n.radius,e.radius)?e:xr(si(n.center,n.radius,e.center,e.radius),e.center[2])}function hc(n,e){if(!fr(n.center,e.center))return;const t=He(n.center,e.center);return E(t,0)&&E(n.radius,e.radius)?n:xr(si(n.center,n.radius,e.center,e.radius),n.center[2])}function Ji(n,e){const{planeLike:t,getZ:i}=n,s=[];if(le(e))n.addIfOnTheGround(s,kl(t,e.point));else if(ce(e))n.addIfOnTheGround(s,or(t,e.lineLike));else if(ue(e))for(const[r,a]of ni(t,e.center,e.radius)){const l=i(r,a);l!=null&&s.push(q(r,a,l))}else if(de(e)||rn(e))for(const[r,a]of lr(t,e.planeLike)){const l=i(r,a)??$r;s.push(q(r,a,l))}return ae(s)}function xn(n){return hi(n.map(([e,t])=>{const i=Ve(e,t,0),s=Ve(e,t,1);return new li(i,s)}))}function ae(n){return hi(n.map(e=>e?new ct(e):void 0))}function xr(n,e){return ae(n.map(([t,i])=>[t,i,e]))}function hi(n){if(n.length!==0)return n.length===1?n[0]??void 0:new vr(n.filter(ya))}function zn(n){return n instanceof vr}function le(n){return n instanceof ct}function ce(n){return n instanceof oi}function we(n){return n instanceof Yl}function de(n){return n instanceof ui}function ue(n){return n instanceof Sr}function Pe(n){return n instanceof ci}function De(n){return n instanceof di}function be(n){return n instanceof Jl}function rn(n){return n instanceof br}const $r=0;let K=class extends J{get layerView(){return this.view?.allLayerViews?.find(e=>e.layer===this.layer)}get valid(){return this._valid}get subtypeFilter(){const{layer:e}=this;if(!Ma(e)||!e.subtypes?.length)return{mode:"not-in-use",filter:null};const t=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField,i=e.sublayers.filter(s=>s.visible).map(s=>s.subtypeCode);return i.length?i.length===e.subtypes.length?{mode:"all-visible",filter:null}:i.length===1?{mode:"in-use",filter:`${t} = ${i.getItemAt(0)}`}:{mode:"in-use",filter:`${t} IN (${i.join(", ")})`}:{mode:"none-visible",filter:null}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?wo({view:e,layer:t}):null}constructor(e){super(e),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:e,snappingSource:t}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([S(()=>t.updating,i=>t.layerSource.updating=i,N),S(()=>t.availability,i=>t.layerSource.availability=i,N)])}getFetchCandidatesParameters(e,t,i){if(!this.valid)return[];const{layer:s,layerView:r,floorFilter:a,rulesTable:l,subtypeFilter:o}=this,c={distance:i,mode:this.view?.type??"2d",point:e,coordinateHelper:t.coordinateHelper,...this._types,filter:r&&"filter"in r?r.filter:null};if(a&&(c.filter=$n(c.filter,a)),o.mode!=="not-in-use"&&o.mode!=="all-visible"){if(o.mode==="none-visible")return[];c.filter?c.filter.where=Fn(c.filter.where,o.mode):c.filter=new Ut({where:o.filter})}if(l){const d=t.feature,p=d?.sourceLayer;if(!(d&&yn(s)&&s.layerId&&yn(p)&&l.loadStatus==="loaded"))return[];const h=[],m=s.layerId,_=l.getFeatureSQL(p,d)?.[m];if(!_)return[];const y=_.anyVertex;let v=_.endVertex;return v&&y&&v===y&&(v=""),v&&h.push({...c,returnEdge:!1,vertexMode:"ends",filter:$n(c.filter,v)}),y&&h.push({...c,returnEdge:!1,vertexMode:"all",filter:$n(c.filter,y)}),h}return[c]}async loadRules(){const{layer:e,view:t}=this;if(e&&t&&Rl(t?.map)&&yn(e)){const i=t.map.utilityNetworks?.find(s=>s.isUtilityLayer(e));if(i)try{this.rulesTable=await i.getRulesTable(),await this.rulesTable?.load(),this._valid=!0}catch{return void Gn.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}}else this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function $n(n,e){return n==null?new Ut({where:e}):n.where?new Ut({where:Fn(n.where,e)}):new Ut({where:e})}u([f({constructOnly:!0})],K.prototype,"layer",void 0),u([f({constructOnly:!0})],K.prototype,"snappingSource",void 0),u([f({constructOnly:!0})],K.prototype,"view",void 0),u([f()],K.prototype,"layerView",null),u([f()],K.prototype,"rulesTable",void 0),u([f()],K.prototype,"valid",null),u([f()],K.prototype,"subtypeFilter",null),u([f()],K.prototype,"floorFilter",null),u([f()],K.prototype,"_valid",void 0),K=u([H("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],K);let dt=class{constructor(e,t,i,s){this.targetPoint=e,this.constraint=t,this.isDraped=i,this.domain=s}},fi=class extends dt{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:s}){super(e,i,s,L.FEATURE),this.objectId=t}},fc=class extends fi{constructor(e){super({...e,isDraped:!0,constraint:new br(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new Q(F.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},mc=class extends fi{constructor(e){super({...e,constraint:new li(e.edgeStart,e.edgeEnd)})}get hints(){return[new Q(F.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Mr=class extends dt{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,t,l,L.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===ot.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===ot.CENTER?this.targetPoint:this.otherVertex;return[new Q(F.TARGET,t,i,this.isDraped,this.domain),new Q(F.REFERENCE,e,t,this.isDraped,this.domain),new ti(this.previousVertex,t,i,this.isDraped,this.domain)]}};var ot;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(ot||(ot={}));let $e=class extends J{get updating(){return this._snappingSources.some(e=>e==null||e.valid&&e.snappingSource.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=L.FEATURE,this._updatingHandles=new ys,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=Ea(()=>this.options?.featureSources,(t,i)=>this._createSourceInfo(t,i));this._snappingSources=e,this.addHandles(se(e))}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,i,s){if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,i);for(const o of this._snappingSources){if(o==null||!o.valid||!o.snappingSource.layerSource.enabled||o.layerView?.suspended)continue;const c=o.getFetchCandidatesParameters(e,i,a);for(const d of c)r.push(o.snappingSource.fetchCandidates(d,s).then(p=>p.filter(h=>!this._candidateIsExcluded(o.snappingSource,h,i.excludeFeature))))}const l=(await Oa(r)).flat();return this._addRightAngleCandidates(l,e,a,i),vn(s),ei(e,l),l}_addRightAngleCandidates(e,t,i,s){const r=s.vertexHandle!=null?s.vertexHandle.rightEdge?.rightVertex?.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?s.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,a=s.vertexHandle!=null?s.vertexHandle.leftEdge?.leftVertex?.pos:s.editGeometryOperations!=null?s.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:l}=this,o=$(r,l,s),c=$(a,l,s),d=e.length;for(let p=0;p<d;p++)this._addRightAngleCandidate(e[p],c,t,i,e),this._addRightAngleCandidate(e[p],o,t,i,e)}_addRightAngleCandidate(e,t,i,s,r){if(t==null||!gc(e))return;const a=e.constraint.closestTo(t),l=(a[0]-i[0])/s.x,o=(a[1]-i[1])/s.y,{start:c,end:d}=e.constraint;if(l*l+o*o<=1){const p=new Mr({targetPoint:a,otherVertex:t,otherVertexType:ot.NEXT,previousVertex:He(a,c)>He(a,d)?c:d,constraint:new wr(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(p)}}_computeScreenSizeDistanceParameters(e,t){let i=this.options!=null?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,i,s){const{spatialReference:r}=s;i.renderCoordsHelper.toRenderCoords(e,r,Ki);const a=i.state.camera.computeScreenPixelSizeAt(Ki),l=a*i.renderCoordsHelper.unitInMeters,o=l/Ca(r),c=l/Ta(r),d=t*o,p=t*c,h=V(e,r,O,i),m=h?Mn(h,e,o,0,0,i,s):0,_=h?Mn(h,e,0,o,0,i,s):0,y=h?Mn(h,e,0,0,c,i,s):0;return{x:m===0?0:d/m,y:_===0?0:d/_,z:y===0?0:p/y,distance:a*t}}_candidateIsExcluded(e,t,i){if(i==null)return!1;const s=this._getCandidateObjectId(t);if(s==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?i.uid===s:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof fi?e.objectId:null}async _createSourceInfo(e,t){const i=e.layer;i.loaded||(await i.load(),vn(t));const{view:s}=this,r=await this._createFeatureSnappingSourceType(e);return vn(t),new K(r==null?{}:{snappingSource:r,view:s,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return t==null||t.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(t.loader==null){const i=this._loadSourceModule(e),s={module:null,loader:i};this._sourceModules[e]=s;const r=await i,a={module:r,loader:i};return this._sourceModules[e]=a,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(Dt(()=>import("./FeatureServiceSnappingSource-56ca8a18.js"),["./FeatureServiceSnappingSource-56ca8a18.js","./index-8b5e7d9b.js","./index-5447a158.css","./elevationInfoUtils-25b84599.js","./queryEngineUtils-00a06d0c.js","./VertexSnappingCandidate-bd6d5c7c.js","./TileTreeDebugger-ee20aa0c.js","./LineVisualElement-fc7385d7.js","./LengthDimension-aec24abc.js","./Segment-ec50fd17.js","./unitFormatUtils-4b3497b3.js","./analysisViewUtils-d9ecfeae.js","./Factory-9cf1118b.js","./ImageMaterial-0b6c45d0.js","./vec4f32-0d1b2306.js","./RightAngleQuadVisualElement-f61633a8.js","./PointVisualElement-8a3927d0.js","./Query-630c5d65.js","./EditGeometryOperations-aafb8f81.js","./FeatureFilter-5ab88729.js","./floorFilterUtils-73949d2d.js","./dehydratedFeatureComparison-43e0df71.js"],import.meta.url));case"featureCollection":return t.addPromise(Dt(()=>import("./FeatureCollectionSnappingSource-b2737262.js"),["./FeatureCollectionSnappingSource-b2737262.js","./index-8b5e7d9b.js","./index-5447a158.css","./elevationInfoUtils-25b84599.js","./queryEngineUtils-00a06d0c.js","./VertexSnappingCandidate-bd6d5c7c.js","./symbologySnappingCandidates-d7f920a2.js","./LineVisualElement-fc7385d7.js","./LengthDimension-aec24abc.js","./Segment-ec50fd17.js","./unitFormatUtils-4b3497b3.js","./analysisViewUtils-d9ecfeae.js","./Factory-9cf1118b.js","./ImageMaterial-0b6c45d0.js","./vec4f32-0d1b2306.js","./RightAngleQuadVisualElement-f61633a8.js","./PointVisualElement-8a3927d0.js","./Query-630c5d65.js","./EditGeometryOperations-aafb8f81.js","./FeatureFilter-5ab88729.js","./floorFilterUtils-73949d2d.js","./dehydratedFeatureComparison-43e0df71.js"],import.meta.url));case"graphics":case"notes":return t.addPromise(Dt(()=>import("./GraphicsSnappingSource-4861f5ac.js"),["./GraphicsSnappingSource-4861f5ac.js","./index-8b5e7d9b.js","./index-5447a158.css","./normalizeUtilsSync-344190b6.js","./FeatureStore-d414226c.js","./BoundsStore-409e99ee.js","./PooledRBush-05d409af.js","./quickselect-fc5bb707.js","./QueryEngine-03d16de6.js","./WhereClause-4988664d.js","./TimeOnly-a96593b0.js","./json-48e3ea08.js","./QueryEngineCapabilities-85c4f1d0.js","./utils-4576de5f.js","./heatmapUtils-3c0e0ece.js","./utils-e24aed40.js","./generateRendererUtils-1c8bce12.js","./FieldsIndex-85e142d0.js","./optimizedFeatureQueryEngineAdapter-717c64bf.js","./elevationInfoUtils-25b84599.js","./queryEngineUtils-00a06d0c.js","./VertexSnappingCandidate-bd6d5c7c.js","./symbologySnappingCandidates-d7f920a2.js","./LineVisualElement-fc7385d7.js","./LengthDimension-aec24abc.js","./Segment-ec50fd17.js","./unitFormatUtils-4b3497b3.js","./analysisViewUtils-d9ecfeae.js","./Factory-9cf1118b.js","./ImageMaterial-0b6c45d0.js","./vec4f32-0d1b2306.js","./RightAngleQuadVisualElement-f61633a8.js","./PointVisualElement-8a3927d0.js","./Query-630c5d65.js","./EditGeometryOperations-aafb8f81.js","./FeatureFilter-5ab88729.js","./floorFilterUtils-73949d2d.js","./dehydratedFeatureComparison-43e0df71.js"],import.meta.url));case"scene":return t.addPromise(Dt(()=>import("./SceneLayerSnappingSource-824bcba4.js"),["./SceneLayerSnappingSource-824bcba4.js","./index-8b5e7d9b.js","./index-5447a158.css","./VertexSnappingCandidate-bd6d5c7c.js","./LineVisualElement-fc7385d7.js","./LengthDimension-aec24abc.js","./Segment-ec50fd17.js","./unitFormatUtils-4b3497b3.js","./elevationInfoUtils-25b84599.js","./analysisViewUtils-d9ecfeae.js","./Factory-9cf1118b.js","./ImageMaterial-0b6c45d0.js","./vec4f32-0d1b2306.js","./RightAngleQuadVisualElement-f61633a8.js","./PointVisualElement-8a3927d0.js","./Query-630c5d65.js","./EditGeometryOperations-aafb8f81.js","./FeatureFilter-5ab88729.js","./floorFilterUtils-73949d2d.js","./dehydratedFeatureComparison-43e0df71.js"],import.meta.url))}}get test(){return{snappingSources:this._snappingSources}}};function gc(n){return(n instanceof mc||n instanceof fc)&&!_c(n)}function _c({constraint:{start:n,end:e}}){const t=Bt(n,e),i=He(n,e);return t<Da()||i/t<vc}function Mn(n,e,t,i,s,r,{spatialReference:a}){const l=A(yc,e);l[0]+=t,l[1]+=i,l[2]+=s;const o=V(l,a,O,r);return o?Cl(o,n):1/0}u([f({constructOnly:!0})],$e.prototype,"spatialReference",void 0),u([f({constructOnly:!0})],$e.prototype,"view",void 0),u([f()],$e.prototype,"options",void 0),u([f({readOnly:!0})],$e.prototype,"updating",null),u([f()],$e.prototype,"_snappingSources",void 0),$e=u([H("esri.views.interactive.snapping.FeatureSnappingEngine")],$e);const Ki=g(),yc=g(),vc=1e-4;let dn=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=T.shortLineThreshold*T.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold($(e.leftVertex.pos,this.view,t),$(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return this.squaredShortLineThreshold===0||Be(V(t,i,O,this.view),V(e,i,O,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return He(e,t)<T.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}},Sc=class extends dt{constructor({lineStart:e,lineEnd:t,targetPoint:i,isDraped:s}){super(i,new Pr(e,t),s,L.SELF),this._referenceLineHint=new Q(F.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new Q(F.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},wc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,l=V(e,a,O,this.view),{view:o}=this,c=i.edges[s-1];let d=c;do{if(this.edgeExceedsShortLineThreshold(d,t)){const p=tn(d,o,t);this._processCandidateProposal(p.left,p.right,e,l,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==c);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:a}=this,{spatialReference:l}=t,o=V(e,l,O,a),c=s.leftEdge,d=s.rightEdge;c&&d&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal($(c.leftVertex.pos,a,t),$(d.rightVertex.pos,a,t),e,o,t,i);const p=r.edges[0];let h=p;do{if(h!==s.leftEdge&&h!==s.rightEdge&&this.edgeExceedsShortLineThreshold(h,t)){const m=tn(h,a,t);this._processCandidateProposal(m.left,m.right,e,o,t,i)}h=h.rightVertex.rightEdge}while(h&&h!==p);return i}_processCandidateProposal(e,t,i,s,r,a){const{spatialReference:l,pointer:o}=r,c=ii(i,{start:e,end:t,type:z.LINE});Be(s,V(c,l,O,this.view))<this.squaredProximityThreshold(o)&&a.push(new Sc({lineStart:e,lineEnd:t,targetPoint:c,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}},Pc=class extends dt{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:s}){const r=ye(t),{left:a,right:l}=e;Ie(r,Nn(r,r,l),a),super(i,new Pr(t,r),s,L.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new Q(F.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new er(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new Q(F.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{w(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),w(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),w(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),w(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},bc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=V(e,t.spatialReference,O,l),c=$(i.vertices[r-1].pos,l,t),d=$(i.vertices[0].pos,l,t),p=i.edges[s-1];let h=p;do{if(this.edgeExceedsShortLineThreshold(h,t)){const m=tn(h,l,t);this._checkEdgeForParallelLines(m,c,e,o,t,a),this._checkEdgeForParallelLines(m,d,e,o,t,a)}h=h.leftVertex.leftEdge}while(h&&h!==p);return a}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:a}=this,l=V(e,t.spatialReference,O,a),o=s.leftEdge,c=s.rightEdge,d=r.vertices[0],p=$(d.pos,a,t),h=r.vertices.length,m=r.vertices[h-1],_=$(m.pos,a,t),y=r.edges[0];let v=y;do{if(v!==o&&v!==c&&this.edgeExceedsShortLineThreshold(v,t)){const C=tn(v,a,t);o&&this._checkEdgeForParallelLines(C,$(o.leftVertex.pos,a,t),e,l,t,i),c&&this._checkEdgeForParallelLines(C,$(c.rightVertex.pos,a,t),e,l,t,i),s===d?this._checkEdgeForParallelLines(C,_,e,l,t,i):s===m&&this._checkEdgeForParallelLines(C,p,e,l,t,i)}v=v.rightVertex.rightEdge}while(v&&v!==y);return i}_checkEdgeForParallelLines(e,t,i,s,r,a){const l=e.left,o=e.right;if(Sn(Ne,t,l,o),He(Ne,t)<T.parallelLineThreshold)return;Sn(Ne,i,l,o,t);const{spatialReference:c,pointer:d}=r,p=Ve(Ne[0],Ne[1],i[2]);if(Be(s,V(p,c,O,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(p,t)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new Pc({referenceLine:e,lineStart:t,targetPoint:p,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const i=e.left,s=e.right;for(const r of t)if(Sn(Ne,s,r.constraint.start,r.constraint.end,i),He(Ne,s)<T.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const Ne=B();let xc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=V(e,t.spatialReference,O,a),o=i.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const d=$(o.pos,a,t),p=$(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,p,d,e,l,t)}const c=i.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const d=$(c.pos,a,t),p=$(c.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,p,d,e,l,t)}return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,a=V(e,t.spatialReference,O,r),l=s.leftEdge,o=s.rightEdge;if(l?.leftVertex.leftEdge){const c=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=$(c.rightVertex.pos,r,t),p=$(c.leftVertex.pos,r,t);this._checkForSnappingCandidate(i,p,d,e,a,t)}}if(o?.rightVertex.rightEdge){const c=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=$(c.leftVertex.pos,r,t),p=$(c.rightVertex.pos,r,t);this._checkForSnappingCandidate(i,p,d,e,a,t)}}return i}_checkForSnappingCandidate(e,t,i,s,r,a){const{spatialReference:l,pointer:o}=a;_e(Nt,i,t);const c=te($c,Nt[1],-Nt[0],0),d=Et(c,_e(Nt,s,i))/St(c),p=_t(ye(s),i,c,d);if(Be(r,V(p,l,O,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(p,i)||this.isVertical(i,t))return;const h=k(g(),i,c,Math.sign(d));e.push(new Mr({targetPoint:p,constraint:new wr(i,h),previousVertex:t,otherVertex:i,otherVertexType:ot.CENTER,isDraped:a.elevationInfo?.mode==="on-the-ground"}))}}};const Nt=B(),$c=g();let Mc=class extends dt{constructor({targetPoint:e,point1:t,point2:i,isDraped:s}){super(e,new Sr(fs(g(),t,i,.5),.5*vs(t,i)),s,L.SELF),this._p1=t,this._p2=i}get hints(){return[new Q(F.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new Q(F.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ti(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},Ec=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=i.vertices[0],o=i.vertices[r-1],c=$(l.pos,a,t),d=$(o.pos,a,t);return this._processCandidateProposal(c,d,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:a}=this,l=$(s.leftEdge.leftVertex.pos,a,t),o=$(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(l,o,e,t,i),i}_processCandidateProposal(e,t,i,s,r){if(!this.exceedsShortLineThreshold(e,t,s))return;const a=gs(Oc,e,t,.5),l=.5*vs(e,t),o=g();_o(o,i,a,l),o[2]=i[2];const c=o,{spatialReference:d,pointer:p}=s,h=V(i,d,O,this.view);if(Be(h,V(c,d,O,this.view))<this.squaredProximityThreshold(p)){if(this.isVertical(e,c)||this.isVertical(c,t))return;r.push(new Mc({targetPoint:c,point1:e,point2:t,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};const Oc=B();let Je=class extends J{constructor(e){super(e),this.updating=!1,this._snappers=new Mt,this._domain=L.SELF}initialize(){this._snappers.push(new bc(this.view,this.options),new wc(this.view,this.options),new xc(this.view,this.options),new Ec(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,i){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const r of this._snappers.items)for(const a of r.snap(e,i))s.push(a);return ei(e,s),s}};u([f({readOnly:!0})],Je.prototype,"updating",void 0),u([f({constructOnly:!0})],Je.prototype,"view",void 0),u([f()],Je.prototype,"options",null),Je=u([H("esri.views.interactive.snapping.SelfSnappingEngine")],Je);function Cc(n,e){return[new Je({view:n,options:e}),new $e({view:n,options:e,spatialReference:n.spatialReference})]}function es(n,e,{z:t,m:i,spatialReference:s,elevationInfo:r}){if(t==null&&i==null){const o=Re(n[0],n[1],void 0,s);return i!=null&&(o.m=i,o.hasM=!0),o}if(e==null||e.type==="2d"){const o=Re(n[0],n[1],t,s);return i!=null&&(o.m=i,o.hasM=!0),o}const a=po(e,n,s,O,r)??0,l=Re(n[0],n[1],a,s);return i!=null&&(l.m=i,l.hasM=!0),l}let Ft=class extends dt{constructor(e,t,i,s){super(e,new ct(e),s,L.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Qs(this.targetPoint,this.isDraped,this.domain)]}},ne=class extends Ra.EventedMixin(J){constructor(e){super(e),this.options=new ar,this.snappingEnginesFactory=Cc,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=Me.MAIN}initialize(){this.addHandles([S(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:s}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},wt),S(()=>this.options,e=>{for(const t of this._engines)t.options=e},wt),S(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:e,snappingEnginesFactory:t})=>this._recreateEngines(e,t),N)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)}_recreateEngines(e,t){if(this._destroyEngines(),!e)return;const{view:i,options:s}=this;this._engines=t(i,s)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}get _squaredSatisfiesConstraintThreshold(){return T.satisfiesConstraintScreenThreshold*T.satisfiesConstraintScreenThreshold}snap(e){return Tc(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:i}=e;this._removeVisualization();const s=this._currentMainCandidate;if(s==null)return t;const r=this._selectUpdateInput(e);if(r==null)return t;const{spatialReference:a}=i,l=Di(r,a);if(l==null)return t;const{view:o}=this,{elevationInfo:c,visualizer:d}=i,p=[],h=ft(l,o,c),m=s.constraint.closestTo(h);if(!this._arePointsWithinScreenThreshold(h,m,i))return this._resetSnappingState(),t;s.targetPoint=m,p.push(...s.hints);for(const _ of this._currentOtherActiveCandidates)_.targetPoint=m,p.push(..._.hints);return d!=null&&this.addHandles(d.draw(p,{spatialReference:a,elevationInfo:Dc(i),view:o,selfSnappingZ:i.selfSnappingZ}),jt),es(m,o,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:c})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case Me.MAIN:return e;case Me.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=Me.MAIN}_removeVisualization(){this.removeHandles(jt)}async _snapSinglePoint({point:e,context:t,signal:i}){const{view:s}=this,{elevationInfo:r}=t,a=ft(e,s,r),l=await this._fetchCandidates(a,L.ALL,t,i);return this._createSnapResult(a,Me.MAIN,l,s,t,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:r},i)}async _snapMultiPoint({point:e,scenePoint:t,context:i,signal:s}){const{view:r}=this,{coordinateHelper:a,elevationInfo:l,spatialReference:o}=i;await Aa(t.spatialReference,o);const c=Di(t,o),d=ft(c,r,l),p=await this._fetchCandidates(d,L.FEATURE,i,s);if(p.length>0){const _=await this._fetchCandidates(d,L.SELF,i,s);return this._createSnapResult(d,Me.SCENE,[...p,..._],r,i,{z:c.z,m:c.m,spatialReference:c.spatialReference,elevationInfo:l},s)}const h=ft(e,r,l),m=await this._fetchCandidates(h,L.SELF,i,s);return this._createSnapResult(h,Me.MAIN,m,r,i,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:l},s)}async _fetchCandidates(e,t,i,s){return(await Promise.all(this._engines.map(r=>r.fetchCandidates(e,t,i,s)))).flat()}_createSnapResult(e,t,i,s,r,a,l){return{get valid(){return!La(l)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:c,hints:d}=this._processCandidates(e,t,i,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(d,{spatialReference:o,elevationInfo:O,view:s,selfSnappingZ:r.selfSnappingZ}),jt),es(c,s,a)}}}_processCandidates(e,t,i,s){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),ei(e,i);const r=this._currentMainCandidate;if(r!=null){const a=this._findOldConstraintInNewCandidates(r,i);if(a>=0){if(!(i[a]instanceof Ft))return this._intersectWithOtherCandidates(a,i,e,t,s);if(this._arePointsWithinScreenThreshold(e,r.targetPoint,s))return this._updateSnappingCandidate(r,t,i,s)}}return this._intersectWithOtherCandidates(0,i,e,t,s)}_findOldConstraintInNewCandidates(e,t){return e instanceof Ft?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,i,s,r){const{coordinateHelper:a}=r,l=t[e],o=[];for(let c=0;c<t.length;++c){if(c===e)continue;const d=t[c],p=l.constraint.intersect(d.constraint);if(p)for(const h of p.closestPoints(l.targetPoint))o.push([new Ft(h,l,d,d.isDraped),this._squaredScreenDistance(i,h,a)])}return o.length>0&&(o.sort((c,d)=>c[1]-d[1]),o[0][1]<this._squaredPointProximityThreshold(r.pointer))?this._updateSnappingCandidate(o[0][0],s,t,r):this._updateSnappingCandidate(l,s,t,r)}_updateSnappingCandidate(e,t,i,s){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const l of i){if(e instanceof Ft){if(l.constraint.equals(e.first.constraint)||l.constraint.equals(e.second.constraint))continue}else if(l.constraint.equals(e.constraint))continue;const o=l.constraint.closestTo(r);this._squaredScreenDistance(o,r,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(l.targetPoint=r,this._currentOtherActiveCandidates.push(l),a.push(...l.hints))}return{snappedPoint:r,hints:a}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,t,i){return this._squaredScreenDistance(e,t,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,t,i){return Be(this._toScreen(e,i),this._toScreen(t,i))}_toScreen(e,t){return V(e,t.spatialReference,O,this.view)}_findOldCandidateIndex(e,t){let i=-1;for(let s=0;s<e.length;++s)if(t.constraint.equals(e[s].constraint)){i=s;break}return i}get test(){return{visualizationsActive:this.hasHandles(jt),engines:this._engines}}};var Me;u([f({constructOnly:!0})],ne.prototype,"view",void 0),u([f()],ne.prototype,"options",void 0),u([f({readOnly:!0})],ne.prototype,"updating",null),u([f()],ne.prototype,"snappingEnginesFactory",void 0),u([f()],ne.prototype,"_engines",void 0),u([f()],ne.prototype,"_squaredMouseProximityTreshold",null),u([f()],ne.prototype,"_squaredTouchProximityThreshold",null),u([f()],ne.prototype,"_squaredSatisfiesConstraintThreshold",null),ne=u([H("esri.views.interactive.snapping.SnappingManager")],ne),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(Me||(Me={}));const jt="visualization-handle";function Tc(n){return n.scenePoint!=null}function Dc({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?O:e}const Zt=new Map;function Rc(n){if(!Zt.has(n)){const i=Gl(n,{distance:10}),s=Lc(n,i.options);Zt.set(n,{referenceCount:0,snappingManager:s,remove:()=>{i.remove(),s.destroy()}})}const e=Zt.get(n);e.referenceCount++;const t=jn(()=>Ac(n,e));return{snappingManager:e.snappingManager,...t}}function Ac(n,e){e.referenceCount--,e.referenceCount>0||za(()=>{e.referenceCount===0&&(e.remove(),Zt.delete(n))})}function Lc(n,e){return new ne({view:n,options:e,snappingEnginesFactory:(t,i)=>[new $e({view:n,spatialReference:n.spatialReference,options:i})]})}class Er{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.feature=e.feature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function zc({predicate:n=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:i,useZ:s=!0}){const r=new Os;if(e==null)return{snappingStep:[ts,r],cancelSnapping:ts};let a,l=null,o=null,c=null;const d=()=>{l=Pt(l),e.doneSnapping(),o?.frameTask.remove(),o=null,a=qn(a),c=null},p=Hc(e,s,r);let h=null,m=null,_=null;return{snappingStep:[y=>{if(!n(y))return y;const{action:v}=y;if(v==="start"){const{info:C}=y,un=Vc(e.view);if(o=Ic(t,y,un),o.context.selfSnappingZ=null,!s&&C!=null){const ut=kc(t.coordinateHelper,C.handle.component);ut!=null&&(o.context.selfSnappingZ={value:ut,elevationInfo:t.elevationInfo??O})}}if(o!=null){const{context:C,originalScenePos:un,originalPos:ut}=o,{mapEnd:mi,mapStart:gi,scenePoints:Tr}=y,pn=Or(ut,Hn(mi,gi)),_i=Hn(gi,ut),Dr={...y,action:"update"},Rr=o.context,hn=Gc(un,Tr),yi=e.update({point:pn,scenePoint:hn,context:C});if(_=yi,Cr(mi,yi,_i,s),h=pn,m=hn,v!=="end"){const{frameTask:Ar}=o;l==null&&(l=new AbortController),c=Lr=>{i.addPromise(Rn(p({frameTask:Ar,event:Dr,context:Rr,point:pn,scenePoint:hn,delta:_i,getLastState:()=>({point:h,scenePoint:m,updatePoint:Lr.forceUpdate?null:_})},l.signal)))},c({forceUpdate:!1}),a==null&&(a=S(()=>e.options.effectiveEnabled,()=>c?.({forceUpdate:!0})))}}return v==="end"&&d(),y},r],cancelSnapping:y=>(d(),y)}}function Hc(n,e,t){return Ps(async({frameTask:i,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:c},d)=>{const p=await i.schedule(()=>n.snap({point:s,scenePoint:r,context:a,signal:d}),d);if(p.valid){let h=await i.schedule(()=>p.apply(),d);const m=c();m.point!=null&&s!==m.point&&(h=n.update({point:m.point,scenePoint:m.scenePoint,context:a})),m.updatePoint!=null&&Po(h,m.updatePoint)||(Cr(l.mapEnd,h,o,e),t.execute(l))}})}function Vc(n){return n.type==="3d"?n.resourceController.scheduler.registerTask(Ss.SNAPPING):ws}function Ic(n,e,t){return{context:new Er({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:e.snapOrigin!=null?n.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:t}}function Or(n,[e,t,i]){const s=et(n);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=i),s}function Gc(n,e){return n==null||e==null?null:Or(n,Hn(e.sceneEnd,e.sceneStart))}function Hn(n,e){const t=n.hasZ&&e.hasZ?n.z-e.z:0;return[n.x-e.x,n.y-e.y,t]}function Cr(n,e,[t,i,s],r){n.x=e.x+t,n.y=e.y+i,r&&n.hasZ&&e.hasZ&&(n.z=e.z+s)}function kc(n,e){if(!n.hasZ())return null;const t=e.vertices;let i=null;for(const s of t){const r=n.getZ(s.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function ts(n){return n}let Ue=class extends J{constructor(n){super(n),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=Ps(async(e,t,i,s)=>{const r=this._frameTask;if(r==null)return;const a=await r.schedule(()=>t.snap({...e,context:i,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=t.update({...this._snapPoints,context:i}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(n){this._stagedPoint=this.constrainResult(n)}initialize(){const n=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=n!=null?n.registerTask(Ss.SNAPPING):ws}destroy(){this._abortController=Pt(this._abortController),this._frameTask=qn(this._frameTask)}update(n,e,t){this._snapPoints=n;const{point:i,scenePoint:s}=n,r=e.update({point:i,scenePoint:s,context:t});return this.stagedPoint=r,r}async snap(n,e,t){const{point:i,scenePoint:s}=n;return this.stagedPoint=e.update({point:i,scenePoint:s,context:t}),this._snapPoints=n,this._abortController==null&&(this._abortController=new AbortController),this._snap(n,e,t,this._abortController.signal)}async resnap(n,e){this._snapPoints!=null&&await this.snap(this._snapPoints,n,e)}abort(){this._abortController=Pt(this._abortController),this._snapPoints=null}};u([f({constructOnly:!0})],Ue.prototype,"view",void 0),u([f()],Ue.prototype,"stagedPoint",null),u([f()],Ue.prototype,"constrainResult",void 0),u([f()],Ue.prototype,"_stagedPoint",void 0),Ue=u([H("esri.views.interactive.snapping.SnappingOperation")],Ue);let G=class extends J{constructor(n){super(n),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new bs,this._orientationManipulatorTexture=null,this._updatingHandles=new ys,this._getSnappingContext=yl(i=>new Er({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new yo(new vo("point",So(!0,!1,this.view.spatialReference))),visualizer:new zl}));const{view:e}=n;this._snappingManagerResult=Rc(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Yt(2)}),this._constraintSnappingIndicator=new Fe({view:e,attached:!0,width:1,renderOccluded:P.OccludeAndTransparent,stipplePattern:Yt(5),isDecoration:!0});const t=X.toUnitRGBA(Vo);this._stagedStartIndicator=new Vl({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:n.view.renderCoordsHelper.spatialReference,color:t,size:2*ks,outlineSize:0,renderOccluded:P.OccludeAndTransparent,isDecoration:!0})}initialize(){const{view:n}=this;this._snappingOperation=new Ue({view:n});const e=!n._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._orientationManipulatorMaterial=new Ts({transparent:!0,writeDepth:!1,renderOccluded:P.Opaque,isDecoration:!0}),this.addHandles(S(()=>({accentColor:Kt(n.effectiveTheme),contrastColor:Ho(n.effectiveTheme)}),({accentColor:i,contrastColor:s})=>{const r=this._orientationManipulatorTexture,a=co(n.textures,{accentColor:i,contrastColor:s,preMultiplyAlpha:e});this._orientationManipulatorMaterial.setParameters({textureId:a.texture.id}),this._orientationManipulatorTexture=a,r?.release();const l=X.toUnitRGBA(i);this._unfocusedOffsetManipulatorMaterial.setParameters({color:l}),this._focusedOffsetManipulatorMaterial.setParameters({color:l}),this._thinOffsetManipulatorMaterial.setParameters({color:l}),this._constraintSnappingIndicator.color=l},rt));const t=an(()=>this.analysisViewData.computations,({computation:i})=>this._createManipulators(i));this.addHandles(se(t)),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:i,stagedComputation:s})=>{if(s==null||i==null)return;const r=et(i,new tt);this._applyPointUpdate(s,{endPoint:r})},wt),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(i,s)=>{const{stagedDimension:r,selectedComputation:a,firstGrabbedManipulator:l}=i;if(r===s?.stagedDimension&&l===s?.firstGrabbedManipulator){for(const o of[a,s?.selectedComputation])if(o!=null){const c=this._computationManipulators.get(o);c!=null&&this._updateManipulators(o,c,i)}}else for(const[o,c]of this._computationManipulators)this._updateManipulators(o,c,i)},N),S(()=>this.analysis.style.lineSize,i=>{this._updateManipulatorStyle(i)},rt),S(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>{const i=this._stagedComputation;if(!i)return null;const s=i.elevationAlignedStartPoint,r=g();return s!=null&&this.view.renderCoordsHelper.toRenderCoords(s,r)?r:null},i=>{i!=null?(this._stagedStartIndicator.vertices=[i],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Dl(this,()=>{const i=this._activeComputation,s=this._stagedComputation;if(i==null||s!=null){const r=this.view.inputManager.latestPointerType??"mouse",a=this._getSnappingContext(r);this._updatingHandles.addPromise(Rn(this._snappingOperation.resnap(this._snappingManager,a)))}if(i!=null){const{start:r,end:a}=this._computationManipulators.get(i);if(r.grabbing||a.grabbing){const l=r.grabbing?"start":"end",o=this._computeConstraint(i);Pl(i,l,{constraint:o,view:this.view})}}})}destroy(){this._snappingOperation=Un(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorTexture?.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:n}=this.analysisViewData;return this.hasGrabbedManipulators&&n!=null?n:null}get _stagedComputation(){const n=this._stagedDimension,e=this.analysisViewData.computations.at(-1)?.computation;return n==null||e==null||e.dimension!==n?null:e}get _constraintHandles(){return[Zn(()=>this.analysisViewData.selectedComputation,n=>{n.previousConstraint=this._computeConstraint(n)},{...N,equals:An}),S(()=>{const n=this._activeComputation;if(n==null)return null;const{measureType:e,orientation:t}=n.dimension;return{measureType:e,orientation:t,computation:n}},(n,e)=>{if(n!=null&&e==null){const{measureType:t,orientation:i,computation:s}=n;switch(s.previousConstraint){case ee.Horizontal:s.preConstraintProperties={measureType:M.Horizontal,orientation:0};break;case ee.Vertical:s.preConstraintProperties={measureType:M.Vertical,orientation:0};break;case ee.Direct:s.preConstraintProperties={measureType:M.Direct,orientation:i};break;default:s.preConstraintProperties={measureType:t,orientation:i}}}n==null&&e!=null&&(e.computation.preConstraintProperties=null)},wt)]}get _snappingIndicatorHandles(){const n="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:t})=>{const i=this._constraintSnappingIndicator;if(this.removeHandles(n),t!=null)if(t===e)i.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(t),a=()=>{i.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],n)}else i.attached=!1}),S(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:t})=>{const i=this._constraintSnappingIndicator;e!=null&&t!=null&&t!==ee.Direct?(i.visible=!0,i.setGeometryFromSegment(e.directSegment)):i.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(n){const{_stagedDimension:e}=this;if(e==null){const t=this._onUnstagedClick(n);return this.analysis.dimensions.add(t),null}return this._onStagedClick(n),e}onPointerMove({mapPoint:n,pointerType:e}){if(e==="touch")return;const t=this._getSnappingContext(e);this._updatingHandles.addPromise(Rn(this._snappingOperation.snap({point:n},this._snappingManager,t)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:n,pointerType:e}){let t=n;if(e==="mouse"){const s=this._getSnappingContext(e);t=this._snappingManager.update({point:n,context:s})}const i=new Xa({startPoint:et(t,new tt),endPoint:null,measureType:M.Horizontal});return this._stagedDimension=i,this._resetSnappingState(),i}_onStagedClick({mapPoint:n,pointerType:e}){const t=this._stagedComputation;if(t==null)return;let i=n;if(e==="mouse"){const r=this._getSnappingContext(e);i=this._snappingManager.update({point:n,context:r})}const s=et(i,new tt);this._applyPointUpdate(t,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(n){const e=this._setupPointManipulator(n,{isStart:!0}),t=this._setupPointManipulator(n,{isStart:!1}),i=this._setupOffsetManipulator(n),s=this._setupHeadingManipulator(n),r=this._setupRotationManipulator(n),a=this._setupMeasureTypeManipulator(n,M.Direct),l=this._setupMeasureTypeManipulator(n,M.Horizontal),o=this._setupMeasureTypeManipulator(n,M.Vertical),c=new Qo({start:e,end:t,offset:i,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});return this._setupComputationToManipulatorsSync(n,c),this._computationManipulators.set(n,c),this.manipulators.addMany(c.values()),{manipulators:c,remove:()=>{this._computationHandles.remove(n),this._computationManipulators.delete(n);for(const d of c.values())this.manipulators.remove(d)}}}_setupComputationToManipulatorsSync(n,e){this._computationHandles.add([S(()=>n.geometry,()=>this._updateManipulators(n,e),{...N,equals:An})],n)}_setupPointManipulator(n,e){const{view:t}=this,{dimension:i}=n,s=new Jo(t,{metadata:i}),r=tl(s,{isStart:e.isStart,createSnappingPipelineStep:a=>zc({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:i,onUpdate:a=>this._applyPointUpdate(n,a),view:t});return this._computationHandles.add(r,n),s}_setupOffsetManipulator(n){const{view:e}=this,t=Ko(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:n.dimension}),i=nl(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupHeadingManipulator(n){const{view:e}=this,t=new Vi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:n.dimension}),i=il(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupRotationManipulator(n){const{view:e}=this,t=new Vi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:n.dimension}),i=sl(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupMeasureTypeManipulator(n,e){const{view:t}=this,i=el(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:n.dimension}),s=ol(i,{computation:n,manipulatorMeasureType:e,view:t});return this._computationHandles.add(s,n),i}_updateManipulators(n,e,t={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:i,selectedComputation:s,firstGrabbedManipulator:r}=t,{start:a,end:l,offset:o,heading:c,rotation:d}=e,p=s===n,h=xt(n),{dimension:m}=n;for(const v of e.values()){const C=h&&i==null&&(r==null||v===r);v===o?(v.available=C,v.selected=p):v.available=C&&p}if(!h)return;this._computeConstraint(n)!=null?e.forEachMeasureTypeManipulator(v=>v.available=!1):e.manipulatorForMeasureType(m.measureType).available=!1;for(const v of[c,d])m.measureType===M.Direct&&m.offset!==0||(v.available=!1);Xn(n)?d.available=!1:c.available=!1;const{geometry:_}=n;a.renderLocation=_.directSegment.startRenderSpace,l.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:y}=this.view;ll(o,_,y),c.available&&cl(c,n,y),d.available&&dl(d,n,y),e.forEachMeasureTypeManipulator((v,C)=>{v.available&&hl(v,n,C,y)})}_updateManipulatorStyle(n){const e=_l(n),t=Kn(n),i={lineSizePt:n,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=t/2,r.update(i),a.update(i);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:t})}_applyPointUpdate(n,e){const{view:t}=this,i=Qt(n);"startPoint"in e&&(i.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(i.elevationAlignedEndPoint=e.endPoint);const s=Jt(i,t.renderCoordsHelper);if(s==null)return;const r=this._computeConstraint({...i,geometry:s});Xs(n,e,{...i,constraint:r,unconstrainedGeometry:s,view:t}),n===this._stagedComputation&&this._updateStagedDimensionOffset(n)}_updateStagedDimensionOffset(n){if(n.geometry==null)return;n.geometry.directSegment.eval(.5,ns);const e=this.view.state.camera.computeScreenPixelSizeAt(ns);n.dimension.offset=Yo*e}_computeConstraint(n){return wl(Sl(n,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new fe({width:1,renderOccluded:P.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const n=e=>this.analysisViewData.computations.find(({computation:t})=>t.dimension===e)?.computation;return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=P.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:t}of e.renderObjects)t.material.setParameters({renderOccluded:P.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(n(e)),getComputationForDimension:e=>n(e),getConstraintForDimension:e=>{const t=n(e);return t!=null?this._computeConstraint(t):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};u([f({constructOnly:!0})],G.prototype,"analysis",void 0),u([f({constructOnly:!0})],G.prototype,"analysisViewData",void 0),u([f({constructOnly:!0})],G.prototype,"manipulators",void 0),u([f({constructOnly:!0})],G.prototype,"parentTool",void 0),u([f({constructOnly:!0,nonNullable:!0})],G.prototype,"view",void 0),u([f({readOnly:!0})],G.prototype,"updating",null),u([f()],G.prototype,"firstGrabbedManipulator",null),u([f()],G.prototype,"hasGrabbedManipulators",null),u([f()],G.prototype,"snappingOptions",null),u([f()],G.prototype,"_stagedDimension",void 0),u([f()],G.prototype,"_activeComputation",null),u([f()],G.prototype,"_stagedComputation",null),G=u([H("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],G);const ns=g();var Ke;(function(n){n.Ready="ready",n.Creating="creating",n.Created="created"})(Ke||(Ke={}));let Z=class extends so{constructor(n){super(n),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=Bo,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Ha(this.view.state.viewingMode),this._intersector.options.store=Va.MIN,this._lengthDimensionSubTool=new G({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([se(this._lengthDimensionSubTool),jn(()=>this._clearPointerMoveTimeout()),S(()=>this.state,n=>{n===Ke.Created&&this.finishToolCreation()},N),Zn(()=>this.firstGrabbedManipulator,n=>{this.selectedDimension=n.metadata},N),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),N)])}get state(){return this.analysis.dimensions.some(n=>n.type==="length")?this._activeSubTool!=null?Ke.Creating:Ke.Created:Ke.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(n){this.analysisViewData.selectedDimension=n}onInputEvent(n){switch(n.type){case"immediate-click":this._clickHandler(n);break;case"immediate-double-click":this._doubleClickHandler(n);break;case"pointer-move":this._pointerMoveHandler(n);break;case"key-down":if(Zi.cancel===n.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void n.stopPropagation();this.active||(this.selectedDimension=null)}else Zi.delete.includes(n.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(n){if(this.hasFocusedManipulators)return void n.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(n);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:n.pointerType}),n.stopPropagation())}_doubleClickHandler(n){this.active&&(this.view.activeTool=null,n.stopPropagation())}_pointerMoveHandler(n){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(n);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:n.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(n){const e=Ia(n);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const t=this._intersector.results.min,i=b.get();return t.getIntersectionPoint(i)?this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=qn(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(n=>n.manipulator.state|=Oe),this._prevPointerMoveTimeout=Ga.setTimeout(()=>{this.manipulators.forEach(n=>n.manipulator.state&=~Oe)},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:n=>{this._pointerMoveTimerMs=n,this._resetPointerMoveTimeout()}}}};u([f({constructOnly:!0})],Z.prototype,"view",void 0),u([f({constructOnly:!0})],Z.prototype,"analysis",void 0),u([f({readOnly:!0})],Z.prototype,"state",null),u([f({readOnly:!0})],Z.prototype,"updating",null),u([f({readOnly:!0})],Z.prototype,"cursor",null),u([f({constructOnly:!0})],Z.prototype,"analysisViewData",void 0),u([f()],Z.prototype,"selectedDimension",null),u([f()],Z.prototype,"automaticManipulatorSelection",void 0),u([f()],Z.prototype,"_activeSubTool",void 0),u([f()],Z.prototype,"_lengthDimensionSubTool",void 0),Z=u([H("esri.views.3d.analysis.Dimension.DimensionTool")],Z);class Nc extends $s{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=P.OccludeAndTransparent,this._width=1,this._color=Xt(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=t,this._hasExternalMaterial=t!=null,this.applyProperties(e)}setGeometryFromSegment(e,t){const i=e.endRenderSpace;this.transform=ka(Fc,i),this._normal=t;const{points:s}=e.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=Rs(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material!=null&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new xs({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of Na(this.geometry,this.normal)){const i=Fa(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Fc=In();let jc=class{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new bs,this._messages=null,this._labelSegment=new We;const{analysis:t,computation:i,view:s,messages:r,isDecoration:a}=e;this.analysis=t,this.computation=i,this.view=s,this._messages=r;const l=e.visible,o={view:s,attached:l,isDecoration:a},{fontSize:c,textColor:d,textBackgroundColor:p}=t.style;this._visualElements=new Wc({marker:new Nc(o,e.markerMaterial),dimension:new Fe(o,e.dimensionLineMaterial),startOffset:new Fe(o,e.offsetLineMaterial),endOffset:new Fe(o,e.offsetLineMaterial),dimensionSmall:new Fe(o,e.smallDimensionLineMaterial),startOffsetSmall:new Fe(o,e.smallOffsetLineMaterial),endOffsetSmall:new Fe(o,e.smallOffsetLineMaterial),label:new Ka({view:s,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:pe(c),textColor:d.clone(),backgroundColor:p.clone(),isDecoration:a})}),this._handles.add([S(()=>i.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,t.style),i.geometry!=null&&this._updateLines(i.geometry)},{...rt,equals:An}),S(()=>i.length,h=>this._updateLabelContent(h),rt)])}destroy(){this.destroyed=!0,this._handles=Un(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=Li(qc,bt.Start,e.directSegment,e.dimensionSegment),i=Li(Uc,bt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(i),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(e,t,i){const s=this._visualElements;if(t==null){for(const y of s.values())y.visible=!1;return}const r=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,Zc)),a=Lo(t,r),l=a<(pe(i.lineSize)*Xo)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const c=pe(i.fontSize)*Wo,{label:d}=s;if(d.visible=a>=c**2,!d.visible)return;const{dimensionSegment:p,primaryOffsetAxis:h}=t,{offset:m}=this.computation.dimension,_=(Math.sign(m)>=0?1:-1)*this._labelOffsetPx(i)*r;Eo(this._labelSegment,p,h,_),d.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=pe(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;e!=null&&this._messages!=null?t.text=eo(this._messages,e,e.unit):t.text=""}_labelOffsetPx(e){return 1.5*pe(e.fontSize)+Zo+pe(e.lineSize/2)}};const qc=new We,Uc=new We,Zc=g();class Wc{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let xe=class extends J{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(n){super(n),this.loadingMessages=!1,this._messages=null}initialize(){const n=this.isDecoration;this._markerMaterial=new xs({width:1,anchor:ja.Tip,color:pt,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:P.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:n}),this._dimensionLineMaterial=new fe({width:1,color:pt,renderOccluded:P.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:n}),this._offsetLineMaterial=new fe({width:1,color:pt,renderOccluded:P.OccludeAndTransparent,stipplePattern:Yt(5),isDecoration:n}),this._smallDimensionLineMaterial=new fe({width:1,color:pt,renderOccluded:P.OccludeAndTransparent,isDecoration:n}),this._smallOffsetLineMaterial=new fe({width:1,color:pt,renderOccluded:P.OccludeAndTransparent,stipplePattern:Yt(5),isDecoration:n});for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(jn(()=>{this.view._stage?.remove(t)}));const e=an(()=>this.analysisViewData.computations,({computation:t})=>this._createVisualization(t));this._dimensionVisualizations=e,this.addHandles([se(e),S(()=>X.toUnitRGBA(this.analysis.style.color),t=>{for(const i of this._lineMaterials())i.setParameters({color:t})},N),S(()=>this.analysis.style.lineSize,t=>{const i=pe(t);this._markerMaterial.setParameters({width:i*Ns}),this._dimensionLineMaterial.setParameters({width:i,markerParameters:this._markerMaterial.parameters});const s=Math.max(i*Uo,1);this._offsetLineMaterial.setParameters({width:s})},N),S(()=>({camera:this.view.state.camera,style:Bc(this.analysis)}),({camera:t,style:i})=>{for(const{visualization:s}of this._dimensionVisualizations)s.updateCameraDependentElements(t,s.computation.geometry,i),s.updateLabelStyle(i)}),S(()=>this.visible,t=>{for(const{visualization:i}of this._dimensionVisualizations)i.visible=t})]),this.addHandles([qa(()=>this._updateMessageBundle()),Zn(()=>!this.loadingMessages,()=>{for(const{visualization:t}of this._dimensionVisualizations)t.updateUnitsMessages(this._messages)},wt)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map(({visualization:n})=>n),disablePartialOcclusion:()=>{for(const n of this._lineMaterials())n.setParameters({renderOccluded:P.Occlude})}}}_createVisualization(n){const e=new jc({analysis:this.analysis,computation:n,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Ua("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Bc(n){const{fontSize:e,lineSize:t,textColor:i,textBackgroundColor:s}=n.style;return{fontSize:e,lineSize:t,textBackgroundColor:s.clone(),textColor:i.clone()}}u([f({constructOnly:!0})],xe.prototype,"analysisViewData",void 0),u([f({constructOnly:!0,nonNullable:!0})],xe.prototype,"view",void 0),u([f({constructOnly:!0})],xe.prototype,"isDecoration",void 0),u([f()],xe.prototype,"analysis",null),u([f()],xe.prototype,"visible",null),u([f()],xe.prototype,"loadingMessages",void 0),xe=u([H("esri.views.3d.analysis.Dimension.DimensionVisualization")],xe);let mt=class extends J{constructor(n){super(n),this.dimension=null,this.length=null}};u([f({constructOnly:!0,nonNullable:!0})],mt.prototype,"dimension",void 0),u([f()],mt.prototype,"length",void 0),mt=u([H("esri.views.3d.analysis.LengthDimensionResult")],mt);const Yc=mt;let W=class extends J{constructor(n){super(n),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(n){const{dimension:e,...t}=n;return{result:new Yc({dimension:e}),...t}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,n=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(n),N),S(()=>this.dimension.endPoint,n=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(n),N)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};u([f({constructOnly:!0,nonNullable:!0})],W.prototype,"result",void 0),u([f({constructOnly:!0,nonNullable:!0})],W.prototype,"projectAndAlignPoint",void 0),u([f()],W.prototype,"dimension",null),u([f()],W.prototype,"length",null),u([f()],W.prototype,"geometry",void 0),u([f()],W.prototype,"unconstrainedGeometry",void 0),u([f()],W.prototype,"elevationAlignedStartPoint",void 0),u([f()],W.prototype,"elevationAlignedEndPoint",void 0),u([f()],W.prototype,"preConstraintProperties",void 0),u([f()],W.prototype,"previousConstraint",void 0),W=u([H("esri.views.3d.analysis.LengthDimensionComputation")],W);const Xc=n=>{let e=class extends n{constructor(...t){super(...t),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Mt}createLengthDimensions(t){throw new Error("Method not implemented.")}};return u([f({constructOnly:!0})],e.prototype,"view",void 0),u([f({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),u([f()],e.prototype,"tool",void 0),u([f({readOnly:!0})],e.prototype,"results",null),u([f()],e.prototype,"selectedDimension",void 0),u([f()],e.prototype,"interactive",void 0),u([f()],e.prototype,"visible",void 0),e=u([H("esri.views.analysis.DimensionAnalysisView")],e),e};let j=class extends Xc(Za(J)){constructor(n){super(n),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:t,elevationProvider:i}=this.view,s=Wa(e,t,i);return s==null&&Ba(this.analysis,e.spatialReference,Gn.getLogger(this)),s};const n=an(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=n,this.addHandles([ro(this,Z),se(n)]),this._analysisVisualization=new xe({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new je({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Pt(this._placementTask),this._analysisVisualization=Un(this._analysisVisualization),ao(this)}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map(n=>this._dimensionsToComputations.get(n).result)}get selectedComputation(){const{selectedDimension:n}=this;return n==null?null:this._dimensionsToComputations.get(n)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(n){return this.selectedDimension=null,this._placementTask=Pt(this._placementTask),this._placementTask=oo(this,n),this._placementTask.promise}_createComputation(n){const{_dimensionsToComputations:e}=this,t=new W({dimension:n,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(n,t),{computation:t,remove:()=>this._removeComputation(t)}}_removeComputation(n){const{dimension:e}=n;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),n.destroy()}};u([f({readOnly:!0})],j.prototype,"type",void 0),u([f()],j.prototype,"tool",void 0),u([f()],j.prototype,"updating",null),u([f({readOnly:!0})],j.prototype,"results",null),u([f()],j.prototype,"computations",void 0),u([f()],j.prototype,"selectedDimension",void 0),u([f()],j.prototype,"selectedComputation",null),u([f()],j.prototype,"_analysisVisualization",void 0),u([f()],j.prototype,"_analysisController",void 0),u([f()],j.prototype,"_dimensionsToComputations",void 0),u([f()],j.prototype,"_placementTask",void 0),j=u([H("esri.views.3d.analysis.DimensionAnalysisView3D")],j);const Qc=j,Yd=Object.freeze(Object.defineProperty({__proto__:null,default:Qc},Symbol.toStringTag,{value:"Module"}));export{Yd as D,wd as E,Rl as R,mc as a,ct as b,Ve as c,Al as d,yd as i,Pd as j,ei as m,fi as n,fc as r,yl as t};
