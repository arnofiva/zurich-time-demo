import{hN as B,dV as L,ce as j,hO as A,hP as C,c9 as Y,bQ as _,bd as Z,bV as Q}from"./index-8b5e7d9b.js";import{y as R,m as H}from"./heatmapUtils-3c0e0ece.js";import{Z as J}from"./utils-e24aed40.js";import{a as K,d as W}from"./generateRendererUtils-1c8bce12.js";const X="<Null>",tt="equal-interval",et=1,nt=5,lt=10,at=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,it=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),ot=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),rt=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function V(t){return t==null||typeof t=="string"&&!t?X:t}function st(t){const e=t.normalizationField!=null||t.normalizationType!=null,n=t.minValue!=null||t.maxValue!=null,l=!!t.sqlExpression&&t.supportsSQLExpression;return!e&&!n&&!l}function Et(t){const e=t.returnDistinct?[...new Set(t.values)]:t.values,n=e.filter(i=>i!=null).sort(),l=n.length,a={count:l,min:n[0],max:n[l-1]};return t.supportsNullCount&&(a.nullcount=e.length-l),t.percentileParams&&(a.median=P(e,t.percentileParams)),a}function ut(t){const{values:e,useSampleStdDev:n,supportsNullCount:l}=t;let a=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o=null,r=null,s=null,c=null,u=0;const p=t.minValue==null?-1/0:t.minValue,m=t.maxValue==null?1/0:t.maxValue;for(const f of e)Number.isFinite(f)?f>=p&&f<=m&&(o=o===null?f:o+f,a=Math.min(a,f),i=Math.max(i,f),u++):typeof f=="string"&&u++;if(u&&o!=null){r=o/u;let f=0;for(const v of e)Number.isFinite(v)&&v>=p&&v<=m&&(f+=(v-r)**2);c=n?u>1?f/(u-1):0:u>0?f/u:0,s=Math.sqrt(c)}else a=null,i=null;const h={avg:r,count:u,max:i,min:a,stddev:s,sum:o,variance:c};return l&&(h.nullcount=e.length-u),t.percentileParams&&(h.median=P(e,t.percentileParams)),h}function P(t,e){const{fieldType:n,value:l,orderBy:a,isDiscrete:i}=e,o=mt(n,a==="desc");if((t=[...t].filter(h=>h!=null).sort((h,f)=>o(h,f))).length===0)return null;if(l<=0)return t[0];if(l>=1)return t[t.length-1];const r=(t.length-1)*l,s=Math.floor(r),c=s+1,u=r%1,p=t[s],m=t[c];return c>=t.length||i||typeof p=="string"||typeof m=="string"?p:p*(1-u)+m*u}function mt(t,e){if(t){if(it.has(t))return O(e);if(ot.has(t))return E(e,!1);if(t==="esriFieldTypeTimestampOffset")return pt(e);const i=E(e,!0);if(t==="esriFieldTypeString")return i;if(t==="esriFieldTypeGUID"||t==="esriFieldTypeGlobalID")return(o,r)=>i(G(o),G(r))}const n=e?1:-1,l=O(e),a=E(e,!0);return(i,o)=>typeof i=="number"&&typeof o=="number"?l(i,o):typeof i=="string"&&typeof o=="string"?a(i,o):n}const M=(t,e)=>t==null?e==null?0:1:e==null?-1:null,w=(t,e)=>t==null?e==null?0:-1:e==null?1:null;function ct(t){return t?M:w}const ft=(t,e)=>w(t,e)??(t===e?0:new Date(t).getTime()-new Date(e).getTime()),dt=(t,e)=>M(t,e)??(t===e?0:new Date(e).getTime()-new Date(t).getTime());function pt(t){return t?dt:ft}const ht=(t,e)=>w(t,e)??(t===e?0:t<e?-1:1),vt=(t,e)=>M(t,e)??(t===e?0:t<e?1:-1);function E(t,e){if(!e)return t?vt:ht;const n=ct(t);return t?(l,a)=>{const i=n(l,a);return i??((l=l.toUpperCase())>(a=a.toUpperCase())?-1:l<a?1:0)}:(l,a)=>{const i=n(l,a);return i??((l=l.toUpperCase())<(a=a.toUpperCase())?-1:l>a?1:0)}}const yt=(t,e)=>M(t,e)??e-t,bt=(t,e)=>w(t,e)??t-e;function O(t){return t?yt:bt}function G(t){return t.substr(24,12)+t.substr(19,4)+t.substr(16,2)+t.substr(14,2)+t.substr(11,2)+t.substr(9,2)+t.substr(6,2)+t.substr(4,2)+t.substr(2,2)+t.substr(0,2)}function kt(t,e){let n;for(n in t)rt.includes(n)&&(Number.isFinite(t[n])||(t[n]=null));return e&&["avg","stddev","variance"].forEach(l=>{t[l]!=null&&(t[l]=Math.ceil(t[l]??0))}),t}function Ot(t){const e={};for(let n of t)(n==null||typeof n=="string"&&n.trim()==="")&&(n=null),e[n]==null?e[n]={count:1,data:n}:e[n].count++;return{count:e}}function k(t){return t?.type!=="coded-value"?[]:t.codedValues.map(e=>e.code)}function Gt(t,e,n,l){const a=t.count,i=[];if(n&&e){const o=[],r=k(e[0]);for(const s of r)if(e[1]){const c=k(e[1]);for(const u of c)if(e[2]){const p=k(e[2]);for(const m of p)o.push(`${V(s)}${l}${V(u)}${l}${V(m)}`)}else o.push(`${V(s)}${l}${V(u)}`)}else o.push(s);for(const s of o)a.hasOwnProperty(s)||(a[s]={data:s,count:0})}for(const o in a){const r=a[o];i.push({value:r.data,count:r.count,label:r.label})}return{uniqueValueInfos:i}}function gt(t,e,n,l){let a=null;switch(e){case"log":t!==0&&(a=Math.log(t)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(l)&&l!==0&&(a=t/l*100);break;case"field":Number.isFinite(n)&&n!==0&&(a=t/n);break;case"natural-log":t>0&&(a=Math.log(t));break;case"square-root":t>0&&(a=t**.5)}return a}function Tt(t,e){const n=Vt({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||nt});return t=xt(t,e.minValue,e.maxValue),K({definition:n,values:t,normalizationTotal:e.normalizationTotal})}function xt(t,e,n){const l=e??-1/0,a=n??1/0;return t.filter(i=>Number.isFinite(i)&&i>=l&&i<=a)}function Vt(t){const{breakCount:e,field:n,normalizationField:l,normalizationType:a}=t,i=t.classificationMethod||tt,o=i==="standard-deviation"?t.standardDeviationInterval||et:void 0;return new W({breakCount:e,classificationField:n,classificationMethod:i,normalizationField:a==="field"?l:void 0,normalizationType:a,standardDeviationInterval:o})}function Pt(t,e){let n=t.classBreaks;const l=n.length,a=n[0]?.minValue,i=n[l-1]?.maxValue,o=e==="standard-deviation",r=at;return n=n.map(s=>{const c=s.label,u={minValue:s.minValue,maxValue:s.maxValue,label:c};if(o&&c){const p=c.match(r),m=p?.map(h=>+h.trim())??[];m.length===2?(u.minStdDev=m[0],u.maxStdDev=m[1],m[0]<0&&m[1]>0&&(u.hasAvg=!0)):m.length===1&&(c.includes("<")?(u.minStdDev=null,u.maxStdDev=m[0]):c.includes(">")&&(u.minStdDev=m[0],u.maxStdDev=null))}return u}),{minValue:a,maxValue:i,classBreakInfos:n,normalizationTotal:t.normalizationTotal}}function qt(t,e){const n=Ft(t,e);if(n.min==null&&n.max==null)return{bins:[],minValue:n.min,maxValue:n.max,normalizationTotal:e.normalizationTotal};const l=n.intervals,a=n.min??0,i=n.max??0,o=l.map((r,s)=>({minValue:l[s][0],maxValue:l[s][1],count:0}));for(const r of t)if(r!=null&&r>=a&&r<=i){const s=$t(l,r);s>-1&&o[s].count++}return{bins:o,minValue:a,maxValue:i,normalizationTotal:e.normalizationTotal}}function Ft(t,e){const{field:n,classificationMethod:l,standardDeviationInterval:a,normalizationType:i,normalizationField:o,normalizationTotal:r,minValue:s,maxValue:c}=e,u=e.numBins||lt;let p=null,m=null,h=null;if((!l||l==="equal-interval")&&!i){if(s!=null&&c!=null)p=s,m=c;else{const f=ut({values:t,minValue:s,maxValue:c,useSampleStdDev:!i,supportsNullCount:st({normalizationType:i,normalizationField:o,minValue:s,maxValue:c})});p=f.min??null,m=f.max??null}h=It(p??0,m??0,u)}else{const{classBreaks:f}=Tt(t,{field:n,normalizationType:i,normalizationField:o,normalizationTotal:r,classificationMethod:l,standardDeviationInterval:a,minValue:s,maxValue:c,numClasses:u});p=f[0].minValue,m=f[f.length-1].maxValue,h=f.map(v=>[v.minValue,v.maxValue])}return{min:p,max:m,intervals:h}}function $t(t,e){let n=-1;for(let l=t.length-1;l>=0;l--)if(e>=t[l][0]){n=l;break}return n}function It(t,e,n){const l=(e-t)/n,a=[];let i,o=t;for(let r=1;r<=n;r++)i=o+l,i=Number(i.toFixed(16)),a.push([o,r===n?e:i]),o=i;return a}let x=null;const Nt=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function zt(t,e,n){return t.x<0?t.x+=e:t.x>n&&(t.x-=e),t}function Ut(t,e,n,l){const a=B(n)?L(n):null,i=a?Math.round((a.valid[1]-a.valid[0])/e.scale[0]):null;return t.map(o=>{const r=new j(o.geometry);return A(e,r,r,r.hasZ,r.hasM),o.geometry=a?zt(r,i??0,l[0]):r,o})}function Bt(t,e=18,n,l,a,i){const o=new Float64Array(a*i);e=Math.round(Q(e));let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,c=0,u=0,p=0,m=0;const h=R(l,n);for(const{geometry:v,attributes:$}of t){const{x:b,y:F}=v,I=Math.max(0,b-e),N=Math.max(0,F-e),z=Math.min(i,F+e),y=Math.min(a,b+e),g=+h($);for(let d=N;d<z;d++)for(let T=I;T<y;T++){const D=d*a+T,q=H(T-b,d-F,e),U=o[D];c=o[D]+=q*g;const S=c-U;u+=S,p+=S*S,c<r&&(r=c),c>s&&(s=c),m++}}if(!m)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};const f=(s-r)/2;return{mean:u/m,stdDev:Math.sqrt((p-u*u/m)/m),min:r,max:s,mid:f,count:m}}function Dt(t){const e=Nt.exec(t);if(!e)return null;const{hh:n,mm:l,ss:a,ms:i}=e.groups;return Number(n)*C.hours+Number(l)*C.minutes+Number(a)*C.seconds+Number(i||0)}async function Lt(t,e,n=!0){if(!e)return[];const{field:l,field2:a,field3:i,fieldDelimiter:o,fieldInfos:r,timeZone:s}=t,c=l&&r?.find(y=>y.name.toLowerCase()===l.toLowerCase()),u=!!c&&Y(c),p=!!c&&J(c),m=t.valueExpression,h=t.normalizationType,f=t.normalizationField,v=t.normalizationTotal,$=[],b=t.viewInfoParams;let F=null,I=null;if(m){if(!x){const{arcadeUtils:y}=await _();x=y}x.hasGeometryOperations(m)&&await x.enableGeometryOperations(),F=x.createFunction(m),I=b?x.getViewInfo({viewingMode:b.viewingMode,scale:b.scale,spatialReference:new Z(b.spatialReference)}):null}const N=t.fieldInfos,z=!(e[0]&&"declaredClass"in e[0]&&e[0].declaredClass==="esri.Graphic")&&N?{fields:N}:null;return e.forEach(y=>{const g=y.attributes;let d;if(m){const T=z?{...y,layer:z}:y,D=x.createExecContext(T,I,s);d=x.executeFunction(F,D)}else g&&(d=g[l],a?(d=`${V(d)}${o}${V(g[a])}`,i&&(d=`${d}${o}${V(g[i])}`)):typeof d=="string"&&n&&(p?d=d?new Date(d).getTime():null:u&&(d=d?Dt(d):null)));if(h&&typeof d=="number"&&isFinite(d)){const T=g&&parseFloat(g[f]);d=gt(d,h,T,v)}$.push(d)}),$}export{Gt as $,gt as B,kt as C,Tt as E,Pt as P,mt as T,qt as U,Lt as b,V as c,Et as d,st as f,Ut as j,Ot as k,ut as p,P as v,Dt as w,Bt as x};
