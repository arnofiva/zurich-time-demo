import{av as d,eS as F,eT as D,dV as k,dZ as x}from"./index-5b8adf8e.js";import{r as G}from"./fetchService-096ab2cf.js";import{a as P,n as T,s as j,i as E,l as S,t as g,r as C,e as $}from"./portalLayers-54615c8a.js";import{populateGroupLayer as O}from"./layersCreator-20715c97.js";import{a as R}from"./associatedFeatureServiceUtils-66626d5a.js";import{e as J,l as N}from"./jsonContext-2b28d6d2.js";import{t as V}from"./requestPresets-c67896ae.js";async function oe(e,a){const r=e.instance.portalItem;if(r?.id)return await r.load(a),Z(e),q(e,a)}function Z(e){const a=e.instance.portalItem;if(!a?.type||!e.supportedTypes.includes(a.type))throw new d("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:e.supportedTypes.join(", ")})}async function q(e,a){const r=e.instance,t=r.portalItem;if(!t)return;const{url:o,title:s}=t,n=J(t);if(r.type==="group")return z(r,n,e);o&&r.read({url:o},n);const l=new $,i=await L(e,l,a);return i&&r.read(i,n),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),F(r,n)}async function z(e,a,r){const t=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:o,type:s}=t;if(s==="Group Layer"){if(!D(t,"Map"))throw new d("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return A(e)}return e.read({title:o},a),B(e,r)}async function A(e){const a=e.portalItem,r=await a.fetchData("json");if(!r)return;const t=N(a);e.read(r,t),await O(e,r,{context:t}),e.resourceReferences={portalItem:a,paths:t.readResourcePaths??[]}}async function B(e,a){let r;const{portalItem:t}=e;if(!t)return;const o=t.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new d("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}const n=new $;let[l,i]=await Promise.all([r(),L(a,n)]),u=()=>l;if(o==="Feature Service"){i=t.url?await P(i,t.url,n):{};const m=T(i),h=j(i),p=[];if(m.length||h?.length){m.length&&p.push("SubtypeGroupLayer"),h?.length&&p.push("OrientedImageryLayer");const w=[];for(const c of p){const y=s[c];w.push(y())}const M=await Promise.all(w),b=new Map;p.forEach((c,y)=>{b.set(c,M[y])}),u=c=>c.layerType?b.get(c.layerType)??l:l}const v=await X(t.url);return await f(e,u,i,v)}return o==="Scene Service"&&t.url&&(i=await E(t,i,n)),S(i)>0?await f(e,u,i):await H(e,u)}async function H(e,a){const{portalItem:r}=e;if(!r?.url)return;const t=await V(r.url);t&&f(e,a,{layers:t.layers?.map(g),tables:t.tables?.map(g)})}async function f(e,a,r,t){let o=r.layers||[];const s=r.tables||[];if(e.portalItem?.type==="Feature Collection"?(o.forEach((n,l)=>{n.id=l,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{const l=t?.(n);if(l||!t){const i=I(e,a(n),r,n,l);e.add(i)}}),s.length){const n=await R.FeatureLayer();s.forEach(l=>{const i=t?.(l);if(i||!t){const u=I(e,n,r,l,i);e.tables.add(u)}})}}function I(e,a,r,t,o){const s=e.portalItem,n={portalItem:s.clone(),layerId:t.id};t.url!=null&&(n.url=t.url);const l=new a(n);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&(l.sublayerTitleMode="service-name"),s.type==="Feature Collection"){const i={origin:"portal-item",portal:s.portal||k.getDefault()};l.read(t,i);const u=r.showLegend;u!=null&&l.read({showLegend:u},i)}return l}async function L(e,a,r){if(e.supportsData===!1)return;const t=e.instance,o=t.portalItem;if(!o)return;let s=null;try{s=await o.fetchData("json",r)}catch{}if(U(t)){let n=null;const l=await K(o,s,a);if((s?.layers||s?.tables)&&l>0){if(t.layerId==null){const i=T(s);t.layerId=t.type==="subtype-group"?i?.[0]:C(s)}n=Q(s,t),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return l>1&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),n}return s}async function K(e,a,r){if(a?.layers&&a?.tables)return S(a);const t=x(e.url);if(!t)return 1;const o=await r.fetchServiceMetadata(t.url.path).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)}function Q(e,a){const{layerId:r}=a,t=e.layers?.find(o=>o.id===r)||e.tables?.find(o=>o.id===r);return t&&W(t,a)?t:null}function U(e){return e.type!=="stream"&&"layerId"in e}function W(e,a){return!(a.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||a.type==="subtype-group"&&!("layerType"in e))}async function X(e){const{layersJSON:a}=await G(e);if(!a)return null;const r=[...a.layers,...a.tables];return t=>r.find(o=>o.id===t.id)}export{oe as load};
